<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
<title>RoomSync Painel Administrativo</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="./dashboard.css">

<style>




</style>
</head>

<body>

<header>
  <div class="logo">
    <img src="./img/logo.png" alt="RoomSync ãƒ­ã‚´">
    <!-- <div>RoomSync</div> -->
  </div>
  <div class="menu-btn" onclick="toggleMenu()">
    <i class="fas fa-bars"></i>
  </div>
</header>

<!-- SIDE MENU -->
<div class="side-menu" id="sideMenu">
  <h3>Menu</h3>

<div class="menu-item" onclick="openUserAdmin()">Gerenciar UsuÃ¡rios</div>
  <div class="menu-item" onclick="goLogs()">HistÃ³rico</div>
  <!-- <div class="menu-item" onclick="goAmenity()">Pedidos de Amenidades</div>
  <div class="menu-item" onclick="goRooms()">Mapa dos Quartos</div>
  <div class="menu-item" onclick="goExcel()">Exportar Excel</div> -->

  <div class="menu-item" onclick="logout()">Sair</div>
</div>

<div class="floor-buttons" id="floorButtons"></div>
<div class="dashboard">

  <div class="dash-card red">
    <h1 id="card_before">--</h1>
    <p>Para limpar</p>
  </div>

  <div class="dash-card blue">
    <h1 id="card_progress">--</h1>
    <p>Abertos</p>
  </div>

  <div class="dash-card green">
    <h1 id="card_done">--</h1>
    <p>Finalizados</p>
  </div>

  <div class="dash-card yellow">
    <h1 id="card_checked">--</h1>
    <p>Conferidos</p>
  </div>

  <div class="dash-card yellow">
    <h1 id="card_amenity">--</h1>
    <p>Amenity</p>
  </div>

  <div class="dash-card orange">
  <h1 id="card_observation">0</h1>
  <p>ObservaÃ§Ã£o</p>
</div>


<div class="dash-card purple" onclick="openTomorrowModal()">
  <h1 id="card_tomorrow">--</h1>
  <p>Para limpar AmanhÃ£</p>
</div>


</div>

<!-- <h3 style="padding:16px 16px 0;">Por Andar</h3> -->




<div id="floorModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span id="modalFloorName">Andar</span>
      <button class="close-btn" onclick="closeFloorModal()">âœ•</button>
    </div>

    <div id="modalRoomList" class="modal-body">
      <!-- éƒ¨å±‹ä¸€è¦§ã‚’ã“ã“ã«è¡¨ç¤º -->
    </div>
  </div>
</div>



<!-- USER ADMIN MODAL -->
<div id="userAdminModal" class="modal">
  <div class="modal-box">

    <div class="modal-header">
      <span>Gerenciar UsuÃ¡rios</span>
      <button class="close-btn" onclick="closeUserAdmin()">âœ•</button>
    </div>

    <div class="modal-content">

      <button class="admin-btn" onclick="showUserForm('create')">Cadastrar UsuÃ¡rio</button>
      <button class="admin-btn" onclick="openEditUserModal()">Alterar UsuÃ¡rio</button>
      <button class="admin-btn" onclick="openDeleteUserModal()">Excluir UsuÃ¡rio</button>

      <div id="userFormArea" class="user-form-area"></div>

    </div>
  </div>
</div>

<div id="toast" class="toast"></div>


<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="spinner"></div>
  <p>å‡¦ç†ä¸­ã§ã™â€¦</p>
</div>

<!-- USER LIST MODAL -->
<div id="userSelectModal" class="modal">
  <div class="modal-content user-modal">
    <div class="modal-header">
      <h3>Selecionar UsuÃ¡rio</h3>
      <button class="close-btn" onclick="closeUserSelect()">âœ•</button>
    </div>

    <div id="userListBox" class="user-list-box"></div>
  </div>
</div>

<!-- TOMORROW CLEAN MODAL -->
<div id="tomorrowModal" class="modal">
  <div class="modal-box floor-summary-box">
    <div class="modal-header">
      <span>Limpeza AmanhÃ£ â€” Por Andar</span>
      <button class="close-btn" onclick="closeTomorrowModal()">âœ•</button>
    </div>

    <div id="tomorrowFloorList" class="modal-body floor-summary-body">
      <!-- JS ã«ã¦æŒ¿å…¥ -->
    </div>
  </div>
</div>





<script>

  const API_URL = "https://squid-app-ug7x6.ondigitalocean.app"
  const globalId = 1
  let globalRoomData = []


function toggleMenu() {
  document.getElementById("sideMenu").classList.toggle("open");
}

function logout() {
  localStorage.removeItem("authToken");
  alert("Logout efetuado.");
}

function goUsers() { window.location.href = "./user_admin.html"; }
function goLogs() { window.location.href = "/system_logs.html"; }
function goAmenity() { window.location.href = "/amenity_list.html"; }
function goRooms() { window.location.href = "/rooms_map.html"; }
function goExcel() { window.location.href = "/excel_upload.html"; }

/* Safe load (without login redirect) */
async function loadDashboard() {
  const token = localStorage.getItem("authToken");
  // if (!token) return;

  try {
    showLoading()
    const res = await fetch(`${API_URL}/api/room/status?hotel_id=${globalId}`);

    // hideLoading();
    if (!res.ok) throw new Error("APIå–å¾—å¤±æ•—");

    const data = await res.json();
    const roomData = data.rooms || [];
    globalRoomData = data.rooms || [];

    const beforeCleanning =  roomData.filter(r =>
      r.clean_flag === 'æœªæ¸…æƒ' &&
      r.status!=='stay_noclean' &&
     r.status!=='stay_amenytyOnliy');
    const inProgressRooms = roomData.filter(r => r.cleaning_status === 'in_progress' && r.checkout_status === 'after');
    const doneRooms = roomData.filter(r => r.cleaning_status === 'done' && r.checkout_status === 'after');
    const checked = roomData.filter(r => r.cleaning_status === 'checked' && r.checkout_status === 'after');
    const notes = roomData.filter(r => r.notes !== '' && r.notes !== null);

      const API_AMENITIES = await fetch(`${API_URL}/api/room/amenity/list`);
      const amenityJson = await API_AMENITIES.json();

console.log(notes)
console.log(amenityJson.requests.length)
      const amenityRoms = amenityJson.requests.length

      console.log('amenityRoms',amenityRoms)
      console.log(amenityJson)

    const tomorowCleanNeedRooms = roomData.filter(r => r.guest_count >0);


    console.log(beforeCleanning )
    console.log(inProgressRooms)
    console.log(doneRooms)
    console.log(checked)

    // === DASHBOARD æ•°å€¤æ›´æ–° ===
    document.getElementById("card_before").innerText = beforeCleanning.length;
    document.getElementById("card_progress").innerText = inProgressRooms.length;
    document.getElementById("card_done").innerText = doneRooms.length;
    document.getElementById("card_checked").innerText = checked.length;
    document.getElementById("card_tomorrow").innerText = tomorowCleanNeedRooms.length;
    document.getElementById("card_amenity").innerText = amenityRoms
    document.getElementById('card_observation').innerText = notes.length


    // const
    // console.log(data)
    // const grouped = groupByFloor(rooms);
    // console.log(grouped)
    // const res = await fetch("/api/room/summary", {
    //   headers: { Authorization: token }
    // });
    // const json = await res.json();
    //
    // document.getElementById("plannedCount").innerText = json.planned ?? "--";
    // document.getElementById("beforeCheck").innerText = json.beforeCheck ?? "--";
    // document.getElementById("afterCheck").innerText = json.afterCheck ?? "--";
   hideLoading()
  } catch (err) {
     hideLoading()
    console.log("Erro:", err);
  }
}

function closeMenu() {
  document.getElementById("sideMenu").classList.remove("open");
}
// ç”»é¢ã©ã“ã‹ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã®å ´åˆï¼‰
document.addEventListener("click", function (e) {
  const menu = document.getElementById("sideMenu");
  const button = document.querySelector(".menu-btn");

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã„ã¦ã„ã¦ã€ã‚¯ãƒªãƒƒã‚¯å¯¾è±¡ãŒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã‚‚ãƒœã‚¿ãƒ³ã§ã‚‚ãªã„å ´åˆã¯é–‰ã˜ã‚‹
  if (menu.classList.contains("open") &&
      !menu.contains(e.target) &&
      !button.contains(e.target)) {
    closeMenu();
  }
});

function openFloorModal(floor) {
  document.getElementById("modalFloorName").innerText = floor;

  // å–å¾—æ¸ˆã¿ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç‰¹å®šéšã®éƒ¨å±‹ã‚’æŠ½å‡º
  const rooms = globalRoomData.filter(r => `${r.floor}F` === floor);

  const box = document.getElementById("modalRoomList");
  box.innerHTML = "";

  if (rooms.length === 0) {
    box.innerHTML = "<p>Nenhum quarto encontrado.</p>";
  } else {
    rooms.forEach(r => {
      box.innerHTML += `
        <div class="room-item">
          <strong>${r.room_number}</strong> â€” ${r.clean_flag}
        </div>
      `;
    });
  }

  document.getElementById("floorModal").style.display = "flex";
}

function closeFloorModal() {
  document.getElementById("floorModal").style.display = "none";
}

function renderFloorButtons() {
  const box = document.getElementById("floorButtons");
  box.innerHTML = "";

  // ğŸ”µ ã¾ãšã€Œå…¨ãƒ«ãƒ¼ãƒ ã€ãƒœã‚¿ãƒ³
  const allBtn = document.createElement("button");
  allBtn.innerText = "Todos";
  allBtn.classList.add("floor-active");   // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
  allBtn.onclick = () => selectFloor("ALL", allBtn);
  box.appendChild(allBtn);

  // ğŸ”µ 4Fã€œ12F ãƒœã‚¿ãƒ³
  for (let i = 4; i <= 12; i++) {
    const btn = document.createElement("button");
    btn.innerText = `${i}F`;
    btn.onclick = () => selectFloor(`${i}F`, btn);
    box.appendChild(btn);
  }
}

function selectFloor(floor, clickedButton) {
  // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
  document.querySelectorAll(".floor-buttons button").forEach(btn =>
    btn.classList.remove("floor-active")
  );
  clickedButton.classList.add("floor-active");

  // ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
  let targetRooms = [];

  if (floor === "ALL") {
    targetRooms = globalRoomData;
  } else {
    targetRooms = globalRoomData.filter(r => `${r.floor}F` === floor);
  }

  // å„ç¨®é›†è¨ˆ
  const beforeCleanning = targetRooms.filter(r =>
    r.clean_flag === 'æœªæ¸…æƒ' &&
    r.status !== 'stay_noclean' &&
    r.status !== 'stay_amenytyOnliy'
  );

  const inProgressRooms = targetRooms.filter(
    r => r.cleaning_status === 'in_progress' && r.checkout_status === 'after'
  );

  const doneRooms = targetRooms.filter(
    r => r.cleaning_status === 'done' && r.checkout_status === 'after'
  );

  const checked = targetRooms.filter(
    r => r.cleaning_status === 'checked' && r.checkout_status === 'after'
  );

  const notes = targetRooms.filter(r => r.notes !== '' && r.notes !== null);

  const tomorrowRooms = targetRooms.filter(r => r.guest_count > 0);

  // Amenity API ã¯å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†ã®ã§ã“ã“ã¯å…¨ä»¶ï¼ˆå¿…è¦ã‚ã‚Œã°éšãƒ•ã‚£ãƒ«ã‚¿ç‰ˆã‚‚ä½œã‚‹ï¼‰

  console.log(notes)
  const amenityCount = notes.length;

  // ã‚«ãƒ¼ãƒ‰æ›´æ–°
  document.getElementById("card_before").innerText = beforeCleanning.length;
  document.getElementById("card_progress").innerText = inProgressRooms.length;
  document.getElementById("card_done").innerText = doneRooms.length;
  document.getElementById("card_checked").innerText = checked.length;
  document.getElementById("card_amenity").innerText = amenityCount;
  document.getElementById("card_tomorrow").innerText = tomorrowRooms.length;
}


function openUserAdmin() {
  document.getElementById("userAdminModal").style.display = "flex";
}

function closeUserAdmin() {
  document.getElementById("userAdminModal").style.display = "none";
  document.getElementById("userFormArea").innerHTML = "";
}

function showUserForm(type) {
  let area = document.getElementById("userFormArea");
  area.innerHTML = ""; // reset

  if (type === "create") {
    area.innerHTML = `
      <h3>Novo UsuÃ¡rio</h3>
      <input placeholder="Username" id="u_username">
      <input placeholder="Nome" id="u_name">
      <input placeholder="Senha" type="password" id="u_password">
      <select id="u_role">
        <option value="staff">operador</option>
        <option value="staff">operador2</option>
        <option value="inspector">conferente</option>
        <option value="admin">Administrador</option>
      </select>
      <select id="u_contract">
        <option value="baito">Baito (Part-time)</option>
        <option value="fulltime">Full-time</option>
      </select>

      <select id="u_language">
        <option value="pt">PortuguÃªs</option>
        <option value="jp">æ—¥æœ¬èª</option>
        <option value="en">English</option>
      </select>

      <button onclick="submitCreateUser()">Salvar</button>
    `;
  }

  if (type === "edit") {
    area.innerHTML = `
      <h3>Alterar UsuÃ¡rio</h3>
      <input placeholder="Username para alterar" id="e_username">
      <input placeholder="Novo nome" id="e_name">
      <input placeholder="Nova senha (opcional)" id="e_password">
      <select id="e_role">
        <option value="staff">Staff</option>
        <option value="inspector">Inspector</option>
        <option value="admin">Admin</option>
      </select>
      <select id="e_contract">
  <option value="baito">Baito (Part-time)</option>
  <option value="fulltime">Full-time</option>
</select>

<select id="e_language">
  <option value="pt">PortuguÃªs</option>
  <option value="jp">æ—¥æœ¬èª</option>
  <option value="en">English</option>
</select>

      <button onclick="submitEditUser()">Salvar AlteraÃ§Ãµes</button>
    `;
  }

  if (type === "delete") {
    area.innerHTML = `
      <h3>Excluir UsuÃ¡rio</h3>
      <input placeholder="Username para excluir" id="d_username">
      <button onclick="submitDeleteUser()" style="background:#c62828">Excluir</button>
    `;
  }
}

async function submitCreateUser() {
  const payload = {
    username: document.getElementById("u_username").value,
    password: document.getElementById("u_password").value,
    name: document.getElementById("u_name").value,
    role: document.getElementById("u_role").value,
    hotel_id: 1,
    contract_type: document.getElementById("u_contract").value,
    language: document.getElementById("u_language").value
  };
showLoading()
  const res = await fetch(`${API_URL}/api/user/create`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  hideLoading()

  if (!json.success) {
    showToast(json.error || "Falha ao criar usuÃ¡rio", true);
    return;
  }

  // ğŸ”¥ ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥é€šçŸ¥
  showToast("UsuÃ¡rio criado com sucesso!");

  // ğŸ”¥ å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
  clearInputs(["u_username", "u_password", "u_name"]);

  // role / contract_type / language ã‚’åˆæœŸå€¤ã«æˆ»ã™
  document.getElementById("u_role").value = "staff";
  document.getElementById("u_contract").value = "baito";
  document.getElementById("u_language").value = "pt";
}


async function submitEditUser() {
  const payload = {
    username: document.getElementById("e_username").value,
    newName: document.getElementById("e_name").value,
    newPassword: document.getElementById("e_password").value,
    newRole: document.getElementById("e_role").value,
    newContract: document.getElementById("e_contract").value,
    newLanguage: document.getElementById("e_language").value
  };
showLoading()
  const res = await fetch(`${API_URL}/api/user/update`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const json = await res.json();
hideLoading()
  if (!json.success) {
    showToast(json.error || "Falha ao atualizar usuÃ¡rio", true);
    return;
  }

  showToast("UsuÃ¡rio atualizado!");

  clearInputs(["e_username", "e_name", "e_password"]);
}

async function submitDeleteUser() {
  const username = document.getElementById("d_username").value;
showLoading()
  const res = await fetch(`${API_URL}/api/user/delete`, {
    method: "DELETE",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username })
  });

  const json = await res.json();
hideLoading()
  if (!json.success) {
    showToast(json.error || "Falha ao excluir usuÃ¡rio", true);
    return;
  }

  showToast("UsuÃ¡rio excluÃ­do.");
  clearInputs(["d_username"]);
}

function showToast(message, isError = false) {
  const t = document.getElementById("toast");
  t.innerText = message;

  t.classList.add("show");
  if (isError) t.classList.add("error");
  else t.classList.remove("error");

  setTimeout(() => {
    t.classList.remove("show");
  }, 2500);
}

function clearInputs(ids) {
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
}

async function showLoading() {
  console.log('kokoni deteru')
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.remove("hidden");
  await new Promise(r => setTimeout(r, 50)); // ğŸ’¡ å¼·åˆ¶çš„ã«å†æç”»
}

function hideLoading() {
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.add("hidden");
}

async function openUserList(mode) {
  window.userEditMode = mode;
  // mode = "edit" or "delete"

  const res = await fetch(`${API_URL}/api/user/list?hotel_id=1`);
  const json = await res.json();

  if (!json.success) {
    showToast("Falha ao obter usuÃ¡rios", true);
    return;
  }

  const list = json.users;
  const box = document.getElementById("userListBox");
  box.innerHTML = "";

  list.forEach(u => {
    box.innerHTML += `
      <div class="user-item" onclick="selectUser('${u.username}', '${u.name}', '${u.role}', '${u.contract_type}', '${u.language}')">
        <strong>${u.name}</strong>
        <div class="user-role">${u.role} â€¢ ${u.contract_type} â€¢ ${u.language}</div>
      </div>
    `;
  });

  document.getElementById("userSelectModal").style.display = "flex";
}

function closeUserSelect() {
  document.getElementById("userSelectModal").style.display = "none";
}

function selectUser(username, name, role, contract, language) {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
  closeUserSelect();

  // ====== ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ ======
  if (window.userEditMode === "edit") {
    document.getElementById("e_username").value = username;
    document.getElementById("e_name").value = name;
    document.getElementById("e_role").value = role;
    document.getElementById("e_contract").value = contract;
    document.getElementById("e_language").value = language;

    showToast("UsuÃ¡rio carregado para ediÃ§Ã£o!");
    return;
  }

  // ====== å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ ======
  if (window.userEditMode === "delete") {
    document.getElementById("d_username").value = username;

    showToast("UsuÃ¡rio selecionado para exclusÃ£o.");
    return;
  }
}

function openEditUserModal() {
  showUserForm('edit');   // â† ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…ˆã«æç”»
  openUserList("edit");   // â† ãã®å¾Œã«ä¸€è¦§è¡¨ç¤º
}

function openDeleteUserModal() {
  showUserForm('delete');
  openUserList("delete");
}




// ========= è¿½åŠ ï¼šæ˜æ—¥æ¸…æƒã®éšåˆ¥ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« =========
function openTomorrowModal() {
  const modal = document.createElement("div");
  modal.id = "tomorrowModal";
  modal.className = "modal";
  modal.style.display = "flex";

  // â‘  å¯¾è±¡ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
  const targetRooms = globalRoomData.filter(r => r.guest_count > 0);

  // â‘¡ éšåˆ¥ã«é›†è¨ˆ
  const countByFloor = {};
  targetRooms.forEach(r => {
    const floor = `${r.floor}F`;
    if (!countByFloor[floor]) countByFloor[floor] = 0;
    countByFloor[floor]++;
  });

  // â‘¢ æ•°å€¤é †ã«ã‚½ãƒ¼ãƒˆï¼ˆ4F â†’ 12Fï¼‰
  const sortedList = Object.entries(countByFloor).sort((a, b) => {
    const fa = parseInt(a[0]); // 4F â†’ 4
    const fb = parseInt(b[0]);
    return fa - fb;
  });

  // â‘£ HTMLãƒªã‚¹ãƒˆç”Ÿæˆ
  let listHtml = "";
  sortedList.forEach(([floor, count]) => {
    listHtml += `
      <div class="floor-row">
        <span>${floor}</span>
        <span class="count">${count}</span>
      </div>
    `;
  });

  // â‘¤ ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“çµ„ã¿ç«‹ã¦
  modal.innerHTML = `
    <div class="modal-box tomorrow-box">
      <div class="modal-header-tomorrow">
        Limpeza AmanhÃ£ â€” Por Andar
        <span class="close-btn" onclick="closeTomorrowModal()">âœ•</span>
      </div>
      <div class="floor-list">
        ${listHtml}
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function closeTomorrowModal() {
  const m = document.getElementById("tomorrowModal");
  if (m) m.remove();
}







renderFloorButtons();




loadDashboard().then(() => {
  // ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã« ALL ã§åˆæœŸé›†è¨ˆ

  const firstBtn = document.querySelector("#floorButtons button");
  selectFloor("ALL", firstBtn);
  // hideLoading()
});

</script>

</body>
</html>
