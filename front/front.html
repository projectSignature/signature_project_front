<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ›ãƒ†ãƒ«æ¸…æƒãƒãƒƒãƒ—ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆï¼‰</title>
    <link rel="stylesheet" href="./front.css">
</head>
<body>
  <header class="header">
    <img src="./img/logo.png" alt="RoomSync ãƒ­ã‚´">

    <div class="header-right">
      <button id="masterBtn">âš™ï¸ è¨­å®š</button>
      <button id="amenityListBtn">ğŸ“‹ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ä¸€è¦§</button>
      <button id="toggleLegendBtn">å‡¡ä¾‹è¡¨ç¤º</button>
      <button id="bulkModeBtn" class="bulk-btn">ğŸ§© ä¸€æ‹¬ç™»éŒ²</button>
 <button id="bulkChangeBtn" class="bulk-btn" disabled>ğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</button>
 <button id="importExcelBtn" class="bulk-btn">ğŸ“‚ æ¸…æƒãƒ‡ãƒ¼ã‚¿å–è¾¼</button>
 <button id="exportStatusBtn" class="bulk-btn">ğŸ“¤ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡ºåŠ›</button>

    </div>
  </header>

  <input type="file" id="excelUpload" accept=".xls,.xlsx" style="display:none">



<div id="map"></div>

<!-- å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<!-- <div class="context-menu" id="contextMenu">
  <ul>
    <li data-action="æƒé™¤ä¾é ¼">ğŸ§¹ æƒé™¤ä¾é ¼</li>
    <li data-action="ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£äº¤æ›">ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£äº¤æ›</li>
    <li data-action="å……é›»å™¨å›å">ğŸ”Œ å……é›»å™¨å›å</li>
    <li data-action="å»¶é•·ã‚³ãƒ¼ãƒ‰å›å">ğŸ”‹ å»¶é•·ã‚³ãƒ¼ãƒ‰å›å</li>
  </ul>
</div> -->

<div id="legend" class="hidden">
  <h4>å‡¡ä¾‹</h4>
<div class="legend-item"><span class="icon"><img src="./img/check.png" alt="ãƒã‚§ãƒƒã‚¯æ¸ˆ" class="icon-img"></span> ãƒã‚§ãƒƒã‚¯æ¸ˆ</div>
  <div class="legend-item"><span class="icon"><img src="./img/renpakuseisou.png" alt="é€£æ³Š" class="icon-img"></span>é€£æ³Šãƒ»è¦æ¸…æƒ</div>
  <div class="legend-item"><span class="icon"><img src="./img/noclean.png" alt="é€£æ³Š" class="icon-img"></span>é€£æ³Šãƒ»æ¸…æƒä¸è¦</div>
  <div class="legend-item"><span class="icon"><img src="./img/seisou.png" alt="é€£æ³Š" class="icon-img"></span>è¦æ¸…æƒ</div>
  <div class="legend-item"><span class="icon"><img src="./img/notuse.png" alt="æœªä½¿ç”¨" class="icon-img"></span>æœªä½¿ç”¨</div>

</div>

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="actionModal" class="modal">
  <div class="modal-content">
    <h3>ã©ã®æ“ä½œã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div class="action-buttons">
      <button id="statusChangeBtn"> éƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</button>
      <button id="amenityBtn" disabled>ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ãƒ»ä»–ä¾é ¼</button>
    </div>
    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="statusModal" class="modal">
  <div class="modal-content large">
    <h3>éƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ</h3>
    <div id="statusGrid" class="status-grid"></div>
    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<!-- ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£æ“ä½œã‚¿ã‚¤ãƒ—é¸æŠ -->
<div id="amenityTypeModal" class="modal">
  <div class="modal-content">
    <h3>ã©ã®ä¾é ¼ã‚’ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div class="action-buttons">
      <!-- <button class="amenity-type-btn" data-type="äº¤æ›">ğŸ”„ äº¤æ›</button> -->
      <button class="amenity-type-btn" data-type="è£œå……">ğŸ§´ è£œå……</button>
      <button class="amenity-type-btn" data-type="å›å">â™»ï¸ å›å</button>
    </div>
    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¸€è¦§é¸æŠ -->
<div id="amenityModal" class="modal">
  <div class="modal-content large">
    <h3>ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
    <div id="amenityGrid" class="status-grid"></div>
    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- è¿”å´å…ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="returnModal" class="modal">
  <div class="modal-content">
    <h3>ã©ã“ã¸è¿”å´ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div class="action-buttons">
      <button id="returnFrontBtn">ãƒ•ãƒ­ãƒ³ãƒˆ</button>
      <button id="returnStorageBtn">å€‰åº«å®¤</button>
    </div>
    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- ğŸ”„ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="spinner"></div>
  <p>å‡¦ç†ä¸­ã§ã™â€¦</p>
</div>

<!-- éƒ¨å±‹è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="roomDetailModal" class="modal">
  <div class="modal-content large">
    <h3>éƒ¨å±‹æƒ…å ±è©³ç´°</h3>

    <form id="roomDetailForm">
      <div class="form-grid">
        <label>å®¿æ³Šè€…åï¼š
          <input type="text" id="guestName" name="guestName">
        </label>
        <label>ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆäºˆå®šï¼š
          <input type="time" id="checkoutTime" name="checkoutTime">
        </label>
        <label>äººæ•°ï¼š
          <input type="number" id="guestCount" name="guestCount" min="1" max="10">
        </label>
        <label>å‚™è€ƒï¼š
          <textarea id="notes" name="notes" rows="3"></textarea>
        </label>
      </div>

      <div class="action-buttons">
        <button type="button" id="saveRoomDetailBtn">ç™»éŒ²</button>
        <button type="button" class="close-btn">âœ– é–‰ã˜ã‚‹</button>
      </div>
    </form>
  </div>
</div>

<!-- ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="amenityListModal" class="modal">
  <div class="modal-content large">
    <h3>ğŸ“‹ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ä¸€è¦§</h3>
    <div id="amenityListTableContainer">
      <table id="amenityListTable">
        <thead>
          <tr>
            <th>éƒ¨å±‹ç•ªå·</th>
            <th>ä¾é ¼å†…å®¹</th>
            <th>ç¨®åˆ¥</th>
            <th>è¿”å´å…ˆ</th>
            <th>ç™»éŒ²æ—¥æ™‚</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="amenityListBody">
          <tr><td colspan="6" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="action-buttons">
      <button class="close-btn">âœ– é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>






<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
const types = ["TP","TD","TM","SM","TC","DS"];
const statuses = ["å®¿æ³Šä¸­","é€£æ³Šä¸­","æƒé™¤å‰","ç¢ºèªæ¸ˆ","æœªä½¿ç”¨"];
// ===========================
// ğŸ¨ éƒ¨å±‹çŠ¶æ…‹ã‚¢ã‚¤ã‚³ãƒ³ä¸€è¦§
// ===========================


const icons = {
  checked: `<img src="./img/check.png" alt="ãƒã‚§ãƒƒã‚¯æ¸ˆ" class="icon-img">`,
  stay_clean: `<img src="./img/renpakuseisou.png" alt="é€£æ³Šãƒ»è¦æ¸…æƒ" class="icon-img">`,
  stay_noclean: `<img src="./img/noclean.png" alt="é€£æ³Šãƒ»æ¸…æƒä¸è¦" class="icon-img">`,
  need_clean: `<img src="./img/seisou.png" alt="è¦æ¸…æƒ" class="icon-img">`,
  unused: `<img src="./img/notuse.png" alt="æœªä½¿ç”¨" class="icon-img">`
};


const statusLabels = {
  checked: "ãƒã‚§ãƒƒã‚¯æ¸ˆã¿",
  stay_clean: "é€£æ³Šï¼ˆæ¸…æƒã‚ã‚Šï¼‰",
  stay_noclean: "é€£æ³Šï¼ˆæ¸…æƒä¸è¦ï¼‰",
  need_clean: "è¦æ¸…æƒ",
  unused: "æœªä½¿ç”¨"
};




// ========================================
// ğŸ¨ è‰²è¨­å®šï¼šã‚¿ã‚¤ãƒ— or éƒ¨å±‹ç•ªå·ã”ã¨ã«è‡ªç”±å¤‰æ›´
// ========================================
const roomColors = {
  // ã‚¿ã‚¤ãƒ—åˆ¥ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  TP: "#f2e6ff",
  TD: "#ffeacc",
  TM: "#fff6cc",
  SM: "#e6f7e6",
  TC: "#e6f2ff",
  DS: "#ffe6e6",

  // å€‹åˆ¥è¨­å®šï¼ˆå„ªå…ˆã•ã‚Œã‚‹ï¼‰
  "1201": "#ffebf0",  // è–„ãƒ”ãƒ³ã‚¯
  "1202": "#ebf8ff",  // è–„æ°´è‰²
  "804":  "#f7ffe6",  // è–„é»„ç·‘
  "501":  "#fff0e6",  // ãƒ™ãƒ¼ã‚¸ãƒ¥
  "401": "#99e6b3",
  "402": "#66b3ff",
  "403": "#66b3ff",
  "404": "#66b3ff",
  "405": "#66b3ff",
  "406": "#ebf8ff",
  "407": "#ebf8ff",
  "408": "#ffeb3b",
  "409": "#66b3ff",
  "410": "#66b3ff",
  "411": "#ffb3b3",
  "412": "#66b3ff",
  "413": "#66b3ff",
  "414": "#99e6b3",
  "415": "#66b3ff",
  "416": "#66b3ff",
  "417": "#ffeb3b",
  "418": "#99e6b3",
  "419": "#66b3ff",
  "420": "#66b3ff",
  "421": "#66b3ff",
  // ==== 5Fï¼ˆ501ã€œ521ï¼‰ ====
"501": "#66b3ff",
"502": "#66b3ff",
"503": "#66b3ff",
"504": "#66b3ff",
"505": "#66b3ff",
"506": "#66b3ff",
"507": "#66b3ff",
"508": "#ffeb3b",
"509": "#66b3ff",
"510": "#66b3ff",
"511": "#ffb3b3",
"512": "#66b3ff",
"513": "#66b3ff",
"514": "#99e6b3",
"515": "#66b3ff",
"516": "#66b3ff",
"517": "#ffeb3b",
"518": "#99e6b3",
"519": "#66b3ff",
"520": "#66b3ff",
"521": "#66b3ff",

// ==== 6Fï¼ˆ601ã€œ621ï¼‰ ====
"601": "#66b3ff",
"602": "#66b3ff",
"603": "#66b3ff",
"604": "#66b3ff",
"605": "#66b3ff",
"606": "#66b3ff",
"607": "#66b3ff",
"608": "#ffeb3b",
"609": "#66b3ff",
"610": "#66b3ff",
"611": "#ffb3b3",
"612": "#66b3ff",
"613": "#66b3ff",
"614": "#99e6b3",
"615": "#66b3ff",
"616": "#66b3ff",
"617": "#ffeb3b",
"618": "#99e6b3",
"619": "#66b3ff",
"620": "#66b3ff",
"621": "#66b3ff",

// ==== 7Fï¼ˆ701ã€œ721ï¼‰ ====
"701": "#66b3ff",
"702": "#66b3ff",
"703": "#66b3ff",
"704": "#66b3ff",
"705": "#66b3ff",
"706": "#66b3ff",
"707": "#66b3ff",
"708": "#ffeb3b",
"709": "#66b3ff",
"710": "#66b3ff",
"711": "#ffb3b3",
"712": "#66b3ff",
"713": "#66b3ff",
"714": "#99e6b3",
"715": "#66b3ff",
"716": "#66b3ff",
"717": "#ffeb3b",
"718": "#99e6b3",
"719": "#66b3ff",
"720": "#66b3ff",
"721": "#66b3ff",

// ==== 8Fï¼ˆ801ã€œ821ï¼‰ ====
"801": "#66b3ff",
"802": "#66b3ff",
"803": "#66b3ff",
"804": "#66b3ff",
"805": "#66b3ff",
"806": "#66b3ff",
"807": "#66b3ff",
"808": "#ffeb3b",
"809": "#66b3ff",
"810": "#66b3ff",
"811": "#ffb3b3",
"812": "#66b3ff",
"813": "#66b3ff",
"814": "#99e6b3",
"815": "#66b3ff",
"816": "#66b3ff",
"817": "#ffeb3b",
"818": "#99e6b3",
"819": "#66b3ff",
"820": "#66b3ff",
"821": "#66b3ff",

// ==== 9Fï¼ˆ901ã€œ917ï¼‰ ====
"901": "#99e6b3",
"902": "#ff8800",
"904": "#99e6b3",
"905": "#99e6b3",
"907": "#ff8800",
"908": "#ffeb3b",
"909": "#99e6b3",
"910": "#99e6b3",
"911": "#ffb3b3",
"912": "#99e6b3",
"913": "#99e6b3",
"914": "#ff8800",
"916": "#99e6b3",
"917": "#ffeb3b",
"918": "#99e6b3",
"919": "#ff8800",
"921": "#99e6b3",

"1001": "#99e6b3",
"1002": "#ff8800",
"1004": "#99e6b3",
"1005": "#99e6b3",
"1007": "#ff8800",
"1008": "#ffeb3b",
"1009": "#99e6b3",
"1010": "#99e6b3",
"1011": "#ffb3b3",
"1012": "#99e6b3",
"1013": "#99e6b3",
"1014": "#ff8800",
"1016": "#99e6b3",
"1017": "#ffeb3b",
"1018": "#99e6b3",
"1019": "#ff8800",
"1021": "#99e6b3",

"1101": "#99e6b3",
"1102": "#ff8800",
"1104": "#99e6b3",
"1105": "#ff8800",
"1107": "#99e6b3",
"1108": "#ffeb3b",
"1109": "#99e6b3",
"1110": "#99e6b3",
"1111": "#ffb3b3",
"1112": "#99e6b3",
"1113": "#99e6b3",
"1114": "#ff8800",
"1116": "#99e6b3",
"1117": "#ffeb3b",
"1118": "#99e6b3",
"1119": "#ff8800",
"1121": "#99e6b3",

"1201" : "#cc99ff",
"1202" : "#ccccff",
"1203" : "#ccccff",
"1204" : "#ccccff",
"1205" : "#9933ff",
"1206" : "#ccccff",
"1207" : "#ccccff",
"1208" : "#ccccff",
"1209" : "#ccccff",
"1210" : "#ccccff",
"1211" : "#ccccff",
"1212" : "#ccccff",



};

async function showLoading() {
  console.log('kokoni deteru')
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.remove("hidden");
  await new Promise(r => setTimeout(r, 50)); // ğŸ’¡ å¼·åˆ¶çš„ã«å†æç”»
}

function hideLoading() {
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.add("hidden");
}

let globalId = 1


// const statusLabels = {
//   "available": "ç¢ºèªæ¸ˆï¼ˆä½¿ç”¨å¯èƒ½ï¼‰",
//   "occupied": "å®¿æ³Šä¸­",
//   "stayover": "é€£æ³Šä¸­",
//   "cleaning": "æ¸…æƒä¸­",
//   "dirty": "æ¸…æƒå‰",
//   "maintenance": "æ•…éšœãƒ»ç‚¹æ¤œä¸­",
//   "reserved": "äºˆç´„æ¸ˆ",
//   "outofservice": "ä½¿ç”¨åœæ­¢ä¸­",
//   "unavailable": "æœªä½¿ç”¨ãƒ»é–‰é–ä¸­"
// };
// const API_URL = "http://localhost:3000";
https://squid-app-ug7x6.ondigitalocean.app

const map = document.getElementById("map");
const legend = document.getElementById("legend");
const toggleLegendBtn = document.getElementById("toggleLegendBtn");
let selectedRoom = null;


let updateTimers = {}; // éƒ¨å±‹ã”ã¨ã«ã‚¿ã‚¤ãƒãƒ¼ä¿æŒ

function scheduleGuestCountUpdate(roomId, newCount) {
  // ã™ã§ã«ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚‹ãªã‚‰ãƒªã‚»ãƒƒãƒˆ
  if (updateTimers[roomId]) {
    clearTimeout(updateTimers[roomId]);
  }

  // 1ç§’å¾Œã«é€ä¿¡
  updateTimers[roomId] = setTimeout(() => {
    updateGuestCount(roomId,globalId, newCount);
    delete updateTimers[roomId];
  }, 1000);
}




// ================================
// ğŸ”¹ éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// ================================
async function loadRooms() {
  try {
    showLoading();
    const res = await fetch(`${API_URL}/api/room/status?hotel_id=${globalId}`);
    hideLoading();
    if (!res.ok) throw new Error("APIå–å¾—å¤±æ•—");
    const data = await res.json();
    const rooms = data.rooms || [];
    const grouped = groupByFloor(rooms);

    map.innerHTML = "";

    let totalGuestCount = 0; // å…¨ä½“åˆè¨ˆ

    Object.keys(grouped)
      .sort((a, b) => b - a)
      .forEach((floor) => {
        const floorRooms = grouped[floor];
        let floorGuestCount = 0;

        const floorDiv = document.createElement("div");
        floorDiv.className = "floor";

        // âœ… ãƒ•ãƒ­ã‚¢ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å…ˆã«ä½œã‚‹
        const floorHeader = document.createElement("div");
        floorHeader.className = "floor-header";

        const floorTitle = document.createElement("h3");
        floorTitle.textContent = `${floor}F`;

        const floorTotal = document.createElement("span");
        floorTotal.className = "floor-total";
        floorTotal.textContent = `ğŸ‘¥ ${floorGuestCount}`; // ä»®å€¤ã€å¾Œã§æ›´æ–°

        floorHeader.appendChild(floorTitle);
        floorHeader.appendChild(floorTotal);
        floorDiv.appendChild(floorHeader);

        // âœ… éƒ¨å±‹ä¸€è¦§ã‚’ç”Ÿæˆ
        const roomsContainer = document.createElement("div");
        roomsContainer.className = "rooms";

        floorRooms.forEach((r) => {
          const room = document.createElement("div");
          room.className = `room room-${r.room_number} ${r.status} type-${r.room_type}`;
          room.dataset.room = r.room_number;
          room.dataset.status = r.status;
          room.dataset.id = r.id;
          room.dataset.guest_count = r.guest_count || 0;
          room.style.backgroundColor = getRoomColor(r);

          floorGuestCount += Number(r.guest_count || 0);

          room.innerHTML = `
            <div class="room-header ${r.stay_type === "group" ? "group-border" : ""}">
              ${r.room_number}<br><small>${r.room_type || "-"}</small>
            </div>
            <div class="room-guest">
              <button class="guest-btn up">â–³</button>
              <span class="guest-count">${r.guest_count || 0}</span>
              <button class="guest-btn down">â–½</button>
            </div>
            <div class="room-status ${r.checkout_status === "after" ? "checkout-border" : ""}">
              ${icons[r.status] || "?"}
            </div>
          `;

          // äººæ•°æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ
          const guestCountEl = room.querySelector(".guest-count");
          const upBtn = room.querySelector(".guest-btn.up");
          const downBtn = room.querySelector(".guest-btn.down");

          const updateDisplay = (newCount) => {
            guestCountEl.textContent = newCount;
            room.dataset.guest_count = newCount;
            scheduleGuestCountUpdate(r.id, newCount);
            updateTotals();
          };

          upBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            let count = Number(room.dataset.guest_count);
            updateDisplay(++count);
          });

          downBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            let count = Number(room.dataset.guest_count);
            if (count > 0) updateDisplay(--count);
          });

          // ğŸŸ¢ å·¦ã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          room.addEventListener("click", (e) => {
            e.stopPropagation();

            // ğŸŸ¢ ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰ONã®ã¨ãã¯é¸æŠã«ä½¿ã†
            if (bulkMode) {
              if (room.classList.contains("selected-bulk")) {
                room.classList.remove("selected-bulk");
                selectedRoomsBulk = selectedRoomsBulk.filter((r) => r !== room);
              } else {
                room.classList.add("selected-bulk");
                selectedRoomsBulk.push(room);
              }
              return;
            }

            // ğŸŸ£ é€šå¸¸ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãªã©ï¼‰
            selectedRoom = room;
            showActionModal(r);
          });




          // ğŸŸ¢ stay_typeå³ã‚¯ãƒªãƒƒã‚¯åˆ‡æ›¿ã‚¤ãƒ™ãƒ³ãƒˆ
          room.addEventListener("contextmenu", async (e) => {
            e.preventDefault();

            const newType = await toggleStayType(r.id, r.hotel_id);
            if (!newType) return;

            r.stay_type = newType;
            const header = room.querySelector(".room-header");
            if (newType === "group") {
              header.classList.add("group-border");
            } else {
              header.classList.remove("group-border");
            }

            // è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            const toast = document.createElement("div");
            toast.textContent = newType === "group" ? "ğŸ‘¥ ã‚°ãƒ«ãƒ¼ãƒ—ã«å¤‰æ›´" : "ğŸ‘¤ å€‹åˆ¥ã«å¤‰æ›´";
            toast.className = "toast";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
          });

          const statusDiv = room.querySelector(".room-status");
 statusDiv.addEventListener("dblclick", async (e) => {
   e.stopPropagation();

   const newStatus = await toggleCheckoutStatus(r.id, r.hotel_id);
   if (!newStatus) return;

   // è¡¨ç¤ºæ›´æ–°
   r.checkout_status = newStatus;

   if (newStatus === "after") {
     statusDiv.classList.add("checkout-border");
   } else {
     statusDiv.classList.remove("checkout-border");
   }

   // è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
   const toast = document.createElement("div");
   toast.textContent =
     newStatus === "after" ? "ğŸšª ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ¸ˆã«å¤‰æ›´" : "ğŸ  ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸­ã«å¤‰æ›´";
   toast.className = "toast";
   document.body.appendChild(toast);
   setTimeout(() => toast.remove(), 2000);
 });

          // â¬‡ï¸ æœ€å¾Œã«DOMã¸è¿½åŠ 
          roomsContainer.appendChild(room);

        });


        // âœ… å…¨éƒ¨ä½œã‚Šçµ‚ãˆãŸã‚ã¨ã§äººæ•°æ›´æ–°
        floorTotal.textContent = `ãŠå®¢æ§˜äººæ•°ï¼š ${floorGuestCount}äºº`;

        // âœ… append
        floorDiv.appendChild(roomsContainer);
        map.appendChild(floorDiv);

        // âœ… å…¨ä½“åˆè¨ˆã«ã‚‚åŠ ç®—
        totalGuestCount += floorGuestCount;
      });


    // Header ã®ç·äººæ•°è¡¨ç¤ºã‚’æ›´æ–°
    updateHeaderTotal(totalGuestCount);

    // âœ… å†…éƒ¨é–¢æ•°ï¼šäººæ•°ã®å†é›†è¨ˆ
    function updateTotals() {
      let newTotal = 0;

      document.querySelectorAll(".floor").forEach((floorDiv) => {
        const guestEls = floorDiv.querySelectorAll(".guest-count");
        let floorSum = 0;
        guestEls.forEach((el) => {
          const n = Number(el.textContent.replace("ğŸ‘¤", ""));
          floorSum += n;
        });

        const totalEl = floorDiv.querySelector(".floor-total");
        if (totalEl) totalEl.innerHTML = `ãŠå®¢æ§˜äººæ•°:${floorSum}`;

        newTotal += floorSum;
      });

      updateHeaderTotal(newTotal);
    }

  } catch (err) {
    console.error("âŒ éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    map.innerHTML = `<p style="color:red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
  }
}

async function toggleStayType(roomId) {
  try {
    const res = await fetch(`${API_URL}/api/room/${roomId}/stay_type`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hotel_id: globalId }),
    });

    const data = await res.json();
    if (data.success) {
      console.log("âœ… stay_type æ›´æ–°:", data.newType);
      return data.newType;
    } else {
      console.warn("âš ï¸ stay_type æ›´æ–°å¤±æ•—:", data.error);
      return null;
    }
  } catch (err) {
    console.error("âŒ stay_type æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
    return null;
  }
}

async function toggleCheckoutStatus(roomId) {
  try {
    const res = await fetch(`${API_URL}/api/room/${roomId}/checkout_status`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hotel_id: globalId  }),
    });

    const data = await res.json();
    if (data.success) {
      console.log("âœ… ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ›´æ–°:", data.newStatus);
      return data.newStatus;
    } else {
      console.warn("âš ï¸ æ›´æ–°å¤±æ•—:", data.error);
      return null;
    }
  } catch (err) {
    console.error("âŒ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
    return null;
  }
}



// ğŸ”§ Headerã«ç·äººæ•°ã‚’è¡¨ç¤º
function updateHeaderTotal(total) {
  const header = document.querySelector("header");
  if (!header) return;
  let totalEl = header.querySelector(".total-guests");
  if (!totalEl) {
    totalEl = document.createElement("span");
    totalEl.className = "total-guests";
    header.appendChild(totalEl);
  }
  totalEl.textContent = `ç·ãŠå®¢æ§˜äººæ•°: ${total}äºº`;
}


// ğŸ”§ DBæ›´æ–°APIå‘¼ã³å‡ºã—
async function updateGuestCount(roomId, hotelId, newCount) {
  try {
    console.log(hotelId)
    await fetch(`${API_URL}/api/room/${roomId}/guest_count`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        hotel_id: hotelId,
        guest_count: newCount,
      }),
    });
  } catch (err) {
    console.error("äººæ•°æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
  }
}




// ================================
// ğŸ”¹ ãƒ•ãƒ­ã‚¢ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
// ================================
function groupByFloor(rooms) {
  const grouped = {};
  for (const r of rooms) {
    const f = Number(r.floor);
    if (!grouped[f]) grouped[f] = [];
    grouped[f].push(r);
  }
  return grouped;
}

// ================================
// ğŸ”¹ è‰²è¨­å®š
// ================================
function getRoomColor(r) {
  const defaultColors = {
    "SM": "#e6f7e6",
    "SMS": "#e6f7e6",
    "TM": "#fff6cc",
    "TMS": "#fff6cc",
    "TD": "#ffeacc",
    "TDS": "#ffeacc",
    "TS": "#f2e6ff",
    "TP":"#d9b3ff",
    "TC": "#e6f2ff",
    "DS": "#ffe6e6",
    "TR":"#a64dff"
  };
  return defaultColors[r.room_type] || "#eee";
}

// ================================
// ğŸ”¹ å‡¡ä¾‹åˆ‡ã‚Šæ›¿ãˆ
// ================================
toggleLegendBtn.addEventListener("click", () => {
  legend.classList.toggle("hidden");
  toggleLegendBtn.textContent = legend.classList.contains("hidden") ? "å‡¡ä¾‹è¡¨ç¤º" : "å‡¡ä¾‹éè¡¨ç¤º";
});

// ================================
// ğŸ”¹ ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
// ================================
const actionModal = document.getElementById("actionModal");
const statusModal = document.getElementById("statusModal");
const statusGrid = document.getElementById("statusGrid");
const statusChangeBtn = document.getElementById("statusChangeBtn");
const closeButtons = document.querySelectorAll(".close-btn");
let currentRoom = null;

// ã€Œéƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€ã‚’æŠ¼ã—ãŸæ™‚
statusChangeBtn.addEventListener("click", () => {
  closeModal(actionModal);
  openModal(statusModal);
  renderStatusOptions();
});

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ã‚’æç”»
function renderStatusOptions() {
  statusGrid.innerHTML = "";

  Object.entries(icons).forEach(([key, icon]) => {
    const div = document.createElement("div");
    div.className = "status-option";
    div.innerHTML = `
      <span>${icon}</span>
      <small>${statusLabels[key] || key}</small>
    `;

    div.onclick = async () => {
      // ğŸ”¸ é€šå¸¸å‡¦ç†ï¼ˆå˜ä½“å¤‰æ›´ï¼‰
      if (!bulkMode) {
        if (!selectedRoom) {
          alert("âš ï¸ éƒ¨å±‹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }

        selectedRoom.dataset.status = key;
        selectedRoom.querySelector(".room-status").innerHTML = icon;
        selectedRoom.className = `room room-${selectedRoom.dataset.room} ${key}`;

        try {
          showLoading();

          const res = await fetch("http://localhost:3000/api/room/status", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              room_id: selectedRoom.dataset.id,
              status: key,
            }),
          });

          hideLoading();
          const result = await res.json();
          if (result.success) {
            console.log("âœ… æ›´æ–°æˆåŠŸ:", result.message);
          } else {
            console.warn("âš ï¸ æ›´æ–°å¤±æ•—:", result.error);
          }
        } catch (err) {
          hideLoading();
          console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
        }

        closeModal(statusModal);
        return;
      }

      // ğŸ”¸ ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰å‡¦ç†
      if (bulkMode && selectedRoomsBulk.length > 0) {
        const confirmChange = confirm(
          `é¸æŠã•ã‚ŒãŸ ${selectedRoomsBulk.length} éƒ¨å±‹ã‚’ã€Œ${statusLabels[key]}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`
        );
        if (!confirmChange) return;

        showLoading();

        for (const roomEl of selectedRoomsBulk) {
          roomEl.dataset.status = key;
          const statusDiv = roomEl.querySelector(".room-status");
          if (statusDiv) statusDiv.innerHTML = icon;
          // ç¾åœ¨ã®ã‚¯ãƒ©ã‚¹ã‚’ç¶­æŒã—ã¦ã€statusã ã‘ä¸Šæ›¸ã
const currentClasses = roomEl.className.split(" ").filter(c => !Object.keys(icons).includes(c));
roomEl.className = [...currentClasses, key].join(" ");


          try {
            await fetch("http://localhost:3000/api/room/status", {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                room_id: roomEl.dataset.id,
                status: key,
              }),
            });
          } catch (err) {
            console.error(`âŒ ${roomEl.dataset.room} æ›´æ–°å¤±æ•—`, err);
          }
        }

        hideLoading();
        alert(`âœ… ${selectedRoomsBulk.length} éƒ¨å±‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`);

        // ãƒ¢ãƒ¼ãƒ‰è§£é™¤ã¨é¸æŠè§£é™¤
        selectedRoomsBulk.forEach((r) => r.classList.remove("selected-bulk"));
        selectedRoomsBulk = [];
        bulkMode = false;
        const bulkBtn = document.getElementById("bulkModeBtn");
        if (bulkBtn) {
          bulkBtn.classList.remove("active");
          bulkBtn.textContent = "ğŸ§© ä¸€æ‹¬ç™»éŒ²";
        }

        closeModal(statusModal);
        return;
      }

      // ğŸ”¸ ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰ãªã®ã«é¸æŠãŒãªã„å ´åˆ
      if (bulkMode && selectedRoomsBulk.length === 0) {
        alert("âš ï¸ ä¸€æ‹¬å¤‰æ›´å¯¾è±¡ã®éƒ¨å±‹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    };

    statusGrid.appendChild(div);
  });
}


// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰é–¢æ•°
function openModal(modal) { modal.style.display = "flex"; }
function closeModal(modal) { modal.style.display = "none"; }
closeButtons.forEach(btn => btn.onclick = () => closeModal(btn.closest(".modal")));
window.onclick = (e) => {
  if (e.target.classList.contains("modal")) closeModal(e.target);
};

// ============================
// ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£é–¢é€£ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
// ============================
// ============================
// ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ï¼ˆäº¤æ›ãƒ»è£œå……ãƒ»å›åï¼‰
// ============================

const amenityBtn = document.getElementById("amenityBtn");
const amenityTypeModal = document.getElementById("amenityTypeModal");
const amenityModal = document.getElementById("amenityModal");
const amenityGrid = document.getElementById("amenityGrid");
const returnModal = document.getElementById("returnModal");
const returnFrontBtn = document.getElementById("returnFrontBtn");
const returnStorageBtn = document.getElementById("returnStorageBtn");

let selectedAmenity = null;
let selectedAmenityType = null;

// ğŸ”¸ ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
amenityBtn.disabled = false;

// ğŸ”¸ ã€Œã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ãƒ»ä»–ä¾é ¼ã€ã‚¯ãƒªãƒƒã‚¯ â†’ ç¨®é¡é¸æŠã¸
amenityBtn.addEventListener("click", () => {
  closeModal(actionModal);
  openModal(amenityTypeModal);
});

// ğŸ”¸ äº¤æ›ï¼è£œå……ï¼å›åãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
document.querySelectorAll(".amenity-type-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    selectedAmenityType = btn.dataset.type;
    closeModal(amenityTypeModal);
    openModal(amenityModal);
    renderAmenityOptions();
  });
});

// ğŸ”¸ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¸€è¦§
const amenities = [
  "ã¾ãã‚‰",
  "ãƒãƒ³ã‚¬ãƒ¼",
  "å……é›»å™¨",
  "æ‰‡é¢¨æ©Ÿ",
  "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«",
  "å»¶é•·ã‚³ãƒ¼ãƒ‰",
  "åŠ æ¹¿å™¨",
  "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ"
];

function renderAmenityOptions() {
  amenityGrid.innerHTML = "";
  amenities.forEach(item => {
    const div = document.createElement("div");
    div.className = "status-option";
    div.innerHTML = `<span></span><small>${item}</small>`;

    div.onclick = async () => {
      selectedAmenity = item;
      closeModal(amenityModal);

      // âœ… æ¡ä»¶åˆ†å²ï¼šäº¤æ› or å›å â†’ è¿”å´å…ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      if (selectedAmenityType === "äº¤æ›" || selectedAmenityType === "å›å") {
        openModal(returnModal);
      }
      // âœ… è£œå…… â†’ è¿”å´å…ˆãªã—ã§å³ç™»éŒ²
      else if (selectedAmenityType === "è£œå……") {
        const payload = {
          room_id: selectedRoom.dataset.id,
          action_type: selectedAmenityType,
          amenity: selectedAmenity
        };
        try {
          showLoading();
          const res = await fetch("http://localhost:3000/api/room/amenity", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const result = await res.json();
          hideLoading();
          if (result.success) {
            alert(`éƒ¨å±‹ ${selectedRoom.dataset.room}ï¼š${selectedAmenity} ã®ã€Œè£œå……ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
          } else {
            alert(`âš ï¸ ç™»éŒ²å¤±æ•—: ${result.error}`);
          }
        } catch (err) {
          hideLoading();
          console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
        }
        // ãƒªã‚»ãƒƒãƒˆ
        selectedAmenity = null;
        selectedAmenityType = null;
      }
    };

    amenityGrid.appendChild(div);
  });
}



// ğŸ”¸ è¿”å´å…ˆé¸æŠ
async function handleReturn(location) {
  if (!selectedRoom || !selectedAmenityType || !selectedAmenity) return;

  const payload = {
    room_id: selectedRoom.dataset.id,
    action_type: selectedAmenityType,  // äº¤æ›ï¼è£œå……ï¼å›å
    amenity: selectedAmenity,
    return_to: location
  };

  try {
    showLoading()
    const res = await fetch("http://localhost:3000/api/room/amenity", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    hideLoading();
    if (result.success) {
      alert(`éƒ¨å±‹ ${selectedRoom.dataset.room}ï¼š${selectedAmenity} ã®ã€Œ${selectedAmenityType}ã€ã‚’ ${location} ã«ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
    } else {
      alert(`âš ï¸ ç™»éŒ²å¤±æ•—: ${result.error}`);
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
  }

  // ãƒªã‚»ãƒƒãƒˆ
  selectedAmenity = null;
  selectedAmenityType = null;
  closeModal(returnModal);
}

returnFrontBtn.addEventListener("click", () => handleReturn("ãƒ•ãƒ­ãƒ³ãƒˆ"));
returnStorageBtn.addEventListener("click", () => handleReturn("å€‰åº«å®¤"));


console.log('yes')

const roomDetailModal = document.getElementById("roomDetailModal");
const saveRoomDetailBtn = document.getElementById("saveRoomDetailBtn");
const guestNameInput = document.getElementById("guestName");
const checkoutTimeInput = document.getElementById("checkoutTime");
const guestCountInput = document.getElementById("guestCount");
const notesInput = document.getElementById("notes");

// é–‹ãå‡¦ç†
function openRoomDetailModal(roomElement) {
  const modal = document.getElementById("roomDetailModal");

  // datasetã‹ã‚‰æƒ…å ±ã‚’å–å¾—
  document.getElementById("guestName").value = roomElement.dataset.guest_name || "";
  document.getElementById("checkoutTime").value = roomElement.dataset.checkout_time || "";
  document.getElementById("guestCount").value = roomElement.dataset.guest_count || "";
  document.getElementById("notes").value = roomElement.dataset.notes || "";

  openModal(roomDetailModal);
}

// ä¿å­˜å‡¦ç†
saveRoomDetailBtn.addEventListener("click", async () => {
  const payload = {
    room_id: selectedRoom.dataset.id,
    guest_name: guestNameInput.value,
    checkout_time: checkoutTimeInput.value,
    guest_count: guestCountInput.value,
    notes: notesInput.value
  };

  try {
    showLoading();
    const res = await fetch("http://localhost:3000/api/room/details", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    hideLoading();

    if (result.success) {
      alert("ğŸ’¾ éƒ¨å±‹æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
      // datasetã‚’æ›´æ–°ï¼ˆå†è¡¨ç¤ºç”¨ï¼‰
      selectedRoom.dataset.guestName = payload.guest_name;
      selectedRoom.dataset.checkoutTime = payload.checkout_time;
      selectedRoom.dataset.guestCount = payload.guest_count;
      selectedRoom.dataset.notes = payload.notes;
    } else {
      alert(`âš ï¸ æ›´æ–°å¤±æ•—: ${result.error}`);
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
  }

  closeModal(roomDetailModal);
});

const amenityListBtn = document.getElementById("amenityListBtn");
const amenityListModal = document.getElementById("amenityListModal");
const amenityListBody = document.getElementById("amenityListBody");

// ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
amenityListBtn.addEventListener("click", () => {
  openModal(amenityListModal);
  loadAmenityRequests();
});

// ä¾é ¼ä¸€è¦§ã‚’å–å¾—
async function loadAmenityRequests() {
  try {
    showLoading();
    const res = await fetch("http://localhost:3000/api/room/amenity/list"); // â† æ–°API
    hideLoading();
    if (!res.ok) throw new Error("APIå–å¾—å¤±æ•—");

    const data = await res.json();
    const list = data.requests || [];

    amenityListBody.innerHTML = "";

    if (list.length === 0) {
      amenityListBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
      return;
    }

    list.forEach(req => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${req.room_number}</td>
        <td>${req.amenity}</td>
        <td>${req.action_type}</td>
        <td>${req.return_to || "-"}</td>
        <td>${new Date(req.created_at).toLocaleString("ja-JP")}</td>
        <td><button onclick="completeAmenity(${req.id})">å®Œäº†</button></td>
      `;
      amenityListBody.appendChild(tr);
    });
  } catch (err) {
    hideLoading();
    console.error("âŒ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¸€è¦§ã‚¨ãƒ©ãƒ¼:", err);
    amenityListBody.innerHTML = `<tr><td colspan="6" style="color:red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>`;
  }
}

// å®Œäº†å‡¦ç†ï¼ˆå‰Šé™¤ï¼‰
async function completeAmenity(id) {
  if (!confirm("ã“ã®ä¾é ¼ã‚’å®Œäº†ã¨ã—ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  try {
    showLoading();
    const res = await fetch(`http://localhost:3000/api/room/amenity/${id}`, {
      method: "DELETE"
    });
    const result = await res.json();
    hideLoading();

    if (result.success) {
      alert("âœ… å®Œäº†ã—ã¾ã—ãŸï¼");
      loadAmenityRequests(); // å†èª­è¾¼
    } else {
      alert("âš ï¸ å‰Šé™¤å¤±æ•—: " + result.error);
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", err);
  }
}
function showActionModal(roomData) {
  const modal = document.getElementById("actionModal");
  const closeBtn = modal.querySelector(".close-btn");
  const statusBtn = modal.querySelector("#statusChangeBtn");
  const amenityBtn = modal.querySelector("#amenityBtn");

  // è¡¨ç¤º
  modal.style.display = "flex";



  // é–‰ã˜ã‚‹å‡¦ç†
  closeBtn.onclick = () => (modal.style.display = "none");
  modal.onclick = (e) => {
    if (e.target.id === "actionModal") modal.style.display = "none";
  };

  // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  // statusBtn.onclick = () => {
  //   console.log(`ğŸŸ¢ ${roomData.room_number} éƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´`);
  //   modal.style.display = "none";
  //   // â†’ ã“ã“ã«åˆ¥ã®ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ãå‡¦ç†ãªã©ã‚’è¿½åŠ å¯
  // };

  amenityBtn.onclick = () => {
    console.log(`ğŸ§´ ${roomData.room_number} ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼`);
    modal.style.display = "none";
    // â†’ ã“ã“ã§ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©ã‚’é–‹ãå‡¦ç†ã¸
  };
}

let bulkMode = false;
let selectedRoomsBulk = [];

const bulkChangeBtn = document.getElementById("bulkChangeBtn");

// ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
document.getElementById("bulkModeBtn").addEventListener("click", (e) => {
  bulkMode = !bulkMode;
  selectedRoomsBulk = [];

  e.target.classList.toggle("active", bulkMode);
  e.target.textContent = bulkMode ? "âœ… é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­" : "ğŸ§© ä¸€æ‹¬ç™»éŒ²";

  document.querySelectorAll(".room").forEach((room) => {
    room.classList.remove("selected-bulk");
  });

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹/ç„¡åŠ¹
  bulkChangeBtn.disabled = !bulkMode;
});

// âœ… ã€ŒğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
bulkChangeBtn.addEventListener("click", () => {
  if (!bulkMode) return;
  if (selectedRoomsBulk.length === 0) {
    alert("âš ï¸ ä¸€æ‹¬å¤‰æ›´ã™ã‚‹éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  openModal(statusModal);
  renderStatusOptions(); // â† ã“ã“ã§ä¸€æ‹¬å¤‰æ›´å‡¦ç†ãŒå‹•ãï¼ï¼
});

document.getElementById("importExcelBtn").addEventListener("click", () => {
  document.getElementById("excelUpload").click();
});

document.getElementById("excelUpload").addEventListener("change", handleExcelUpload);

async function handleExcelUpload(e) {
  const file = e.target.files[0];
  if (!file) return;

  showLoading();

  try {
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    // ğŸ”¹ Aåˆ—ï¼ˆéƒ¨å±‹ç•ªå·ï¼‰ï¼‹Eåˆ—ï¼ˆæ¸…æƒçŠ¶æ…‹ï¼‰æŠ½å‡º
    const result = [];
    for (let i = 5; i < json.length; i++) {
      const row = json[i];
      const roomNoRaw = row[0];
      const status = row[4]; // Eåˆ—

      if (!roomNoRaw || !status) continue;

      const roomNo = String(roomNoRaw).replace(/^0+/, ""); // 0401 â†’ 401

      if (status.includes("æœªæ¸…æƒ")) {
        result.push(roomNo);
      }
    }

    if (result.length === 0) {
      hideLoading();
      alert("æœªæ¸…æƒã®éƒ¨å±‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    // âœ… ãƒ¯ãƒ³ã‚¯ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
    const ok = confirm(`ğŸ§¹ æœªæ¸…æƒã® ${result.length} éƒ¨å±‹ã‚’ä¸€æ‹¬ã§ã€Œè¦æ¸…æƒã€ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ`);
    if (!ok) {
      hideLoading();
      return;
    }

    console.log("ğŸ§¾ æ›´æ–°å¯¾è±¡:", result);

    // ğŸ”¹ å¯¾è±¡éƒ¨å±‹ã®IDã‚’å–å¾—ã—ã¦ã¾ã¨ã‚ã‚‹
    const roomsOnMap = document.querySelectorAll(".room");
    const updatePayload = [];

    for (const room of roomsOnMap) {
      const roomNo = room.dataset.room;
      if (result.includes(roomNo)) {
        room.dataset.status = "need_clean";
        const statusDiv = room.querySelector(".room-status");
        if (statusDiv) statusDiv.innerHTML = icons["need_clean"];

        const currentClasses = room.className
          .split(" ")
          .filter((c) => !Object.keys(icons).includes(c));
        room.className = [...currentClasses, "need_clean"].join(" ");

        updatePayload.push({
          room_id: room.dataset.id,
          status: "need_clean",
        });
      }
    }

    if (updatePayload.length === 0) {
      hideLoading();
      alert("å¯¾è±¡ã®éƒ¨å±‹ãŒãƒãƒƒãƒ—ä¸Šã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return;
    }

    // âœ… ä¸€æ‹¬APIã§é€ä¿¡
    const res = await fetch("http://localhost:3000/api/room/status/bulk", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ updates: updatePayload }),
    });

    hideLoading();

    const resultJson = await res.json();
    if (resultJson.success) {
      alert(`âœ… ${resultJson.updated} éƒ¨å±‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸€æ‹¬æ›´æ–°ã—ã¾ã—ãŸï¼`);
    } else {
      alert("âš ï¸ ä¸€æ‹¬æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ Excelè§£æã‚¨ãƒ©ãƒ¼:", err);
    alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
}

document.getElementById("exportStatusBtn").addEventListener("click", exportRoomStatus);

function exportRoomStatus() {
  const rooms = document.querySelectorAll(".room");
  if (!rooms.length) {
    alert("éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  const data = [];

  rooms.forEach(room => {
    const roomNumber = room.dataset.room;
    const floor = room.closest(".floor")?.querySelector("h3")?.textContent?.replace("F", "") || "";
    const statusClass = Object.keys(icons).find(k => room.classList.contains(k)) || "ä¸æ˜";
    const stayType = room.querySelector(".room-header")?.classList.contains("group-border") ? "ã‚°ãƒ«ãƒ¼ãƒ—" : "å€‹åˆ¥";
    const checkoutStatus = room.querySelector(".room-status")?.classList.contains("checkout-border") ? "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ¸ˆ" : "æ»åœ¨ä¸­";
    const guestCount = room.dataset.guest_count || "0";

    data.push({
      éƒ¨å±‹ç•ªå·: roomNumber,
      éš: floor,
      ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: statusLabels[statusClass] || statusClass,
      æ»åœ¨ã‚¿ã‚¤ãƒ—: stayType,
      ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹: checkoutStatus,
      å®¿æ³Šäººæ•°: guestCount,
    });
  });

  // ğŸ”¹ Excel ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ä½œæˆ
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Room Status");

  // ğŸ”¹ æ—¥ä»˜å…¥ã‚Šãƒ•ã‚¡ã‚¤ãƒ«å
  const today = new Date().toISOString().slice(0, 10);
  const fileName = `room_status_${today}.xlsx`;

  XLSX.writeFile(wb, fileName);
}



// ================================
// ğŸš€ åˆæœŸåŒ–
// ================================
loadRooms();
</script>
</body>
</html>
