<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>RoomSync</title>
    <link rel="stylesheet" href="./front.css">
</head>
<body>
  <header class="header">
    <img src="./img/logo.png" alt="RoomSync ãƒ­ã‚´">

    <div class="header-right">

      <button id="amenityListBtn">ğŸ“‹ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ä¸€è¦§</button>
      <button id="masterBtn">âš™ï¸ä»–æŒ‡ç¤ºä¸€è¦§</button>
      <button id="toggleLegendBtn">å‡¡ä¾‹è¡¨ç¤º</button>
      <button id="bulkModeBtn" class="bulk-btn">ğŸ§© ä¸€æ‹¬ç™»éŒ²</button>
 <button id="bulkChangeBtn" class="bulk-btn" disabled>ğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</button>
 <button id="importExcelBtn" class="bulk-btn">ğŸ“‚ æ¸…æƒãƒ‡ãƒ¼ã‚¿å–è¾¼</button>
 <button id="exportStatusBtn" class="bulk-btn">ğŸ“¤ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡ºåŠ›</button>

    </div>
  </header>

  <input type="file" id="excelUpload" accept=".xls,.xlsx" style="display:none">



<div id="map"></div>

<!-- å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<!-- <div class="context-menu" id="contextMenu">
  <ul>
    <li data-action="æƒé™¤ä¾é ¼">ğŸ§¹ æƒé™¤ä¾é ¼</li>
    <li data-action="ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£äº¤æ›">ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£äº¤æ›</li>
    <li data-action="å……é›»å™¨å›å">ğŸ”Œ å……é›»å™¨å›å</li>
    <li data-action="å»¶é•·ã‚³ãƒ¼ãƒ‰å›å">ğŸ”‹ å»¶é•·ã‚³ãƒ¼ãƒ‰å›å</li>
  </ul>
</div> -->

<div id="legend" class="hidden">
  <h4>å‡¡ä¾‹</h4>
<div class="legend-item"><span class="icon"><img src="./img/check.png" alt="ãƒã‚§ãƒƒã‚¯æ¸ˆ" class="icon-img"></span> ãƒã‚§ãƒƒã‚¯æ¸ˆ</div>
  <div class="legend-item"><span class="icon"><img src="./img/renpakuseisou.png" alt="é€£æ³Š" class="icon-img"></span>é€£æ³Šãƒ»è¦æ¸…æƒ</div>
  <div class="legend-item"><span class="icon"><img src="./img/noclean.png" alt="é€£æ³Š" class="icon-img"></span>é€£æ³Šãƒ»æ¸…æƒä¸è¦</div>
  <div class="legend-item"><span class="icon"><img src="./img/seisou.png" alt="é€£æ³Š" class="icon-img"></span>è¦æ¸…æƒ</div>
  <div class="legend-item"><span class="icon"><img src="./img/notuse.png" alt="æœªä½¿ç”¨" class="icon-img"></span>æœªä½¿ç”¨</div>

</div>

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="actionModal" class="modal">
  <div class="modal-content">
    <h3>ã©ã®æ“ä½œã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div class="action-buttons">
      <button id="statusChangeBtn"> éƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</button>
      <button id="amenityBtn" disabled>ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ãƒ»ä»–ä¾é ¼</button>
    </div>
    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="statusModal" class="modal">
  <div class="modal-content large">
    <h3>éƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ</h3>
    <div id="statusGrid" class="status-grid"></div>
    <button class="close-btn">âœ–</button>
  </div>
</div>


<!-- ğŸŒŸ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="amenityTypeModal" class="amenity-modal">
  <div class="amenity-modal-content">
    <h3>ã©ã®ä¾é ¼ã‚’ã—ã¾ã™ã‹ï¼Ÿ</h3>

    <div class="action-buttons">
      <button class="amenity-type-btn" data-type="è£œå……">ğŸ§´ è£œå……</button>
      <button class="amenity-type-btn" data-type="å›å">â™»ï¸ å›å</button>
      <button id="otherRequestBtn">ğŸ“ ãã®ä»–ã®ä¾é ¼</button>
    </div>

    <!-- âœï¸ ãã®ä»–ä¾é ¼å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
    <div id="otherRequestArea" class="hidden">
      <textarea id="otherRequestInput" placeholder="ä¾é ¼å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
      <button id="sendOtherRequestBtn">é€ä¿¡</button>
    </div>


    <button class="close-btn-amenity-modal">âœ–</button>
  </div>
</div>

<!-- ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¸€è¦§é¸æŠ -->
<div id="amenityModal" class="modal">
  <div class="modal-content large">
    <h3>ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
    <div id="amenityGrid" class="status-grid"></div>
    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- è¿”å´å…ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="returnModal" class="modal">
  <div class="modal-content">
    <h3>ã©ã“ã¸è¿”å´ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div class="action-buttons">
      <button id="returnFrontBtn">ãƒ•ãƒ­ãƒ³ãƒˆ</button>
      <button class="linen-btn" data-floor="4">4Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="5">5Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="6">6Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="7">7Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="8">8Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="9">9Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="10">10Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="11">11Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="12">12Fãƒªãƒãƒ³åº«</button>
    </div>

    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- ğŸ”„ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="spinner"></div>
  <p>å‡¦ç†ä¸­ã§ã™â€¦</p>
</div>

<!-- éƒ¨å±‹è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="roomDetailModal" class="modal">
  <div class="modal-content large">
    <h3>éƒ¨å±‹æƒ…å ±è©³ç´°</h3>

    <form id="roomDetailForm">
      <div class="form-grid">
        <label>å®¿æ³Šè€…åï¼š
          <input type="text" id="guestName" name="guestName">
        </label>
        <label>ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆäºˆå®šï¼š
          <input type="time" id="checkoutTime" name="checkoutTime">
        </label>
        <label>äººæ•°ï¼š
          <input type="number" id="guestCount" name="guestCount" min="1" max="10">
        </label>
        <label>å‚™è€ƒï¼š
          <textarea id="notes" name="notes" rows="3"></textarea>
        </label>
      </div>

      <div class="action-buttons">
        <button type="button" id="saveRoomDetailBtn">ç™»éŒ²</button>
        <button type="button" class="close-btn">âœ– é–‰ã˜ã‚‹</button>
      </div>
    </form>
  </div>
</div>

<!-- ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="amenityListModal" class="modal">
  <div class="modal-content large">
    <h3>ğŸ“‹ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ä¸€è¦§</h3>
    <div id="amenityListTableContainer">
      <table id="amenityListTable">
        <thead>
          <tr>
            <th>éƒ¨å±‹ç•ªå·</th>
            <th>ä¾é ¼å†…å®¹</th>
            <th>ç¨®åˆ¥</th>
            <th>è¿”å´å…ˆ</th>
            <th>ç™»éŒ²æ—¥æ™‚</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="amenityListBody">
          <tr><td colspan="6" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="action-buttons">
      <button class="close-btn">âœ– é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- âš™ï¸ãã®ä»–ä¾é ¼ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="otherRequestListModal" class="modal">
  <div class="modal-content large">
    <h3>âš™ï¸ ãã®ä»–ä¾é ¼ä¸€è¦§</h3>

    <div id="otherRequestTableContainer">
      <table id="otherRequestTable">
        <thead>
          <tr>
            <th>éš</th>
            <th>éƒ¨å±‹ç•ªå·</th>
            <th>ä¾é ¼å†…å®¹</th>
            <th>æœ€çµ‚æ›´æ–°</th>
          </tr>
        </thead>
        <tbody id="otherRequestBody">
          <tr><td colspan="4" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="action-buttons">
      <button class="close-btn">âœ– é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>


<!-- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLã‚’ãƒ•ãƒƒã‚¿ãƒ¼ç›´å‰ãªã©ã«è¿½åŠ  -->
<div id="bulkConfirmModal" style="
  display:none;
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
  z-index:9999;
">
  <div style="
    background:#fff;
    padding:20px;
    border-radius:8px;
    width:320px;
    box-shadow:0 3px 8px rgba(0,0,0,0.3);
    text-align:left;
  ">
    <h3>ğŸ§¹ ä¸€æ‹¬æ›´æ–°å†…å®¹ã®é¸æŠ</h3>
    <p>ä»¥ä¸‹ã®å†…å®¹ã‚’æ›´æ–°ã—ã¾ã™ã€‚ä¸è¦ãªé …ç›®ã¯ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãã ã•ã„ã€‚</p>
    <label><input type="checkbox" id="chkStatus" checked> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæ¸…æƒä¾é ¼ï¼‰</label><br>
    <label><input type="checkbox" id="chkGuest" checked> äººæ•°</label><br><br>
    <div style="text-align:right;">
      <button id="bulkCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="bulkOkBtn">OK</button>
    </div>
  </div>
</div>







<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
const types = ["TP","TD","TM","SM","TC","DS"];
const statuses = ["å®¿æ³Šä¸­","é€£æ³Šä¸­","æƒé™¤å‰","ç¢ºèªæ¸ˆ","æœªä½¿ç”¨"];
// ===========================
// ğŸ¨ éƒ¨å±‹çŠ¶æ…‹ã‚¢ã‚¤ã‚³ãƒ³ä¸€è¦§
// ===========================


const icons = {
  checked: `<img src="./img/check.png" alt="ãƒã‚§ãƒƒã‚¯æ¸ˆ" class="icon-img">`,
  stay_clean: `<img src="./img/renpakuseisou.png" alt="é€£æ³Šãƒ»è¦æ¸…æƒ" class="icon-img">`,
  stay_noclean: `<img src="./img/noclean.png" alt="é€£æ³Šãƒ»æ¸…æƒä¸è¦" class="icon-img">`,
  need_clean: `<img src="./img/seisou.png" alt="è¦æ¸…æƒ" class="icon-img">`,
  before_check: `<img src="./img/seisou.png" alt="æ¸…æƒç¢ºèªä¸­" class="icon-img">`,
  unused: `<img src="./img/notuse.png" alt="æœªä½¿ç”¨" class="icon-img">`,
  checkOut: `<img src="./img/checkOut.png" alt="æœªä½¿ç”¨" class="icon-img">`,
  singleGuest :`<img src="./img/checkOut.png" alt="æœªä½¿ç”¨" class="icon-img">`,
  groupe :`<img src="./img/checkOut.png" alt="æœªä½¿ç”¨" class="icon-img">`,
};


const statusLabels = {
  checked: "ãƒã‚§ãƒƒã‚¯æ¸ˆã¿",
  stay_clean: "é€£æ³Šï¼ˆæ¸…æƒã‚ã‚Šï¼‰",
  stay_noclean: "é€£æ³Šï¼ˆæ¸…æƒä¸è¦ï¼‰",
  need_clean: "è¦æ¸…æƒ",
  unused: "æœªä½¿ç”¨",
  checkOut:'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ',
  singleGuest:'FITã¸å¤‰æ›´',
  groupe:'å›£ä½“ã¸å¤‰æ›´'
};




// ========================================
// ğŸ¨ è‰²è¨­å®šï¼šã‚¿ã‚¤ãƒ— or éƒ¨å±‹ç•ªå·ã”ã¨ã«è‡ªç”±å¤‰æ›´
// ========================================
const roomColors = {
  // ã‚¿ã‚¤ãƒ—åˆ¥ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  TP: "#f2e6ff",
  TD: "#ffeacc",
  TM: "#fff6cc",
  SM: "#e6f7e6",
  TC: "#e6f2ff",
  DS: "#ffe6e6",

  // å€‹åˆ¥è¨­å®šï¼ˆå„ªå…ˆã•ã‚Œã‚‹ï¼‰
  "1201": "#ffebf0",  // è–„ãƒ”ãƒ³ã‚¯
  "1202": "#ebf8ff",  // è–„æ°´è‰²
  "804":  "#f7ffe6",  // è–„é»„ç·‘
  "501":  "#fff0e6",  // ãƒ™ãƒ¼ã‚¸ãƒ¥
  "401": "#99e6b3",
  "402": "#66b3ff",
  "403": "#66b3ff",
  "404": "#66b3ff",
  "405": "#66b3ff",
  "406": "#ebf8ff",
  "407": "#ebf8ff",
  "408": "#ffeb3b",
  "409": "#66b3ff",
  "410": "#66b3ff",
  "411": "#ffb3b3",
  "412": "#66b3ff",
  "413": "#66b3ff",
  "414": "#99e6b3",
  "415": "#66b3ff",
  "416": "#66b3ff",
  "417": "#ffeb3b",
  "418": "#99e6b3",
  "419": "#66b3ff",
  "420": "#66b3ff",
  "421": "#66b3ff",
  // ==== 5Fï¼ˆ501ã€œ521ï¼‰ ====
"501": "#66b3ff",
"502": "#66b3ff",
"503": "#66b3ff",
"504": "#66b3ff",
"505": "#66b3ff",
"506": "#66b3ff",
"507": "#66b3ff",
"508": "#ffeb3b",
"509": "#66b3ff",
"510": "#66b3ff",
"511": "#ffb3b3",
"512": "#66b3ff",
"513": "#66b3ff",
"514": "#99e6b3",
"515": "#66b3ff",
"516": "#66b3ff",
"517": "#ffeb3b",
"518": "#99e6b3",
"519": "#66b3ff",
"520": "#66b3ff",
"521": "#66b3ff",

// ==== 6Fï¼ˆ601ã€œ621ï¼‰ ====
"601": "#66b3ff",
"602": "#66b3ff",
"603": "#66b3ff",
"604": "#66b3ff",
"605": "#66b3ff",
"606": "#66b3ff",
"607": "#66b3ff",
"608": "#ffeb3b",
"609": "#66b3ff",
"610": "#66b3ff",
"611": "#ffb3b3",
"612": "#66b3ff",
"613": "#66b3ff",
"614": "#99e6b3",
"615": "#66b3ff",
"616": "#66b3ff",
"617": "#ffeb3b",
"618": "#99e6b3",
"619": "#66b3ff",
"620": "#66b3ff",
"621": "#66b3ff",

// ==== 7Fï¼ˆ701ã€œ721ï¼‰ ====
"701": "#66b3ff",
"702": "#66b3ff",
"703": "#66b3ff",
"704": "#66b3ff",
"705": "#66b3ff",
"706": "#66b3ff",
"707": "#66b3ff",
"708": "#ffeb3b",
"709": "#66b3ff",
"710": "#66b3ff",
"711": "#ffb3b3",
"712": "#66b3ff",
"713": "#66b3ff",
"714": "#99e6b3",
"715": "#66b3ff",
"716": "#66b3ff",
"717": "#ffeb3b",
"718": "#99e6b3",
"719": "#66b3ff",
"720": "#66b3ff",
"721": "#66b3ff",

// ==== 8Fï¼ˆ801ã€œ821ï¼‰ ====
"801": "#66b3ff",
"802": "#66b3ff",
"803": "#66b3ff",
"804": "#66b3ff",
"805": "#66b3ff",
"806": "#66b3ff",
"807": "#66b3ff",
"808": "#ffeb3b",
"809": "#66b3ff",
"810": "#66b3ff",
"811": "#ffb3b3",
"812": "#66b3ff",
"813": "#66b3ff",
"814": "#99e6b3",
"815": "#66b3ff",
"816": "#66b3ff",
"817": "#ffeb3b",
"818": "#99e6b3",
"819": "#66b3ff",
"820": "#66b3ff",
"821": "#66b3ff",

// ==== 9Fï¼ˆ901ã€œ917ï¼‰ ====
"901": "#99e6b3",
"902": "#ff8800",
"904": "#99e6b3",
"905": "#99e6b3",
"907": "#ff8800",
"908": "#ffeb3b",
"909": "#99e6b3",
"910": "#99e6b3",
"911": "#ffb3b3",
"912": "#99e6b3",
"913": "#99e6b3",
"914": "#ff8800",
"916": "#99e6b3",
"917": "#ffeb3b",
"918": "#99e6b3",
"919": "#ff8800",
"921": "#99e6b3",

"1001": "#99e6b3",
"1002": "#ff8800",
"1004": "#99e6b3",
"1005": "#99e6b3",
"1007": "#ff8800",
"1008": "#ffeb3b",
"1009": "#99e6b3",
"1010": "#99e6b3",
"1011": "#ffb3b3",
"1012": "#99e6b3",
"1013": "#99e6b3",
"1014": "#ff8800",
"1016": "#99e6b3",
"1017": "#ffeb3b",
"1018": "#99e6b3",
"1019": "#ff8800",
"1021": "#99e6b3",

"1101": "#99e6b3",
"1102": "#ff8800",
"1104": "#99e6b3",
"1105": "#ff8800",
"1107": "#99e6b3",
"1108": "#ffeb3b",
"1109": "#99e6b3",
"1110": "#99e6b3",
"1111": "#ffb3b3",
"1112": "#99e6b3",
"1113": "#99e6b3",
"1114": "#ff8800",
"1116": "#99e6b3",
"1117": "#ffeb3b",
"1118": "#99e6b3",
"1119": "#ff8800",
"1121": "#99e6b3",

"1201" : "#cc99ff",
"1202" : "#ccccff",
"1203" : "#ccccff",
"1204" : "#ccccff",
"1205" : "#9933ff",
"1206" : "#ccccff",
"1207" : "#ccccff",
"1208" : "#ccccff",
"1209" : "#ccccff",
"1210" : "#ccccff",
"1211" : "#ccccff",
"1212" : "#ccccff",



};

const maxGuestsByType = {
  TP: 2,
  TS: 2,
  TR: 2,
  SM: 1,
  TD: 3,
  DS: 2,
  TMS: 2,
  TC: 2,
};

let currentRoomId = null;
let currentHotelId = null;

async function showLoading() {
  console.log('kokoni deteru')
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.remove("hidden");
  await new Promise(r => setTimeout(r, 50)); // ğŸ’¡ å¼·åˆ¶çš„ã«å†æç”»
}

function hideLoading() {
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.add("hidden");
}

let globalId = 1
let globalBlukMode = false


// const statusLabels = {
//   "available": "ç¢ºèªæ¸ˆï¼ˆä½¿ç”¨å¯èƒ½ï¼‰",
//   "occupied": "å®¿æ³Šä¸­",
//   "stayover": "é€£æ³Šä¸­",
//   "cleaning": "æ¸…æƒä¸­",
//   "dirty": "æ¸…æƒå‰",
//   "maintenance": "æ•…éšœãƒ»ç‚¹æ¤œä¸­",
//   "reserved": "äºˆç´„æ¸ˆ",
//   "outofservice": "ä½¿ç”¨åœæ­¢ä¸­",
//   "unavailable": "æœªä½¿ç”¨ãƒ»é–‰é–ä¸­"
// };
// const API_URL = "https://squid-app-ug7x6.ondigitalocean.app";
const API_URL = "https://squid-app-ug7x6.ondigitalocean.app"

const map = document.getElementById("map");
const legend = document.getElementById("legend");
const toggleLegendBtn = document.getElementById("toggleLegendBtn");
let selectedRoom = null;


let updateTimers = {}; // éƒ¨å±‹ã”ã¨ã«ã‚¿ã‚¤ãƒãƒ¼ä¿æŒ

function scheduleGuestCountUpdate(roomId, newCount) {
  // ã™ã§ã«ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚‹ãªã‚‰ãƒªã‚»ãƒƒãƒˆ
  if (updateTimers[roomId]) {
    clearTimeout(updateTimers[roomId]);
  }

  // 1ç§’å¾Œã«é€ä¿¡
  updateTimers[roomId] = setTimeout(() => {
    updateGuestCount(roomId,globalId, newCount);
    delete updateTimers[roomId];
  }, 1000);
}




// ================================
// ğŸ”¹ éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// ================================
async function loadRooms() {
  try {
    showLoading();
    const res = await fetch(`${API_URL}/api/room/status?hotel_id=${globalId}`);
    hideLoading();
    if (!res.ok) throw new Error("APIå–å¾—å¤±æ•—");

    const data = await res.json();
    const rooms = data.rooms || [];
    const grouped = groupByFloor(rooms);

    map.innerHTML = "";
    let totalGuestCount = 0;

    // ğŸŸ¢ å„roomè¦ç´ ã”ã¨ã«ã‚¯ãƒªãƒƒã‚¯ã‚¿ã‚¤ãƒãƒ¼ã‚’ç®¡ç†ã™ã‚‹WeakMap
    const clickTimers = new WeakMap();

    Object.keys(grouped)
      .sort((a, b) => b - a)
      .forEach((floor) => {
        const floorRooms = grouped[floor];
        let floorGuestCount = 0;

        const floorDiv = document.createElement("div");
        floorDiv.className = "floor";

        const floorHeader = document.createElement("div");
        floorHeader.className = "floor-header";

        const floorTitle = document.createElement("h3");
        floorTitle.textContent = `${floor}F`;

        const floorTotal = document.createElement("span");
        floorTotal.className = "floor-total";
        floorTotal.textContent = `ğŸ‘¥ ${floorGuestCount}`;

        floorHeader.appendChild(floorTitle);
        floorHeader.appendChild(floorTotal);
        floorDiv.appendChild(floorHeader);

        const roomsContainer = document.createElement("div");
        roomsContainer.className = "rooms";

        floorRooms.forEach((r) => {
          const room = document.createElement("div");
          room.className = `room room-${r.room_number} ${r.status} type-${r.room_type}`;
          room.dataset.room = r.room_number;
          room.dataset.status = r.status;
          room.dataset.id = r.id;
          room.dataset.guest_count = r.guest_count || 0;
          room.style.backgroundColor = getRoomColor(r);

          floorGuestCount += Number(r.guest_count || 0);

          room.innerHTML = `
            <div class="room-header ${r.stay_type !== "group" ? "group-border" : ""}">
              ${r.room_number}<br><small>${r.room_type || "-"}</small>
            </div>
            <div class="room-guest">
              <button class="guest-btn up">â–³</button>
              <span class="guest-count">${r.guest_count || 0}</span>
              <button class="guest-btn down">â–½</button>
            </div>
            <div class="room-status ${r.checkout_status === "after" ? "checkout-border" : ""}">
              ${icons[r.status] || "?"}
            </div>
          `;

          // ğŸ§© äººæ•°æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ
          const guestCountEl = room.querySelector(".guest-count");
          const upBtn = room.querySelector(".guest-btn.up");
          const downBtn = room.querySelector(".guest-btn.down");

          const updateDisplay = (newCount) => {
            guestCountEl.textContent = newCount;
            room.dataset.guest_count = newCount;
            scheduleGuestCountUpdate(r.id, newCount);
            updateTotals();
          };

          upBtn.addEventListener("click", (e) => {
            e.stopPropagation();

            const roomType = r.room_type; // â† éƒ¨å±‹ã‚¿ã‚¤ãƒ—å–å¾—
            const maxGuests = maxGuestsByType[roomType] || 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ2äºº

            let count = Number(room.dataset.guest_count);
            if (count >= maxGuests) {
              // alert(`âš ï¸ ${roomType}ã‚¿ã‚¤ãƒ—ã¯æœ€å¤§${maxGuests}åã¾ã§ã§ã™`);
              return;
            }

            updateDisplay(++count);
          });


          downBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            let count = Number(room.dataset.guest_count);
            if (count > 0) updateDisplay(--count);
          });

          // ================================
          // ğŸŸ¢ ã‚¯ãƒªãƒƒã‚¯ãƒ»ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å…±å­˜å‡¦ç†ï¼ˆWeakMapç‰ˆï¼‰
          // ================================
          room.addEventListener("click", (e) => {
            e.stopPropagation();
            currentRoomId = room.dataset.id;  // â† ã“ã‚Œã§éƒ¨å±‹ã®IDãŒå…¥ã‚‹
currentHotelId = room.dataset.hotel_id

            // æ—¢å­˜ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆå¤šé‡é˜²æ­¢ï¼‰
            if (clickTimers.has(room)) {
              clearTimeout(clickTimers.get(room));
            }

            const timer = setTimeout(() => {
              clickTimers.delete(room);

              // ğŸŸ¢ ä¸€æ‹¬é¸æŠãƒ¢ãƒ¼ãƒ‰
              if (bulkMode) {
                if (room.classList.contains("selected-bulk")) {
                  room.classList.remove("selected-bulk");
                  selectedRoomsBulk = selectedRoomsBulk.filter((r) => r !== room);
                } else {
                  room.classList.add("selected-bulk");
                  selectedRoomsBulk.push(room);
                }
                return;
              }

              // ğŸŸ£ é€šå¸¸ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
              selectedRoom = room;
              showActionModal(r);
            }, 250);

            clickTimers.set(room, timer);
          });

          // ğŸŸ£ ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹åˆ‡æ›¿ï¼‰
          room.addEventListener("dblclick", async (e) => {
            e.stopPropagation();

            if (e.target.closest(".guest-btn")) return;

            if (clickTimers.has(room)) {
              clearTimeout(clickTimers.get(room));
              clickTimers.delete(room);
            }

            const statusDiv = room.querySelector(".room-status");
            const prevStatus = r.checkout_status;
            const optimisticStatus = prevStatus === "after" ? "before" : "after";

            // ğŸ”¹ å…ˆã«å³æ™‚UIåæ˜ ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾…ãŸãªã„ï¼‰
            r.checkout_status = optimisticStatus;
            if (optimisticStatus === "after") {
              statusDiv.classList.add("checkout-border");
            } else {
              statusDiv.classList.remove("checkout-border");
            }

            // ğŸ”¹ ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã‚‚å³æ™‚å‡ºã™
            const toast = document.createElement("div");
            toast.textContent =
              optimisticStatus === "after"
                ? "ğŸšª ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ¸ˆã«å¤‰æ›´ï¼ˆåæ˜ ä¸­...ï¼‰"
                : "ğŸ  ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸­ã«å¤‰æ›´ï¼ˆåæ˜ ä¸­...ï¼‰";
            toast.className = "toast";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1500);

            // ğŸ”¹ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ›´æ–°
            const newStatus = await toggleCheckoutStatus(r.id);

            // ğŸ”¹ æˆåŠŸ or å¤±æ•—ã®ç¢ºå®šå‡¦ç†
            if (!newStatus) {
              // âŒ å¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
              r.checkout_status = prevStatus;
              if (prevStatus === "after") {
                statusDiv.classList.add("checkout-border");
              } else {
                statusDiv.classList.remove("checkout-border");
              }
              const failToast = document.createElement("div");
              failToast.textContent = "âš ï¸ æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ";
              failToast.className = "toast error";
              document.body.appendChild(failToast);
              setTimeout(() => failToast.remove(), 2000);
            } else {
              // âœ… æˆåŠŸæ™‚ã®ç¢ºå®šè¡¨ç¤º
              const okToast = document.createElement("div");
              okToast.textContent =
                newStatus === "after"
                  ? "âœ… ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ¸ˆã«ç¢ºå®š"
                  : "âœ… ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸­ã«ç¢ºå®š";
              okToast.className = "toast";
              document.body.appendChild(okToast);
              setTimeout(() => okToast.remove(), 1500);
            }
          });


          // ğŸ–±ï¸ å³ã‚¯ãƒªãƒƒã‚¯ï¼ˆæ»åœ¨ã‚¿ã‚¤ãƒ—åˆ‡æ›¿ï¼‰
          room.addEventListener("contextmenu", async (e) => {
            e.preventDefault();

            const header = room.querySelector(".room-header");
            const originalType = r.stay_type; // å…ƒã®çŠ¶æ…‹ã‚’ä¿æŒ
            const isCurrentlyGroup = originalType === "group";

            // âœ… å³æ™‚è¦‹ãŸç›®åæ˜ ï¼ˆUXå‘ä¸Šï¼‰
            if (isCurrentlyGroup) {
              header.classList.remove("group-border");
              r.stay_type = "individual";
            } else {
              header.classList.add("group-border");
              r.stay_type = "group";
            }

            // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼ˆä»®ã®å¤‰æ›´ã‚’ä¼ãˆã‚‹ï¼‰
            const toast = document.createElement("div");
            toast.textContent = isCurrentlyGroup ? "ğŸ‘¤ å€‹åˆ¥ã«å¤‰æ›´ä¸­..." : "ğŸ‘¥ ã‚°ãƒ«ãƒ¼ãƒ—ã«å¤‰æ›´ä¸­...";
            toast.className = "toast";
            document.body.appendChild(toast);

            try {
              const newType = await toggleStayType(r.id, r.hotel_id);
              if (!newType) throw new Error("åˆ‡æ›¿å‡¦ç†ã«å¤±æ•—");

              // âœ… æˆåŠŸæ™‚ï¼šãƒˆãƒ¼ã‚¹ãƒˆæ›´æ–°
              toast.textContent = newType === "group" ? "ğŸ‘¥ ã‚°ãƒ«ãƒ¼ãƒ—ã«å¤‰æ›´ã—ã¾ã—ãŸ" : "ğŸ‘¤ å€‹åˆ¥ã«å¤‰æ›´ã—ã¾ã—ãŸ";
              r.stay_type = newType;

            } catch (err) {
              console.error("æ»åœ¨ã‚¿ã‚¤ãƒ—åˆ‡æ›¿å¤±æ•—:", err);

              // âŒ å¤±æ•—æ™‚ï¼šè¦‹ãŸç›®ã‚’å…ƒã«æˆ»ã™
              if (isCurrentlyGroup) {
                header.classList.add("group-border");
                r.stay_type = "group";
              } else {
                header.classList.remove("group-border");
                r.stay_type = "individual";
              }

              toast.textContent = "âš ï¸ åˆ‡æ›¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
            }

            // 2ç§’å¾Œã«ãƒˆãƒ¼ã‚¹ãƒˆå‰Šé™¤
            setTimeout(() => toast.remove(), 2000);
          });



          // DOMã¸è¿½åŠ 
          roomsContainer.appendChild(room);
        });

        floorTotal.textContent = `ãŠå®¢æ§˜äººæ•°ï¼š ${floorGuestCount}äºº`;
        floorDiv.appendChild(roomsContainer);
        map.appendChild(floorDiv);
        totalGuestCount += floorGuestCount;
      });

    // âœ… å…¨ä½“äººæ•°æ›´æ–°
    updateHeaderTotal(totalGuestCount);

    function updateTotals() {
      let newTotal = 0;
      document.querySelectorAll(".floor").forEach((floorDiv) => {
        const guestEls = floorDiv.querySelectorAll(".guest-count");
        let floorSum = 0;
        guestEls.forEach((el) => (floorSum += Number(el.textContent.replace("ğŸ‘¤", ""))));
        const totalEl = floorDiv.querySelector(".floor-total");
        if (totalEl) totalEl.innerHTML = `ãŠå®¢æ§˜äººæ•°:${floorSum}`;
        newTotal += floorSum;
      });
      updateHeaderTotal(newTotal);
    }
  } catch (err) {
    console.error("âŒ éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    map.innerHTML = `<p style="color:red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
  }
}



async function toggleStayType(roomId) {
  try {
    const res = await fetch(`${API_URL}/api/room/${roomId}/stay_type`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hotel_id: globalId }),
    });

    const data = await res.json();
    if (data.success) {
      console.log("âœ… stay_type æ›´æ–°:", data.newType);
      return data.newType;
    } else {
      console.warn("âš ï¸ stay_type æ›´æ–°å¤±æ•—:", data.error);
      return null;
    }
  } catch (err) {
    console.error("âŒ stay_type æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
    return null;
  }
}

async function toggleCheckoutStatus(roomId) {
  try {
    const res = await fetch(`${API_URL}/api/room/${roomId}/checkout_status`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hotel_id: globalId  }),
    });

    const data = await res.json();
    if (data.success) {
      console.log("âœ… ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ›´æ–°:", data.newStatus);
      return data.newStatus;
    } else {
      console.warn("âš ï¸ æ›´æ–°å¤±æ•—:", data.error);
      return null;
    }
  } catch (err) {
    console.error("âŒ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
    return null;
  }
}



// ğŸ”§ Headerã«ç·äººæ•°ã‚’è¡¨ç¤º
function updateHeaderTotal(total) {
  const header = document.querySelector("header");
  if (!header) return;
  let totalEl = header.querySelector(".total-guests");
  if (!totalEl) {
    totalEl = document.createElement("span");
    totalEl.className = "total-guests";
    header.appendChild(totalEl);
  }
  totalEl.textContent = `ç·ãŠå®¢æ§˜äººæ•°: ${total}äºº`;
}


// ğŸ”§ DBæ›´æ–°APIå‘¼ã³å‡ºã—
async function updateGuestCount(roomId, hotelId, newCount) {
  try {
    console.log(hotelId)
    await fetch(`${API_URL}/api/room/${roomId}/guest_count`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        hotel_id: hotelId,
        guest_count: newCount,
      }),
    });
  } catch (err) {
    console.error("äººæ•°æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
  }
}




// ================================
// ğŸ”¹ ãƒ•ãƒ­ã‚¢ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
// ================================
function groupByFloor(rooms) {
  const grouped = {};
  for (const r of rooms) {
    const f = Number(r.floor);
    if (!grouped[f]) grouped[f] = [];
    grouped[f].push(r);
  }
  return grouped;
}

// ================================
// ğŸ”¹ è‰²è¨­å®š
// ================================
function getRoomColor(r) {
  const defaultColors = {
    "SM": "#e6f7e6",
    "SMS": "#e6f7e6",
    "TM": "#fff6cc",
    "TMS": "#fff6cc",
    "TD": "#ffeacc",
    "TDS": "#ffeacc",
    "TS": "#f2e6ff",
    "TP":"#d9b3ff",
    "TC": "#e6f2ff",
    "DS": "#ffe6e6",
    "DSS":"#ffe6e6",
    "TR":"#a64dff"
  };
  return defaultColors[r.room_type] || "#eee";
}

// ================================
// ğŸ”¹ å‡¡ä¾‹åˆ‡ã‚Šæ›¿ãˆ
// ================================
toggleLegendBtn.addEventListener("click", () => {
  legend.classList.toggle("hidden");
  toggleLegendBtn.textContent = legend.classList.contains("hidden") ? "å‡¡ä¾‹è¡¨ç¤º" : "å‡¡ä¾‹éè¡¨ç¤º";
});

// ================================
// ğŸ”¹ ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
// ================================
const actionModal = document.getElementById("actionModal");
const statusModal = document.getElementById("statusModal");
const statusGrid = document.getElementById("statusGrid");
const statusChangeBtn = document.getElementById("statusChangeBtn");
const closeButtons = document.querySelectorAll(".close-btn");
let currentRoom = null;

// ã€Œéƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€ã‚’æŠ¼ã—ãŸæ™‚
statusChangeBtn.addEventListener("click", () => {
  closeModal(actionModal);
  openModal(statusModal);
  renderStatusOptions();
});

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ã‚’æç”»
function renderStatusOptions() {
  statusGrid.innerHTML = "";

  Object.entries(icons).forEach(([key, icon]) => {
    console.log(key)

if(key==='before_check'){
  return
}

    if ((key === 'checkOut' || key === 'singleGuest') && !bulkMode) {

      console.log('kokoknikiteru')
      return
    }
    const div = document.createElement("div");
    div.className = "status-option";
    div.innerHTML = `
      <span>${icon}</span>
      <small>${statusLabels[key] || key}</small>
    `;

    div.onclick = async () => {
      // ğŸ”¸ é€šå¸¸å‡¦ç†ï¼ˆå˜ä½“å¤‰æ›´ï¼‰
      if (!bulkMode) {
        if (!selectedRoom) {
          alert("âš ï¸ éƒ¨å±‹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }

        selectedRoom.dataset.status = key;
        selectedRoom.querySelector(".room-status").innerHTML = icon;
        selectedRoom.className = `room room-${selectedRoom.dataset.room} ${key}`;

        try {
          showLoading();

          const res = await fetch("https://squid-app-ug7x6.ondigitalocean.app/api/room/status", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              room_id: selectedRoom.dataset.id,
              status: key,
            }),
          });

          hideLoading();
          const result = await res.json();
          if (result.success) {
            console.log("âœ… æ›´æ–°æˆåŠŸ:", result.message);
          } else {
            console.warn("âš ï¸ æ›´æ–°å¤±æ•—:", result.error);
          }
        } catch (err) {
          hideLoading();
          console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
        }

        closeModal(statusModal);
        return;
      }

      // ğŸ”¸ ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰å‡¦ç†
      if (bulkMode && selectedRoomsBulk.length > 0) {
        const confirmChange = confirm(
          `é¸æŠã•ã‚ŒãŸ ${selectedRoomsBulk.length} éƒ¨å±‹ã‚’ã€Œ${statusLabels[key]}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`
        );
        if (!confirmChange) return;

        showLoading();

        for (const roomEl of selectedRoomsBulk) {

          console.log(roomEl)


console.log(key)

if(key==='checkOut'){
  try {
    const statusDiv = roomEl.querySelector(".room-status");
    statusDiv.classList.add('checkout-border');
    await fetch("https://squid-app-ug7x6.ondigitalocean.app/api/room/status/checkOut/after", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room_id: roomEl.dataset.id,
        status: key,
      }),
    });
  } catch (err) {
    console.error(`âŒ ${roomEl.dataset.room} æ›´æ–°å¤±æ•—`, err);
  }
}else if(key==='singleGuest'){
  console.log('kokoni')
changeGroupOrSingle('individual', roomEl)
}else if(key==='groupe'){
  console.log('koko2')
  changeGroupOrSingle('group', roomEl)
}else{
  roomEl.dataset.status = key;

  const statusDiv = roomEl.querySelector(".room-status");
  if (statusDiv) statusDiv.innerHTML = icon;
  // ç¾åœ¨ã®ã‚¯ãƒ©ã‚¹ã‚’ç¶­æŒã—ã¦ã€statusã ã‘ä¸Šæ›¸ã
const currentClasses = roomEl.className.split(" ").filter(c => !Object.keys(icons).includes(c));
roomEl.className = [...currentClasses, key].join(" ");
  try {
    await fetch("https://squid-app-ug7x6.ondigitalocean.app/api/room/status", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room_id: roomEl.dataset.id,
        status: key,
      }),
    });
  } catch (err) {
    console.error(`âŒ ${roomEl.dataset.room} æ›´æ–°å¤±æ•—`, err);
  }
}

        }

        hideLoading();
        alert(`âœ… ${selectedRoomsBulk.length} éƒ¨å±‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`);

        // ãƒ¢ãƒ¼ãƒ‰è§£é™¤ã¨é¸æŠè§£é™¤
        selectedRoomsBulk.forEach((r) => r.classList.remove("selected-bulk"));
        selectedRoomsBulk = [];
        bulkMode = false;
        const bulkBtn = document.getElementById("bulkModeBtn");
        if (bulkBtn) {
          bulkBtn.classList.remove("active");
          bulkBtn.textContent = "ğŸ§© ä¸€æ‹¬ç™»éŒ²";
        }

        closeModal(statusModal);
        return;
      }

      // ğŸ”¸ ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰ãªã®ã«é¸æŠãŒãªã„å ´åˆ
      if (bulkMode && selectedRoomsBulk.length === 0) {
        alert("âš ï¸ ä¸€æ‹¬å¤‰æ›´å¯¾è±¡ã®éƒ¨å±‹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    };

    statusGrid.appendChild(div);
  });
}


async function changeGroupOrSingle(status, roomEl){
  console.log(status)

  try {
    const statusDiv = roomEl.querySelector(".room-header");
    if(status==='individual'){
          statusDiv.classList.add('group-border');
    }else{
          statusDiv.classList.remove('group-border');
    }


    // https://squid-app-ug7x6.ondigitalocean.app
    await fetch("https://squid-app-ug7x6.ondigitalocean.app/api/room/status/singleGuest", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room_id: roomEl.dataset.id,
        status,
      }),
    });
  } catch (err) {
    console.error(`âŒ ${roomEl.dataset.room} æ›´æ–°å¤±æ•—`, err);
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰é–¢æ•°
function openModal(modal) { modal.style.display = "flex"; }
function closeModal(modal) { modal.style.display = "none"; }
closeButtons.forEach(btn => btn.onclick = () => closeModal(btn.closest(".modal")));
window.onclick = (e) => {
  if (e.target.classList.contains("modal")) closeModal(e.target);
};


// ============================
// ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ï¼ˆäº¤æ›ãƒ»è£œå……ãƒ»å›åï¼‰
// ============================

const amenityBtn = document.getElementById("amenityBtn");
const amenityTypeModal = document.getElementById("amenityTypeModal");
// const amenityModal = document.getElementById("amenityModal");
const amenityGrid = document.getElementById("amenityGrid");
const returnModal = document.getElementById("returnModal");
// const returnFrontBtn = document.getElementById("returnFrontBtn");
const returnStorageBtn = document.getElementById("returnStorageBtn");

let selectedAmenity = null;
let selectedAmenityType = null;

// ğŸ”¸ ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
amenityBtn.disabled = false;

// ğŸ”¸ ã€Œã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ãƒ»ä»–ä¾é ¼ã€ã‚¯ãƒªãƒƒã‚¯ â†’ ç¨®é¡é¸æŠã¸
amenityBtn.addEventListener("click", () => {
  closeModal(actionModal);
  openModal(amenityTypeModal);
});

// ğŸ”¸ äº¤æ›ï¼è£œå……ï¼å›åãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
document.querySelectorAll(".amenity-type-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    selectedAmenityType = btn.dataset.type;
    closeModal(amenityTypeModal);
    openModal(amenityModal);
    renderAmenityOptions();
  });
});

// ğŸ”¸ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¸€è¦§
const amenities = [
  "ã¾ãã‚‰",
  "ãƒãƒ³ã‚¬ãƒ¼",
  "å……é›»å™¨",
  "æ‰‡é¢¨æ©Ÿ",
  "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«",
  "å»¶é•·ã‚³ãƒ¼ãƒ‰",
  "åŠ æ¹¿å™¨",
  "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ"
];

function renderAmenityOptions() {
  amenityGrid.innerHTML = "";
  amenities.forEach(item => {
    const div = document.createElement("div");
    div.className = "status-option";
    div.innerHTML = `<span></span><small>${item}</small>`;

    div.onclick = async () => {
      selectedAmenity = item;
      closeModal(amenityModal);

      // âœ… æ¡ä»¶åˆ†å²ï¼šäº¤æ› or å›å â†’ è¿”å´å…ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      if (selectedAmenityType === "äº¤æ›" || selectedAmenityType === "å›å") {
        openModal(returnModal);
      }
      // âœ… è£œå…… â†’ è¿”å´å…ˆãªã—ã§å³ç™»éŒ²
      else if (selectedAmenityType === "è£œå……") {
        const payload = {
          room_id: selectedRoom.dataset.id,
          action_type: selectedAmenityType,
          amenity: selectedAmenity
        };
        try {
          showLoading();
          const res = await fetch("https://squid-app-ug7x6.ondigitalocean.app/api/room/amenity", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const result = await res.json();
          hideLoading();
          if (result.success) {
            alert(`éƒ¨å±‹ ${selectedRoom.dataset.room}ï¼š${selectedAmenity} ã®ã€Œè£œå……ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
          } else {
            alert(`âš ï¸ ç™»éŒ²å¤±æ•—: ${result.error}`);
          }
        } catch (err) {
          hideLoading();
          console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
        }
        // ãƒªã‚»ãƒƒãƒˆ
        selectedAmenity = null;
        selectedAmenityType = null;
      }
    };

    amenityGrid.appendChild(div);
  });
}



// ğŸ”¸ è¿”å´å…ˆé¸æŠ
async function handleReturnToDisnation(location) {
  if (!selectedRoom || !selectedAmenityType || !selectedAmenity) return;

  const payload = {
    room_id: selectedRoom.dataset.id,
    action_type: selectedAmenityType,  // äº¤æ›ï¼è£œå……ï¼å›å
    amenity: selectedAmenity,
    return_to: location
  };

  try {
    showLoading()
    const res = await fetch("https://squid-app-ug7x6.ondigitalocean.app/api/room/amenity", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    hideLoading();
    if (result.success) {
      alert(`éƒ¨å±‹ ${selectedRoom.dataset.room}ï¼š${selectedAmenity} ã®ã€Œ${selectedAmenityType}ã€ã‚’ ${location} ã«ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
    } else {
      alert(`âš ï¸ ç™»éŒ²å¤±æ•—: ${result.error}`);
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
  }

  // ãƒªã‚»ãƒƒãƒˆ
  selectedAmenity = null;
  selectedAmenityType = null;
  closeModal(returnModal);
}

// ãƒ•ãƒ­ãƒ³ãƒˆãƒœã‚¿ãƒ³
const returnFrontBtn = document.getElementById("returnFrontBtn");
if (returnFrontBtn) {
  returnFrontBtn.addEventListener("click", () => handleReturnToDisnation("ãƒ•ãƒ­ãƒ³ãƒˆ"));
}

// 4Fã€œ12Fãƒªãƒãƒ³åº«ãƒœã‚¿ãƒ³
document.querySelectorAll(".linen-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const floor = btn.dataset.floor;
    handleReturnToDisnation(`${floor}Fãƒªãƒãƒ³åº«`);
  });
});

// å…±é€šå‡¦ç†é–¢æ•°
// function handleReturn(destination) {
//   console.log(`ğŸ“¦ ${destination} ã«æˆ»ã—ã¾ã™`);
//   // ã“ã“ã«å®Ÿéš›ã®å‡¦ç†ã‚’è¿½åŠ ï¼ˆä¾‹ï¼šAPIå‘¼ã³å‡ºã—ã€çŠ¶æ…‹æ›´æ–°ãªã©ï¼‰
//   handleReturn(destination)
// }


console.log('yes')

const roomDetailModal = document.getElementById("roomDetailModal");
const saveRoomDetailBtn = document.getElementById("saveRoomDetailBtn");
const guestNameInput = document.getElementById("guestName");
const checkoutTimeInput = document.getElementById("checkoutTime");
const guestCountInput = document.getElementById("guestCount");
const notesInput = document.getElementById("notes");

// é–‹ãå‡¦ç†
function openRoomDetailModal(roomElement) {
  const modal = document.getElementById("roomDetailModal");

  // datasetã‹ã‚‰æƒ…å ±ã‚’å–å¾—
  document.getElementById("guestName").value = roomElement.dataset.guest_name || "";
  document.getElementById("checkoutTime").value = roomElement.dataset.checkout_time || "";
  document.getElementById("guestCount").value = roomElement.dataset.guest_count || "";
  document.getElementById("notes").value = roomElement.dataset.notes || "";

  openModal(roomDetailModal);
}

// ä¿å­˜å‡¦ç†
saveRoomDetailBtn.addEventListener("click", async () => {
  const payload = {
    room_id: selectedRoom.dataset.id,
    guest_name: guestNameInput.value,
    checkout_time: checkoutTimeInput.value,
    guest_count: guestCountInput.value,
    notes: notesInput.value
  };

  try {
    showLoading();
    const res = await fetch("https://squid-app-ug7x6.ondigitalocean.app/api/room/details", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    hideLoading();

    if (result.success) {
      alert("ğŸ’¾ éƒ¨å±‹æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
      // datasetã‚’æ›´æ–°ï¼ˆå†è¡¨ç¤ºç”¨ï¼‰
      selectedRoom.dataset.guestName = payload.guest_name;
      selectedRoom.dataset.checkoutTime = payload.checkout_time;
      selectedRoom.dataset.guestCount = payload.guest_count;
      selectedRoom.dataset.notes = payload.notes;
    } else {
      alert(`âš ï¸ æ›´æ–°å¤±æ•—: ${result.error}`);
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
  }

  closeModal(roomDetailModal);
});

const amenityListBtn = document.getElementById("amenityListBtn");
const amenityListModal = document.getElementById("amenityListModal");
const amenityListBody = document.getElementById("amenityListBody");

// ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
amenityListBtn.addEventListener("click", () => {
  openModal(amenityListModal);
  loadAmenityRequests();
});

// ä¾é ¼ä¸€è¦§ã‚’å–å¾—
async function loadAmenityRequests() {
  try {
    showLoading();
    const res = await fetch("https://squid-app-ug7x6.ondigitalocean.app/api/room/amenity/list"); // â† æ–°API
    hideLoading();
    if (!res.ok) throw new Error("APIå–å¾—å¤±æ•—");

    const data = await res.json();
    const list = data.requests || [];

    amenityListBody.innerHTML = "";

    if (list.length === 0) {
      amenityListBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
      return;
    }

    list.forEach(req => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${req.room_number}</td>
        <td>${req.amenity}</td>
        <td>${req.action_type}</td>
        <td>${req.return_to || "-"}</td>
        <td>${new Date(req.created_at).toLocaleString("ja-JP")}</td>
        <td><button onclick="completeAmenity(${req.id})">å®Œäº†</button></td>
      `;
      amenityListBody.appendChild(tr);
    });
  } catch (err) {
    hideLoading();
    console.error("âŒ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¸€è¦§ã‚¨ãƒ©ãƒ¼:", err);
    amenityListBody.innerHTML = `<tr><td colspan="6" style="color:red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>`;
  }
}

// å®Œäº†å‡¦ç†ï¼ˆå‰Šé™¤ï¼‰
async function completeAmenity(id) {
  if (!confirm("ã“ã®ä¾é ¼ã‚’å®Œäº†ã¨ã—ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  try {
    showLoading();
    const res = await fetch(`https://squid-app-ug7x6.ondigitalocean.app/api/room/amenity/${id}`, {
      method: "DELETE"
    });
    const result = await res.json();
    hideLoading();

    if (result.success) {
      alert("âœ… å®Œäº†ã—ã¾ã—ãŸï¼");
      loadAmenityRequests(); // å†èª­è¾¼
    } else {
      alert("âš ï¸ å‰Šé™¤å¤±æ•—: " + result.error);
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", err);
  }
}
function showActionModal(roomData) {
  const modal = document.getElementById("actionModal");
  const closeBtn = modal.querySelector(".close-btn");
  const statusBtn = modal.querySelector("#statusChangeBtn");
  const amenityBtn = modal.querySelector("#amenityBtn");

  // è¡¨ç¤º
  modal.style.display = "flex";



  // é–‰ã˜ã‚‹å‡¦ç†
  closeBtn.onclick = () => (modal.style.display = "none");
  modal.onclick = (e) => {
    if (e.target.id === "actionModal") modal.style.display = "none";
  };

  // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  // statusBtn.onclick = () => {
  //   console.log(`ğŸŸ¢ ${roomData.room_number} éƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´`);
  //   modal.style.display = "none";
  //   // â†’ ã“ã“ã«åˆ¥ã®ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ãå‡¦ç†ãªã©ã‚’è¿½åŠ å¯
  // };

  amenityBtn.onclick = () => {
    console.log(`ğŸ§´ ${roomData.room_number} ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼`);
    modal.style.display = "none";
    // â†’ ã“ã“ã§ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©ã‚’é–‹ãå‡¦ç†ã¸
  };
}

let bulkMode = false;
let selectedRoomsBulk = [];

const bulkChangeBtn = document.getElementById("bulkChangeBtn");

// ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
document.getElementById("bulkModeBtn").addEventListener("click", (e) => {
  bulkMode = !bulkMode;
  selectedRoomsBulk = [];

  e.target.classList.toggle("active", bulkMode);
  e.target.textContent = bulkMode ? "âœ… é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­" : "ğŸ§© ä¸€æ‹¬ç™»éŒ²";
  document.querySelectorAll(".room").forEach((room) => {
    room.classList.remove("selected-bulk");
  });

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹/ç„¡åŠ¹
  bulkChangeBtn.disabled = !bulkMode;
});

// âœ… ã€ŒğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
bulkChangeBtn.addEventListener("click", () => {
  if (!bulkMode) return;
  if (selectedRoomsBulk.length === 0) {
    alert("âš ï¸ ä¸€æ‹¬å¤‰æ›´ã™ã‚‹éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  openModal(statusModal);
  renderStatusOptions(); // â† ã“ã“ã§ä¸€æ‹¬å¤‰æ›´å‡¦ç†ãŒå‹•ãï¼ï¼
});

document.getElementById("importExcelBtn").addEventListener("click", () => {
  document.getElementById("excelUpload").click();
});

document.getElementById("excelUpload").addEventListener("change", handleExcelUpload);

async function handleExcelUpload(e) {
  const file = e.target.files[0];
  if (!file) return;

  showLoading();

  try {
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    // ğŸ”¹ Aåˆ—ï¼ˆéƒ¨å±‹ç•ªå·ï¼‰ï¼‹Eåˆ—ï¼ˆæ¸…æƒçŠ¶æ…‹ï¼‰æŠ½å‡º
    const result = [];
    const guestUpdateList = {}; // â† é…åˆ—ã§ã¯ãªãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã™ã‚‹
    const updateToRenpaku = []

    for (let i = 5; i < json.length; i++) {
      const row = json[i];
      const roomNoRaw = row[0];
      const status = row[4];     // Eåˆ—ï¼ˆæ¸…æƒçŠ¶æ…‹ï¼‰
      const guestCount = row[5] ?? 0; // Fåˆ—ï¼ˆäººæ•°ï¼‰
      const renpakuFlag = row[3];     // Dåˆ—ï¼ˆé€£æ³Šãƒ•ãƒ©ã‚°ï¼‰

      if (!roomNoRaw || !status) continue;

      const roomNo = String(roomNoRaw)
        .replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xfee0))
        .replace(/\s/g, "")
        .padStart(4, "0");

        // âœ… äººæ•°æ›´æ–°ãƒªã‚¹ãƒˆ
        guestUpdateList[roomNo] = Number(guestCount) || 0;

      // âœ… æ¸…æƒæ¸ˆã¿ï¼ˆã¾ãŸã¯ç©ºæ¬„ï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—
      if (status !== "æœªæ¸…æƒ") continue;

      // âœ… æœªæ¸…æƒã®ã¿å¯¾è±¡
      if (renpakuFlag === "S") {
        result.push({ roomNo, newStatus: "stay_clean" });
      } else {
        result.push({ roomNo, newStatus: "need_clean" });
      }


    }





    console.log(`result`,result)
    console.log(`guetsUpdateList`,guestUpdateList)

    if (result.length === 0) {
      hideLoading();
      alert("æœªæ¸…æƒã®éƒ¨å±‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const ok = confirm(`ğŸ§¹ æœªæ¸…æƒã® ${result.length} éƒ¨å±‹ã‚’ä¸€æ‹¬ã§ã€Œè¦æ¸…æƒã€ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ`);
    if (!ok) {
      hideLoading();
      return;
    }

    const roomsOnMap = document.querySelectorAll(".room");
    const updatePayload = [];

    for (const room of roomsOnMap) {
      const roomNo = String(room.dataset.room || "")
        .replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xfee0))
        .replace(/\s/g, "")
        .padStart(4, "0");

      const match = result.find(r => r.roomNo === roomNo);
      if (!match) continue;

      const newStatus = match.newStatus;

      room.dataset.status = newStatus;
      room.classList.remove("need_clean", "clean", "checked", "stay", "group-border", "checkout-border");

      const statusDiv = room.querySelector(".room-status");
      if (statusDiv) statusDiv.innerHTML = icons[newStatus];
      room.classList.add(newStatus);

      updatePayload.push({
        room_id: room.dataset.id,
        room_number: roomNo,
        status: newStatus,
        guest_count: guestUpdateList[roomNo] || 0,
      });
    }



    if (updatePayload.length === 0) {
      hideLoading();
      alert("å¯¾è±¡ã®éƒ¨å±‹ãŒãƒãƒƒãƒ—ä¸Šã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return;
    }

console.log('updatePayload',updatePayload)
    // âœ… APIå‘¼ã³å‡ºã—
    const res = await fetch("https://squid-app-ug7x6.ondigitalocean.app/api/room/status/bulk", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
          updates: updatePayload,           // â† å¾“æ¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
          updateGuestList: guestUpdateList  // â† æ–°è¦ï¼šå…¨å®¤ã®äººæ•°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        }),

    });

    const resultJson = await res.json();
    hideLoading();

    if (resultJson.success) {
      alert(`âœ… ${resultJson.updated} éƒ¨å±‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸€æ‹¬æ›´æ–°ã—ã¾ã—ãŸï¼`);

      // ğŸ”„ æˆåŠŸå¾Œã«ç”»é¢ã‚’å†ç”Ÿæˆ
      await loadRooms(); // â† å†æç”»ã§å…¨æƒ…å ±ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    } else {
      alert("âš ï¸ ä¸€æ‹¬æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ Excelè§£æã‚¨ãƒ©ãƒ¼:", err);
    alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
}


document.getElementById("exportStatusBtn").addEventListener("click", exportRoomStatus);

function exportRoomStatus() {
  const rooms = document.querySelectorAll(".room");
  if (!rooms.length) {
    alert("éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  const data = [];

  rooms.forEach(room => {
    const roomNumber = room.dataset.room;
    const floor = room.closest(".floor")?.querySelector("h3")?.textContent?.replace("F", "") || "";
    const statusClass = Object.keys(icons).find(k => room.classList.contains(k)) || "ä¸æ˜";
    const stayType = room.querySelector(".room-header")?.classList.contains("group-border") ? "ã‚°ãƒ«ãƒ¼ãƒ—" : "å€‹åˆ¥";
    const checkoutStatus = room.querySelector(".room-status")?.classList.contains("checkout-border") ? "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ¸ˆ" : "æ»åœ¨ä¸­";
    const guestCount = room.dataset.guest_count || "0";

    data.push({
      éƒ¨å±‹ç•ªå·: roomNumber,
      éš: floor,
      ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: statusLabels[statusClass] || statusClass,
      æ»åœ¨ã‚¿ã‚¤ãƒ—: stayType,
      ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹: checkoutStatus,
      å®¿æ³Šäººæ•°: guestCount,
    });
  });

  // ğŸ”¹ Excel ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ä½œæˆ
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Room Status");

  // ğŸ”¹ æ—¥ä»˜å…¥ã‚Šãƒ•ã‚¡ã‚¤ãƒ«å
  const today = new Date().toISOString().slice(0, 10);
  const fileName = `room_status_${today}.xlsx`;

  XLSX.writeFile(wb, fileName);
}

function showBulkConfirmModal() {
  return new Promise((resolve) => {
    const modal = document.getElementById("bulkConfirmModal");
    modal.style.display = "flex";

    const okBtn = document.getElementById("bulkOkBtn");
    const cancelBtn = document.getElementById("bulkCancelBtn");

    const cleanup = (result) => {
      modal.style.display = "none";
      okBtn.onclick = null;
      cancelBtn.onclick = null;
      resolve(result);
    };

    okBtn.onclick = () => {
      cleanup({
        ok: true,
        updateStatus: document.getElementById("chkStatus").checked,
        updateGuest: document.getElementById("chkGuest").checked,
      });
    };

    cancelBtn.onclick = () => cleanup({ ok: false });
  });
}

const amenityModal = document.getElementById("amenityTypeModal");
const otherBtn = document.getElementById("otherRequestBtn");
const otherArea = document.getElementById("otherRequestArea");
const sendOtherBtn = document.getElementById("sendOtherRequestBtn");
const input = document.getElementById("otherRequestInput");

// ãã®ä»–ã®ä¾é ¼ã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
otherBtn.addEventListener("click", () => {
  otherArea.classList.toggle("hidden");
  input.focus();
});

// ğŸ“¨ ãã®ä»–ä¾é ¼é€ä¿¡å‡¦ç†
sendOtherBtn.addEventListener("click", async () => {
  const text = input.value.trim();
  if (!text) {
    alert("ä¾é ¼å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  try {
    showLoading()
    const res = await fetch(`${API_URL}/api/room/other-request`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room_id: currentRoomId,       // â† ç¾åœ¨ã®éƒ¨å±‹ID
        instruction: text             // â† å…¥åŠ›å†…å®¹
      }),
    });

hideLoading()

    if (res.ok) {
      alert("ä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
      input.value = "";
      otherArea.classList.add("hidden");
      amenityModal.style.display = "none";
    } else {
      alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  } catch (err) {
    console.error(err);
    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
  }
});

// âœ– ãƒœã‚¿ãƒ³ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å‡¦ç†
const closeAmenityModalBtn = document.querySelector(".close-btn-amenity-modal");
// const amenityModal = document.getElementById("amenityTypeModal");

closeAmenityModalBtn.addEventListener("click", () => {
  amenityModal.style.display = "none";
  // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.getElementById("otherRequestArea").classList.add("hidden");
  document.getElementById("otherRequestInput").value = "";
});

const masterBtn = document.getElementById("masterBtn");
const otherModal = document.getElementById("otherRequestListModal");
const otherBody = document.getElementById("otherRequestBody");

// âš™ï¸ ä»–æŒ‡ç¤ºä¸€è¦§ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å–å¾—ï¼†è¡¨ç¤º
masterBtn.addEventListener("click", async () => {
  console.log(currentHotelId)
  otherModal.style.display = "flex";
  otherBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>`;

  try {
    const res = await fetch(`${API_URL}/api/room/other-request/list?hotel_id=${globalId}`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      otherBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">ãã®ä»–ã®ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
      return;
    }

    // è¡¨çµ„ã¿ç”Ÿæˆ
    otherBody.innerHTML = "";
    data.forEach((r) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${r.floor || "-"}</td>
        <td>${r.room_number || "-"}</td>
        <td style="text-align:left; white-space:pre-wrap;">
          ${r.notes.replace(/ğŸ“/g, "ğŸ“ ")}
          <button class="delete-btn" data-id="${r.id}">ğŸ—‘å‰Šé™¤</button>
        </td>
        <td>${r.updated_at ? new Date(r.updated_at).toLocaleString("ja-JP") : "-"}</td>
      `;

      otherBody.appendChild(tr);
    });

    // ğŸ—‘å‰Šé™¤ãƒœã‚¿ãƒ³å‡¦ç†
    otherBody.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const id = btn.dataset.id;

        if (!confirm("ã“ã®éƒ¨å±‹ã®ã€ãã®ä»–ä¾é ¼ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
          const res = await fetch(`${API_URL}/api/room/other-request/${id}`, {
            method: "DELETE"
          });

          const result = await res.json();

          if (res.ok) {
            alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
            btn.closest("tr").remove(); // ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å‰Šé™¤
          } else {
            alert(result.error || "å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        } catch (err) {
          console.error(err);
          alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
      });
    });


  } catch (err) {
    console.error(err);
    otherBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>`;
  }
});

// âœ– é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
otherModal.querySelector(".close-btn").addEventListener("click", () => {
  otherModal.style.display = "none";
});

// èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚é–‰ã˜ã‚‹
otherModal.addEventListener("click", (e) => {
  if (e.target === otherModal) {
    otherModal.style.display = "none";
  }
});




// ================================
// ğŸš€ åˆæœŸåŒ–
// ================================
loadRooms();
</script>
</body>
</html>
