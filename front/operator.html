<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operator Tasks</title>
<link rel="stylesheet" href="./operator.css">

</head>
<body>
  <header>
    <select id="langSelect">
      <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
      <option value="pt">ğŸ‡§ğŸ‡· PortuguÃªs</option>
      <option value="en">ğŸ‡ºğŸ‡¸ English</option>
      <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>

    </select>
    <span id="headerTitle">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚¿ã‚¹ã‚¯</span>
    <button id="refreshBtn">ğŸ”„ æ›´æ–°</button>
  </header>

  <!-- ğŸŸ¢ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢è¿½åŠ  -->
  <div id="filterBar" style="display:flex;justify-content:center;align-items:center;gap:10px;padding:8px 0;background:#eef3f8;">
    <select id="floorSelect" style="padding:6px 10px;border-radius:8px;border:1px solid #ccc;">
      <option value="all">å…¨ãƒ•ãƒ­ã‚¢</option>
      <option value="4">4F</option>
      <option value="5">5F</option>
      <option value="6">6F</option>
      <option value="7">7F</option>
      <option value="8">8F</option>
      <option value="9">9F</option>
      <option value="10">10F</option>
      <option value="11">11F</option>
      <option value="12">12F</option>
    </select>
    <div id="summaryContainer">
      <div id="cleansRooms" class="summary-box"></div>
      <div id="cleansRoomsInitial" class="summary-box"></div>
    </div>

    <button id="btnShowCleaning" style='display:none' class="filter-btn active">ğŸ§¹ æ¸…æƒ</button>
    <button id="btnShowAmenity" style='display:none'  class="filter-btn">ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£</button>
  </div>


  <div id="taskContainer"></div>

  <!-- ğŸ”¥ è¦³å¯Ÿãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="observModal" class="hidden">
    <div class="observ-content">
      <h3 id="observModalTitle"></h3>

      <div id="observText"></div>

      <button id="observDoneBtn" class="observ-done-btn"></button>
      <button id="observCloseBtn" class="observ-close-btn"></button>
    </div>
  </div>




<div id="loadingOverlay">
  <div class="loader"></div>
  <div id="loadingText">Loading...</div>
</div>

<script>

const API_URL = `https://squid-app-ug7x6.ondigitalocean.app`
// https://squid-app-ug7x6.ondigitalocean.app
const API_ROOMS = `${API_URL}/api/room/status?hotel_id=1`;
const API_AMENITIES = `${API_URL}/api/room/amenity/list`;
const API_UPDATE_STATUS = `${API_URL}/api/room/status`;
const API_DELETE_AMENITY = `${API_URL}/api/room/amenity`;

const container = document.getElementById("taskContainer");
const refreshBtn = document.getElementById("refreshBtn");
const langSelect = document.getElementById("langSelect");
const headerTitle = document.getElementById("headerTitle");

let currentLang = localStorage.getItem("lang") || "ja";
let originalRoomsData = [];
let globalRoomsData = []; // â† ã“ã‚Œã¯è¡¨ç¤ºç”¨ã«ã™ã‚‹
let globalAmenityData = [];  // â† ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ä½œæˆã—ã¦ãŠã
let originalAmenityData = [];



const loadingOverlay = document.getElementById("loadingOverlay");
const loadingText = document.getElementById("loadingText");

function showLoading() {
  loadingText.textContent = currentLang === "ja" ? "èª­ã¿è¾¼ã¿ä¸­..." :
                            currentLang === "pt" ? "Carregando..." :
                            "Loading...";
  loadingOverlay.classList.add("visible");
}
function hideLoading() {
  loadingOverlay.classList.remove("visible");
}

// ========================
// ğŸ”¹ ç¿»è¨³è¾æ›¸
// ========================
const t = {
  ja: {
    title: "RoomSync",
    refresh: "ğŸ”„ æ›´æ–°",
    cleaning: "æ¸…æƒ",
    amenity: "ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£",
    complete: "âœ… å®Œäº†",
    cleaningMsg: "æ¸…æƒã‚’å®Œäº†ã—ãŸã‚‰å ±å‘Šã—ã¦ãã ã•ã„ã€‚",
    noTask: "âœ… ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
    confirmCleaning: "æ¸…æƒã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ",
    confirmAmenity: "ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£å¯¾å¿œã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ",
    alertCleaningDone: "æ¸…æƒå®Œäº†ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚",
    alertAmenityDone: "ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£å¯¾å¿œã‚’å®Œäº†ã—ã¾ã—ãŸã€‚",
    fetchError: "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
    returnFront: "ãƒ•ãƒ­ãƒ³ãƒˆ",
    returnStorage: "å€‰åº«å®¤",
    amenityTypes: { exchange: "äº¤æ›", supply: "è£œå……", collect: "å›å" },
    amenitiesList: {
      pillow: "ã¾ãã‚‰",
      hanger: "ãƒãƒ³ã‚¬ãƒ¼",
      charger: "å……é›»å™¨",
      fan: "æ‰‡é¢¨æ©Ÿ",
      icepail: "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«",
      extCord: "å»¶é•·ã‚³ãƒ¼ãƒ‰",
      humidifier: "åŠ æ¹¿å™¨",
      smokeChange: "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ",

    },
    waitingApproval: "ï¼ˆç¢ºèªå¾…ã¡ï¼‰",
    allFloors: "å…¨ãƒ•ãƒ­ã‚¢",
cleaningBtn: "é–‹å§‹",
amenityBtn: "ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£",
undoBtn: "â¤º æˆ»ã™",
taskTitle: "ã‚¿ã‚¹ã‚¯",
amenityListFixed: {
  pillow: "ã¾ãã‚‰",
  hanger: "ãƒãƒ³ã‚¬ãƒ¼",
  charger: "å……é›»å™¨",
  fan: "æ‰‡é¢¨æ©Ÿ",
  icepail: "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«",
  extCord: "å»¶é•·ã‚³ãƒ¼ãƒ‰",
  humidifier: "åŠ æ¹¿å™¨",
  smokeChange: "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ",
},
actionTypesFixed: {
  supply: "è£œå……",
  collect: "å›å"
},
returnPlacesFixed: {
  front: "ãƒ•ãƒ­ãƒ³ãƒˆ",
  linen4: "4Fãƒªãƒãƒ³åº«",
  linen5: "5Fãƒªãƒãƒ³åº«",
  linen6: "6Fãƒªãƒãƒ³åº«",
  linen7: "7Fãƒªãƒãƒ³åº«",
  linen8: "8Fãƒªãƒãƒ³åº«",
  linen9: "9Fãƒªãƒãƒ³åº«",
  linen10: "10Fãƒªãƒãƒ³åº«",
  linen11: "11Fãƒªãƒãƒ³åº«",
  linen12: "12Fãƒªãƒãƒ³åº«",
},
cleaningToDo: "æƒé™¤å¯¾è±¡",
cleaningStarted: "é–‹å§‹æ¸ˆã¿",
observBtn: "è¦³å¯Ÿ",
observModalTitle: "è¦³å¯Ÿå†…å®¹",
observDone: "è¦³å¯Ÿã‚’å®Œäº†ã™ã‚‹",
 taskSentence: "%AMENITY% ã‚’%ACTION% â†’ %PLACE%ã¸",


  },
  pt: {
    title: "RoomSync",
    refresh: "ğŸ”„ Atualizar",
    cleaning: "Limpeza",
    amenity: "Amenity",
    complete: "âœ… Concluir",
    cleaningMsg: "Informe quando a limpeza for concluÃ­da.",
    noTask: "âœ… Nenhuma tarefa no momento.",
    confirmCleaning: "Deseja marcar a limpeza como concluÃ­da?",
    confirmAmenity: "Deseja marcar a amenidade como concluÃ­da?",
    alertCleaningDone: "Limpeza concluÃ­da com sucesso.",
    alertAmenityDone: "Amenidade concluÃ­da com sucesso.",
    fetchError: "Falha ao obter dados.",
    returnFront: "RecepÃ§Ã£o",
    returnStorage: "DepÃ³sito",
    amenityTypes: { exchange: "Troca", supply: "ReposiÃ§Ã£o", collect: "Coleta" },
    amenitiesList: {
      pillow: "Travesseiro",
      hanger: "Cabide",
      charger: "Carregador",
      fan: "Ventilador",
      icepail: "Balde de gelo",
      extCord: "ExtensÃ£o elÃ©trica",
      humidifier: "Umidificador",
      smokeChange: "Troca Fumante/NÃ£o Fumante",

    },
    waitingApproval: "(Aguardando aprovaÃ§Ã£o)",
    cleaningBtn: "Abrir",
    amenityBtn: "ğŸ§´ Amenidade",
    allFloors: "Todos os andares",
    undoBtn: "â¤º Desfazer",
    taskTitle: "Tarefas",
    amenityListFixed: {
  pillow: "Travesseiro",
  hanger: "Cabide",
  charger: "Carregador",
  fan: "Ventilador",
  icepail: "Balde de gelo",
  extCord: "ExtensÃ£o elÃ©trica",
  humidifier: "Umidificador",
  smokeChange: "Trocar fumante â†’ nÃ£o fumante",
},
actionTypesFixed: {
  supply: "ReposiÃ§Ã£o",
  collect: "Coleta"
},
cleaningToDo: "Para limpar",
cleaningStarted: "Abertos",
observBtn: "ObservaÃ§Ãµes",
observModalTitle: "Detalhes",
observDone: "Concluir observaÃ§Ã£o",
returnPlacesFixed: {
  front: "RecepÃ§Ã£o",
  linen4: "deposito 4F",
  linen5: "deposito 5F",
  linen6: "deposito 6F",
  linen7: "deposito 7F",
  linen8: "deposito 8F",
  linen9: "deposito 9F",
  linen10: "deposito 10F",
  linen11: "deposito 11F",
  linen12: "deposito 12F",
},
 taskSentence: "%ACTION% de %AMENITY% â†’ levar para %PLACE%",


  },
  en: {
    title: "RoomSync",
    refresh: "ğŸ”„ Refresh",
    cleaning: "Cleaning",
    amenity: "Amenity",
    complete: "âœ… Complete",
    cleaningMsg: "Please report when cleaning is done.",
    noTask: "âœ… No tasks at the moment.",
    confirmCleaning: "Mark cleaning as complete?",
    confirmAmenity: "Mark amenity as complete?",
    alertCleaningDone: "Cleaning marked as complete.",
    alertAmenityDone: "Amenity marked as complete.",
    fetchError: "Failed to fetch data.",
    returnFront: "Front Desk",
    returnStorage: "Storage Room",
    amenityTypes: { exchange: "Exchange", supply: "Supply", collect: "Collect" },
    amenitiesList: {
      pillow: "Pillow",
      hanger: "Hanger",
      charger: "Charger",
      fan: "Fan",
      icepail: "Ice pail",
      extCord: "Extension cord",
      humidifier: "Humidifier",
      smokeChange: "Smokingâ†’Non-smoking switch",

    },
    waitingApproval: "(Awaiting approval)",
    allFloors: "All Floors",
    cleaningBtn: "open",
    amenityBtn: "ğŸ§´ Amenity",
    undoBtn: "â¤º Undo",
    taskTitle: "Tasks",
    amenityListFixed: {
  pillow: "Pillow",
  hanger: "Hanger",
  charger: "Charger",
  fan: "Fan",
  icepail: "Ice pail",
  extCord: "Extension cord",
  humidifier: "Humidifier",
  smokeChange: "Smoking â†’ Non-smoking switch",
},
actionTypesFixed: {
  supply: "Supply",
  collect: "Collect"
},
returnPlacesFixed: {
  front: "Front Desk",
  linen4: "4F Linen Room",
  linen5: "5F Linen Room",
  linen6: "6F Linen Room",
  linen7: "7F Linen Room",
  linen8: "8F Linen Room",
  linen9: "9F Linen Room",
  linen10: "10F Linen Room",
  linen11: "11F Linen Room",
  linen12: "12F Linen Room",
},
cleaningToDo: "To clean",
cleaningStarted: "Started",
observBtn: "Observation",
observModalTitle: "Observation Details",
observDone: "Mark as Completed",
taskSentence: "Take %ACTION% of %AMENITY% â†’ to %PLACE%",

},
es: {
  title: "RoomSync",
  refresh: "ğŸ”„ Actualizar",
  cleaning: "Limpieza",
  amenity: "Amenidad",
  complete: "âœ… Completar",
  cleaningMsg: "Informe cuando la limpieza estÃ© terminada.",
  noTask: "âœ… No hay tareas por el momento.",
  confirmCleaning: "Â¿Marcar la limpieza como completada?",
  confirmAmenity: "Â¿Marcar la amenidad como completada?",
  alertCleaningDone: "Limpieza registrada como completada.",
  alertAmenityDone: "Amenidad registrada como completada.",
  fetchError: "Error al obtener los datos.",
  returnFront: "RecepciÃ³n",
  returnStorage: "DepÃ³sito",
  amenityTypes: { exchange: "Cambio", supply: "ReposiciÃ³n", collect: "RecolecciÃ³n" },
  amenitiesList: {
    pillow: "Almohada",
    hanger: "Percha",
    charger: "Cargador",
    fan: "Ventilador",
    icepail: "Cubo de hielo",
    extCord: "Cable de extensiÃ³n",
    humidifier: "Humidificador",
    smokeChange: "Cambio Fumador/No fumador",
  },
  waitingApproval: "(En espera de aprobaciÃ³n)",
  allFloors: "Todos los pisos",
  cleaningBtn: "abrir",
  amenityBtn: "ğŸ§´ Amenidad",
  undoBtn: "â¤º Deshacer",
  taskTitle: "Tareas",
  amenityListFixed: {
  pillow: "Almohada",
  hanger: "Percha",
  charger: "Cargador",
  fan: "Ventilador",
  icepail: "Cubo de hielo",
  extCord: "Cable de extensiÃ³n",
  humidifier: "Humidificador",
  smokeChange: "Cambio Fumador â†’ No fumador",
},
actionTypesFixed: {
  supply: "ReposiciÃ³n",
  collect: "RecolecciÃ³n"
},
cleaningToDo: "Para limpiar",
cleaningStarted: "Abiertos",
observBtn: "ObservaciÃ³n",
observModalTitle: "Detalles de observaciÃ³n",
observDone: "Marcar como completado",

},
returnPlacesFixed: {
  front: "RecepciÃ³n",
  linen4: "deposito 4F",
  linen5: "deposito 5F",
  linen6: "deposito 6F",
  linen7: "deposito 7F",
  linen8: "deposito 8F",
  linen9: "deposito 9F",
  linen10: "deposito 10F",
  linen11: "deposito 11F",
  linen12: "deposito 12F",
},
taskSentence: "%ACTION% de %AMENITY% â†’ llevar a %PLACE%",


};


const amenityKeys = [
  "pillow",
  "hanger",
  "charger",
  "fan",
  "icepail",
  "extCord",
  "humidifier",
  "smokeChange"
];

const amenityNameToKey = {
  "ã¾ãã‚‰": "pillow",
  "ãƒãƒ³ã‚¬ãƒ¼": "hanger",
  "å……é›»å™¨": "charger",
  "æ‰‡é¢¨æ©Ÿ": "fan",
  "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«": "icepail",
  "å»¶é•·ã‚³ãƒ¼ãƒ‰": "extCord",
  "åŠ æ¹¿å™¨": "humidifier",
  "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ": "smokeChange",
};

const actionTypeToKey = {
  "è£œå……": "supply",
  "å›å": "collect"
};

const returnPlaceToKey = {
  "ãƒ•ãƒ­ãƒ³ãƒˆ": "front",
  "front": "front",
  "4F ãƒªãƒãƒ³å®¤": "linen4",
  "5F ãƒªãƒãƒ³å®¤": "linen5",
  "6F ãƒªãƒãƒ³å®¤": "linen6",
  "7F ãƒªãƒãƒ³å®¤": "linen7",
  "8F ãƒªãƒãƒ³å®¤": "linen8",
  "9F ãƒªãƒãƒ³å®¤": "linen9",
  "10F ãƒªãƒãƒ³å®¤": "linen10",
  "11F ãƒªãƒãƒ³å®¤": "linen11",
  "12F ãƒªãƒãƒ³å®¤": "linen12",
};





const btnCleaning = document.getElementById("btnShowCleaning");
const btnAmenity  = document.getElementById("btnShowAmenity");
let globalAmenitys = ""

// ========================
// ğŸ”¹ è¨€èªåæ˜ 
// ========================
function applyLang() {
  headerTitle.textContent = t[currentLang].title;
  refreshBtn.textContent = t[currentLang].refresh;
  document.documentElement.lang = currentLang;
  localStorage.setItem("lang", currentLang);

  // ğŸŸ¢ ãƒ•ãƒ­ã‚¢é¸æŠã®å…ˆé ­ï¼ˆå…¨ãƒ•ãƒ­ã‚¢ï¼‰ã‚’ç¿»è¨³
  const floorSelect = document.getElementById("floorSelect");
  if (floorSelect) {
    floorSelect.options[0].text = t[currentLang].allFloors;
  }

  // // ğŸŸ¢ ãƒœã‚¿ãƒ³ç¿»è¨³
  // if (btnCleaning && btnAmenity) {
  //   btnCleaning.textContent = t[currentLang].taskTitle;
  //   btnAmenity.textContent = t[currentLang].amenityBtn;
  // }
}


langSelect.value = currentLang;
langSelect.addEventListener("change", () => {
  currentLang = langSelect.value;
  applyLang();
  loadTasks();
});


btnCleaning.addEventListener("click", () => {
  btnCleaning.classList.add("active");
  btnAmenity.classList.remove("active");
  applyFilters();
});

btnAmenity.addEventListener("click", () => {
  btnAmenity.classList.add("active");
  btnCleaning.classList.remove("active");
  applyFilters();
});

// =========================
// ğŸ¢ ãƒ•ãƒ­ã‚¢é¸æŠ
// =========================
document.getElementById("floorSelect").addEventListener("change", () => {
  applyFilters();
});

async function loadTasks() {
  showLoading();
  container.innerHTML = "";

  try {
    const [roomRes, amenityRes] = await Promise.all([
      fetch(API_ROOMS),
      fetch(API_AMENITIES)
    ]);

    const roomData = await roomRes.json();
    const amenityJson = await amenityRes.json();

    // â˜… æ­£ã—ã„é…åˆ—ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
    const amenitys = amenityJson.requests || amenityJson || [];
    globalAmenitys = amenitys

console.log(amenitys)
    // ğŸ”¹ éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿
    const sortedRoomData = roomData.rooms.sort((a, b) => a.id - b.id);
    originalRoomsData = [...sortedRoomData];
    globalRoomsData   = [...sortedRoomData];

    console.log(sortedRoomData)

    // ğŸ”¹ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿
    // originalAmenityData = [...amenitys];
    // globalAmenityData   = [...amenitys];

    // ğŸ”¹ è¡¨ç¤º
    renderRoomTasks(globalRoomsData);
    // renderAmenityTasks(globalAmenityData);

  } finally {
    hideLoading();
  }
}

function buildAmenityTaskText(a) {
  let lang = currentLang
  const key = amenityNameToKey[a.amenity];
  const translatedName = key ? t[lang].amenitiesList[key] : a.amenity;

  const actKey = actionTypeToKey[a.action_type];
  const actTranslated = actKey ? t[lang].amenityTypes[actKey] : a.action_type;

  const rtnKey = returnPlaceToKey[a.return_to];
  const rtnTranslated = rtnKey ? t[lang].returnPlacesFixed[rtnKey] : a.return_to;

  // è¨€èªåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ç½®æ›
  return t[lang].taskSentence
    .replace("%AMENITY%", translatedName)
    .replace("%ACTION%", actTranslated)
    .replace("%PLACE%", rtnTranslated);
}





function renderRoomTasks(roomData) {

  globalRoomsData=roomData
  console.log(roomData)
  // <span id='cleansROoms'></span>
  // <span id='cleansROomsInitial'></span>

  const beforeCleanning =  roomData.filter(r =>
    r.clean_flag === 'æœªæ¸…æƒ' &&
    r.status!=='stay_noclean' &&
   r.status!=='stay_amenytyOnliy');
  const inProgressRooms = roomData.filter(r => r.cleaning_status === 'in_progress' && r.checkout_status === 'after');
  const doneRooms = roomData.filter(r => r.cleaning_status === 'done' && r.checkout_status === 'after');
  const checked = roomData.filter(r => r.cleaning_status === 'checked' && r.checkout_status === 'after');

  console.log(beforeCleanning)
  const elevenFloor = beforeCleanning.filter(r=>r.floor===11)
  console.log(elevenFloor)

  // === UI è¡¨ç¤ºï¼ˆå¤šè¨€èªå¯¾å¿œï¼‰ ===
  document.getElementById('cleansRooms').innerText =
    `${t[currentLang].cleaningToDo}: ${beforeCleanning.length}`;

  document.getElementById('cleansRoomsInitial').innerText =
    `${t[currentLang].cleaningStarted}: ${inProgressRooms.length}`;

  container.innerHTML = "";

  const lang = currentLang || "ja";
  const L = t[lang];

  roomData.forEach(r => {
    const card = document.createElement("div");
    card.className = "task-card";

    let bgColor = "#e0e0e0";
    let textColor = "#333";
    let iconHTML = "";
    let showButtons = true;
    let showUndoOnly = false;
    let showStart = false;
    let showDone = false;
    let showUndo = false;
    let taskType = "";

    // ===================================================
    // â‘  cleaning_status ã«ã‚ˆã‚‹ãƒœã‚¿ãƒ³è¨­å®š
    // ===================================================

    // cleaning_status åŸºæœ¬ãƒ­ã‚¸ãƒƒã‚¯
    switch (r.cleaning_status) {
      case "not_started":
        showStart = true;
        showDone = false;   // NEWï¼šå¸¸ã«è¡¨ç¤º
        showUndo = false;
        break;

      case "in_progress":
        showStart = false;
        showDone = true;
        showUndo = true;
        break;

      case "done":
        showStart = false;
        showDone = false;   // NEWï¼šå®Œäº†å¾Œã‚‚å®Œäº†ãƒœã‚¿ãƒ³è¡¨ç¤º
        showUndo = true;
        break;

      case "checked":
        showStart = false;
        showDone = false;
        showUndo = false;
        break;
    }

            let youseisouBeforeCheckOut = false
            let amenityOnliyRoom=false

    // ===================================================
    // â‘¡ status / checkout_status ã®æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯å„ªå…ˆé©ç”¨
    // ===================================================
// console.log(r)

    if(r.room_number==='910'){
      console.log(r)
      console.log('amenityONly')
    }

    // before_check â†’ Undo ã®ã¿
    if(r.status === 'stay_amenytyOnliy'){
      bgColor = "#f0af73";
      iconHTML = `<img src="./img/bag.png" class="icon-img">`;
      amenityOnliyRoom=true
    }else if(r.excel_status === "S" && r.status === 'stay_noclean'){
        bgColor = "#ff9d33";
      showStart = false;
      showDone = false;
      showUndo = false;
    }
    else if(r.cleaning_status === 'checked'&&r.excel_status !== "S" ){
        bgColor = "#9d9a9a";
    }else if (r.excel_status === "S" && r.checkout_status === "before" && r.clean_flag==='æ¸…æƒ') {
      bgColor = "#ff9d33";
      showStart = false;
      showDone = false;
      showUndo = false;


      // iconHTML = `<img src="./img/seisou.png" class="icon-img">`;
    }else if (r.excel_status === "S" && r.checkout_status === "before" && r.clean_flag==='æœªæ¸…æƒ') {
      bgColor = "#ff9d33";
      showStart = true;
      showDone = false;
      showUndo = false;
      youseisouBeforeCheckOut=true

      // iconHTML = `<img src="./img/seisou.png" class="icon-img">`;
    }else if(r.checkout_status === "before" &&r.clean_flag === 'æœªæ¸…æƒ' &&r.excel_status !== "S" ){
      console.log('1121Sã®ã‚„ã¤')
  bgColor = "#9d9a9a";
youseisouBeforeCheckOut=true
}else if(r.checkout_status === "before" &&r.clean_flag === 'æœªæ¸…æƒ' &&r.excel_status === "S" ){
      console.log('1121Sã®ã‚„ã¤')
bgColor = "#ffffff";
youseisouBeforeCheckOut=true
    }else if (r.status === 'before_check') {
      bgColor = "#b3e5ff";
      textColor = "#004a77";
      // iconHTML = `<img src="./img/bag.png" class="icon-img">`;
      showStart = false;
      showDone = false;
      showUndo = true;  // â† å¿…ãš Undo ã®ã¿
    }else if (r.checkout_status === "before") {
      // console.log(r.room_number)
      bgColor = "#cfcfcf";
      textColor = "#888";
      showButtons = false;
      showStart = false;
      showDone = false;
      showUndo = false;
    }

    // after S
    else if (r.excel_status === "S" && r.checkout_status === "after") {
      bgColor = "#ff9d33";


      // iconHTML = `<img src="./img/seisou.png" class="icon-img">`;
    }

    // after é€šå¸¸
    else if (r.checkout_status === "after") {
      bgColor = "#ffffff";

    }


    if(r.stay_type==='individual'){
      iconHTML += `<img src="./img/esponja.png" class="icon-img">`;
    }

    // ãƒ‡ã‚¶ã‚¤ãƒ³é©ç”¨
    card.style.backgroundColor = bgColor;
    card.style.color = textColor;

    if (!showButtons && !(showStart || showDone || showUndo)) {
      card.classList.add("disabled-card");
    }

    // ===================================================
    // â‘¢ ãƒœã‚¿ãƒ³ç”Ÿæˆ
    // ===================================================

    let buttonHTML = `<div class="task-buttons">`;

    if (showStart || youseisouBeforeCheckOut) {
      if(r.room_number === '1121'){
        console.log(r)
        console.log(youseisouBeforeCheckOut)
      }

      const disabledClass = youseisouBeforeCheckOut ? " disabled-btn" : "";
      buttonHTML += `
        <button class="btn start-btn${disabledClass}" data-id="${r.id}">
          ${L.cleaningBtn}
        </button>
      `;
    }


    if (showDone) {
      buttonHTML += `
        <button class="btn done-btn" data-id="${r.id}">
          ${L.complete}
        </button>
      `;
    }

    if (showUndo) {
      buttonHTML += `
        <button class="btn undo-btn" data-id="${r.id}">
          ${L.undoBtn}
        </button>
      `;
    }

    buttonHTML += `</div>`;

    // å®Œå…¨ãƒ­ãƒƒã‚¯ãªã‚‰ãƒœã‚¿ãƒ³ãªã—ã«ã™ã‚‹
    if (!showButtons && !(showStart || showDone || showUndo)) {
      buttonHTML = "";
    }

    // --- è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿å–å¾— ---
const amenitysGet = globalAmenitys.filter(a => a.room_number === r.room_number&&a.status!=='done');
    // console.log(amenitysGet)

    // --- è¦³å¯Ÿãƒœã‚¿ãƒ³ï¼ˆå¤šè¨€èªå¯¾å¿œï¼‰ ---
    let observBadgeHTML = "";
    if (amenitysGet.length > 0) {

      const taskText = amenitysGet
        .map(a => buildAmenityTaskText(a, lang))
        .join("<br>");

      observBadgeHTML = `
        <span class="task-badge" data-room="${r.room_number}">
          ${taskText}
        </span>
      `;
    }



if(r.notes){
  console.log(r.notes)
  observBadgeHTML = `
    <span class="task-badge" data-room="${r.room_number}">
      ${r.notes}
    </span>
  `;
}
    // console.log(r)
    card.innerHTML = `
      <div class="task-room-header">
        <span class="room-number">${r.room_number}</span>
        ${observBadgeHTML}
        <div class="icon-area">${iconHTML}</div>
      </div>

      ${buttonHTML}
    `;




    // ===================================================
    // â‘£ ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
    // ===================================================

    if (showStart) {

      if (amenityOnliyRoom) {
        const btn = card.querySelector(".start-btn");
        btn.innerText = "AMENITY";
        btn.style.color = "red";            // â† æ–‡å­—è‰²ã‚’èµ¤ã«
      }

      card.querySelector(".start-btn")
        .addEventListener("click", () => startCleaning(r.id));
    }

    if (showDone) {
      card.querySelector(".done-btn")
        .addEventListener("click", () => finishCleaning(r.id));
    }

    if (showUndo) {
      card.querySelector(".undo-btn")
        .addEventListener("click", () => undoCleaning(r.id));
    }

    container.appendChild(card);
  });
}



function startCleaning(roomId) {
  console.log("Start cleaning:", roomId);

  // UIå³æ™‚æ›´æ–°
  updateRoomLocalStatus(roomId, "in_progress");
  refreshTasks();

  // é€šä¿¡æ™‚ã ã‘Loading
  withLoading(() =>
    fetch(`${API_URL}/api/room/cleaning/start`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId })
    })
  );
}

function finishCleaning(roomId) {
  console.log("Finish cleaning:", roomId);

  updateRoomLocalStatus(roomId, "done");
  refreshTasks();

  withLoading(() =>
    fetch(`${API_URL}/api/room/cleaning/finish`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId })
    })
  );
}


function undoCleaning(roomId) {
  console.log("Undo cleaning:", roomId);

  updateRoomLocalStatus(roomId, "not_started");
  refreshTasks();

  withLoading(() =>
    fetch(`${API_URL}/api/room/cleaning/undo`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId })
    })
  );
}



function updateRoomLocalStatus(roomId, newStatus) {
  // è¡¨ç¤ºç”¨
  const r1 = globalRoomsData.find(r => r.id === roomId);
  if (r1) r1.cleaning_status = newStatus;

  // å…ƒãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°ï¼ˆå‰Šã‚Œãªã„ï¼‰
  const r2 = originalRoomsData.find(r => r.id === roomId);
  if (r2) r2.cleaning_status = newStatus;
}



function refreshTasks() {
  applyFilters()
  renderRoomTasks(globalRoomsData);
}


async function withLoading(promiseFunc) {
  try {
    showLoading();
    const result = await promiseFunc();
    return result;
  } catch (err) {
    console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
    throw err;
  } finally {
    hideLoading();
  }
}

// ========================
// ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼ˆ17:00ã€œç¿Œ07:00ï¼‰3è¨€èªè¡¨ç¤ºç‰ˆ
// ========================
function checkAccessTime() {
  const now = new Date();
  const hour = now.getHours();

  // å¤œé–“ (17:00ã€œ23:59) ã¾ãŸã¯ æœæ–¹ (0:00ã€œ6:59) ã¯ãƒ­ãƒƒã‚¯
  if (hour >= 17 || hour < 7) {
    const currentTime = now.toLocaleTimeString('ja-JP', {
      hour: '2-digit',
      minute: '2-digit'
    });

    document.body.innerHTML = `
      <div style="
        display:flex;
        justify-content:center;
        align-items:center;
        flex-direction:column;
        height:100vh;
        background:#f8f9fa;
        color:#333;
        font-family:'Noto Sans JP',sans-serif;
        text-align:center;
        line-height:1.8;
        padding:20px;
        overflow: auto;
      ">
        <!-- ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª -->
        <h2 style="margin-bottom:10px;">â° ç¾åœ¨ã¯ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨æ™‚é–“å¤–ã§ã™</h2>
        <p>åˆ©ç”¨å¯èƒ½æ™‚é–“ï¼š07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» ç¾åœ¨æ™‚åˆ»ï¼š${currentTime}</p>

        <hr style="width:60%;margin:20px 0;border:none;border-top:1px solid #ccc;">

        <!-- ğŸ‡§ğŸ‡· ãƒãƒ«ãƒˆã‚¬ãƒ«èª -->
        <h3 style="margin-bottom:6px;">â° O sistema estÃ¡ indisponÃ­vel no momento</h3>
        <p>HorÃ¡rio de uso: 07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» Hora atual: ${currentTime}</p>

        <hr style="width:60%;margin:20px 0;border:none;border-top:1px solid #ccc;">

        <!-- ğŸ‡ºğŸ‡¸ è‹±èª -->
        <h3 style="margin-bottom:6px;">â° System is currently unavailable</h3>
        <p>Available hours: 07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» Current time: ${currentTime}</p>

        <hr style="width:60%;margin:20px 0;border:none;border-top:1px solid #ccc;">

        <!-- ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³èª -->
        <h3 style="margin-bottom:6px;">â° El sistema no estÃ¡ disponible en este momento</h3>
        <p>Horario de uso: 07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» Hora actual: ${currentTime}</p>
      </div>
    `;

    // å‡¦ç†åœæ­¢
    throw new Error("Access restricted during night hours.");
  }
}

function applyFilters() {
  const floorSelectEl = document.getElementById("floorSelect");
  const selectedFloor = floorSelectEl.value;

  const modeCleaning = document.getElementById("btnShowCleaning").classList.contains("active");
  const modeAmenity  = document.getElementById("btnShowAmenity").classList.contains("active");

  // â­ å¿…ãš originalRoomsData ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å§‹ã‚ã‚‹ï¼ï¼
  let filtered = [...originalRoomsData];

  // â‘  ãƒ•ãƒ­ã‚¢
  if (selectedFloor !== "all") {
    filtered = filtered.filter(r => String(r.floor) === selectedFloor);
  }

  // â‘¡ æ¸…æƒã ã‘
  if (modeCleaning && !modeAmenity) {
    filtered = filtered.filter(r =>
      r.checkout_status === "after" ||
      r.status === "before_check" ||
      ["not_started","in_progress","done"].includes(r.cleaning_status)
    );
  }

  // â‘¢ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã ã‘
  if (!modeCleaning && modeAmenity) {
    filtered = filtered.filter(r => r.status === "stay_amenytyOnliy");
  }

  // â‘£ å…¨ãƒ•ãƒ­ã‚¢ + æ¸…æƒ + ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ â†’ å…¨è¡¨ç¤º
  if (selectedFloor === "all" && modeCleaning && modeAmenity) {
    filtered = [...originalRoomsData];
  }

  globalRoomsData = filtered;  // â† è¡¨ç¤ºç”¨ã ã‘æ›´æ–°
  renderRoomTasks(filtered);
}

// function renderAmenityTasks(amenityData) {
//   const lang = currentLang || "ja";
//   const L = t[lang];
//
//   // ğŸ”¹ ã‚³ãƒ³ãƒ†ãƒŠç¢ºèªï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰
//   let amenityContainer = document.getElementById("amenityContainer");
//   if (!amenityContainer) {
//     amenityContainer = document.createElement("div");
//     amenityContainer.id = "amenityContainer";
//     document.body.appendChild(amenityContainer);
//   }
//
//   amenityContainer.innerHTML = `
//     <h2 style="margin:15px 0 10px;">ğŸ§´ ${L.amenity}</h2>
//   `;
//
//   if (!amenityData || amenityData.length === 0) {
//     amenityContainer.innerHTML += `
//       <p style="text-align:center;color:#666;">${L.noTask}</p>
//     `;
//     return;
//   }
//
//   amenityData.forEach(a => {
//     const card = document.createElement("div");
//     card.className = "task-card";
//     // card.style.background = "#ffe7ba";
//
//     const key = amenityNameToKey[a.amenity] || null;
//     const displayName = key ? L.amenityListFixed[key] : a.amenity;
//
//     const actionKey = actionTypeToKey[a.action_type];
//     const actionLabel = actionKey
//       ? t[currentLang].amenityTypes[actionKey]
//       : a.action_type;
//
//     card.innerHTML = `
//       <div class="task-room-header">
//         <span class="room-number">${a.room_number}</span>
//
//       </div>
//
//       <div style="padding:6px 12px;font-size:15px;">
//         <div><b>${displayName}</b></div>
//         <div>${actionLabel}</div>
//         ${a.return_to ? `<div>${a.return_to}</div>` : ""}
//       </div>
//
//       <div class="task-buttons">
//         <button class="btn done-btn" data-id="${a.id}">
//           ${t[currentLang].complete}
//         </button>
//       </div>
//     `;
//
//
//
//     card.querySelector(".done-btn")
//       .addEventListener("click", () => finishAmenity(a.id));
//
//     amenityContainer.appendChild(card);
//   });
// }

function finishAmenity(amenityId) {
  console.log("Amenity Complete:", amenityId);

  withLoading(() =>
    fetch(`${API_URL}/api/room/amenity/${amenityId}`, {
      method: "DELETE"
    })
  ).then(() => {
    // UI ã‹ã‚‰å‰Šé™¤
    globalAmenityData = globalAmenityData.filter(a => a.id !== amenityId);
    renderAmenityTasks(globalAmenityData);
  });
}

document.addEventListener("click", async (e) => {
  // è¦³å¯Ÿãƒœã‚¿ãƒ³æŠ¼ã•ã‚ŒãŸï¼Ÿ
  console.log('amenityCheck')
  if (e.target.classList.contains("observ-btn")) {
    const roomNo = e.target.dataset.room;

    const data = globalAmenitys.filter(a => a.room_number === roomNo);

    // å†…å®¹ã‚’å·®ã—è¾¼ã‚€
    const html = data.map(a => {
      // â–¼ action_type ç¿»è¨³
      const atKey = actionTypeToKey[a.action_type] || a.action_type;
      const actionTranslated = t[currentLang].amenityTypes[atKey] || a.action_type;

      // â–¼ return_to ç¿»è¨³
      const rtnKey = returnPlaceToKey[a.return_to] || null;
      console.log(t[currentLang].returnPlacesFixed)
      console.log(rtnKey)
      console.log(returnPlaceToKey)
      console.log(a.return_to)
      const returnTranslated = rtnKey ? t[currentLang].returnPlacesFixed[rtnKey] : a.return_to;

      // â–¼ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£å ç¿»è¨³ï¼ˆå‰å›ä½œæˆï¼‰
      const amKey = amenityNameToKey[a.amenity] || null;
      const amenityTranslated = amKey ? t[currentLang].amenitiesList[amKey] : a.amenity;

      return `
        <div class="observ-item">
          <b>${t[currentLang].amenity}:</b> ${amenityTranslated}<br>

          <b>${t[currentLang].amenityTypes[atKey] || a.action_type}:</b><br>

          <b>${t[currentLang].returnFront}: </b>${returnTranslated}<br>


          <hr>
        </div>
      `;
    }).join("");


    document.getElementById("observText").innerHTML = html;

    // å¤šè¨€èªãƒ©ãƒ™ãƒ«é©ç”¨
    document.getElementById("observModalTitle").textContent = t[currentLang].observModalTitle;
    document.getElementById("observDoneBtn").textContent = t[currentLang].observDone;
    document.getElementById("observCloseBtn").textContent = "âœ– " + t[currentLang].undoBtn;

    // å®Œäº†ã® roomNo ä¿å­˜
    document.getElementById("observDoneBtn").dataset.room = roomNo;

    // é–‹ã
    document.getElementById("observModal").classList.remove("hidden");
  }

  // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
  if (e.target.id === "observCloseBtn") {
    document.getElementById("observModal").classList.add("hidden");
  }

  // å®Œäº†ãƒœã‚¿ãƒ³
  if (e.target.id === "observDoneBtn") {
    const roomNo = e.target.dataset.room;

    await finishAmenity(roomNo);

    document.getElementById("observModal").classList.add("hidden");
    refreshTasks();
  }
});




// ========================
refreshBtn.addEventListener("click", loadTasks);
applyLang();
loadTasks();
</script>
</body>
</html>
