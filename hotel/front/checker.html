<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operator Tasks</title>
<link rel="stylesheet" href="./operator.css">

</head>
<body>
  <header style="

    background: #d90000;   /* â˜…ã“ã“ã§èµ¤è‰²ã«å¤‰æ›´ */
  ">
      <select id="langSelect">
        <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
        <option value="pt">ğŸ‡§ğŸ‡· PortuguÃªs</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
      </select>
      <span id="headerTitle">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚¿ã‚¹ã‚¯</span>
      <button id="refreshBtn">ğŸ”„ æ›´æ–°</button>
  </header>


  <!-- ğŸŸ¢ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢è¿½åŠ  -->
  <div id="filterBar" style="display:flex;justify-content:center;align-items:center;gap:10px;padding:8px 0;background:#eef3f8;">
    <select id="floorSelect" style="padding:6px 10px;border-radius:8px;border:1px solid #ccc;">
      <option value="all">å…¨ãƒ•ãƒ­ã‚¢</option>
      <option value="4">4F</option>
      <option value="5">5F</option>
      <option value="6">6F</option>
      <option value="7">7F</option>
      <option value="8">8F</option>
      <option value="9">9F</option>
      <option value="10">10F</option>
      <option value="11">11F</option>
      <option value="12">12F</option>
    </select>

  </select>
  <div id="summaryContainer">
    <div id="cleansRooms" class="summary-box"></div>
    <div id="cleansRoomsInitial" class="summary-box"></div>
  </div>
  </div>


  <div id="taskContainer"></div>


<div id="loadingOverlay">
  <div class="loader"></div>
  <div id="loadingText">Loading...</div>
</div>

<script>

const API_URL = `https://squid-app-ug7x6.ondigitalocean.app`
// const API_URL = `http://localhost:3000`
const globalId = 1
// èªè¨¼ãƒã‚§ãƒƒã‚¯
const token = localStorage.getItem("authToken");
const decoded = JSON.parse(atob(token.split('.')[1]));

if (!token) {
  // ãƒˆãƒ¼ã‚¯ãƒ³ãªã— â†’ ãƒ­ã‚°ã‚¤ãƒ³ã¸å¼·åˆ¶é€é‚„
  window.location.href = "./../login.html";
} else {
  try {
    const decoded = JSON.parse(atob(token.split('.')[1]));

    // ãƒ‡ã‚³ãƒ¼ãƒ‰æˆåŠŸ â†’ decoded ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«æŒãŸã›ã‚‹
    window.decodedUser = decoded;

    console.log("ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:", decoded);

    // ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
    const now = Math.floor(Date.now() / 1000);
    if (decoded.exp < now) {
      localStorage.removeItem("authToken");
      alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
      window.location.href = "./../login.html";
    }

  } catch (e) {
    console.error("ãƒˆãƒ¼ã‚¯ãƒ³è§£æã‚¨ãƒ©ãƒ¼:", e);

    // ãƒˆãƒ¼ã‚¯ãƒ³ç ´æ â†’ å‰Šé™¤ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã¸
    localStorage.removeItem("authToken");
    window.location.href = "./../login.html";
  }
}

let operatorId=decoded.id
// const API_ROOMS = `${API_URL}/api/room/status?hotel_id=${globalId}`;
const API_AMENITIES = `${API_URL}/api/room/amenity/list`;
const API_UPDATE_STATUS = `${API_URL}/api/room/status`;
const API_DELETE_AMENITY = `${API_URL}/api/room/amenity`;

const container = document.getElementById("taskContainer");
const refreshBtn = document.getElementById("refreshBtn");
const langSelect = document.getElementById("langSelect");
const headerTitle = document.getElementById("headerTitle");

let currentLang = localStorage.getItem("lang") || "ja";
let originalRoomsData = [];
let globalRoomsData = []; // â† ã“ã‚Œã¯è¡¨ç¤ºç”¨ã«ã™ã‚‹
let globalAmenityData = [];  // â† ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ä½œæˆã—ã¦ãŠã
let originalAmenityData = [];



const loadingOverlay = document.getElementById("loadingOverlay");
const loadingText = document.getElementById("loadingText");

function showLoading() {
  loadingText.textContent = currentLang === "ja" ? "èª­ã¿è¾¼ã¿ä¸­..." :
                            currentLang === "pt" ? "Carregando..." :
                            "Loading...";
  loadingOverlay.classList.add("visible");
}
function hideLoading() {
  loadingOverlay.classList.remove("visible");
}

// ========================
// ğŸ”¹ ç¿»è¨³è¾æ›¸
// ========================
const t = {
  ja: {
    title: "RoomSync",
    refresh: "ğŸ”„ æ›´æ–°",
    cleaning: "æ¸…æƒ",
    amenity: "ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£",
    complete: "âœ… å®Œäº†",
    cleaningMsg: "æ¸…æƒã‚’å®Œäº†ã—ãŸã‚‰å ±å‘Šã—ã¦ãã ã•ã„ã€‚",
    noTask: "âœ… ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
    confirmCleaning: "æ¸…æƒã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ",
    confirmAmenity: "ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£å¯¾å¿œã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ",
    alertCleaningDone: "æ¸…æƒå®Œäº†ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚",
    alertAmenityDone: "ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£å¯¾å¿œã‚’å®Œäº†ã—ã¾ã—ãŸã€‚",
    fetchError: "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
    returnFront: "ãƒ•ãƒ­ãƒ³ãƒˆ",
    returnStorage: "å€‰åº«å®¤",
    amenityTypes: { exchange: "äº¤æ›", supply: "è£œå……", collect: "å›å" },
    amenitiesList: {
      pillow: "ã¾ãã‚‰",
      hanger: "ãƒãƒ³ã‚¬ãƒ¼",
      charger: "å……é›»å™¨",
      fan: "æ‰‡é¢¨æ©Ÿ",
      icepail: "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«",
      extCord: "å»¶é•·ã‚³ãƒ¼ãƒ‰",
      humidifier: "åŠ æ¹¿å™¨",
      smokeChange: "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ",

    },
    waitingApproval: "ï¼ˆç¢ºèªå¾…ã¡ï¼‰",
    allFloors: "å…¨ãƒ•ãƒ­ã‚¢",
cleaningBtn: "é–‹å§‹",
amenityBtn: "ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£",
undoBtn: "â¤º æˆ»ã™",
taskTitle: "ã‚¿ã‚¹ã‚¯",
amenityListFixed: {
  pillow: "ã¾ãã‚‰",
  hanger: "ãƒãƒ³ã‚¬ãƒ¼",
  charger: "å……é›»å™¨",
  fan: "æ‰‡é¢¨æ©Ÿ",
  icepail: "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«",
  extCord: "å»¶é•·ã‚³ãƒ¼ãƒ‰",
  humidifier: "åŠ æ¹¿å™¨",
  smokeChange: "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ",
},
actionTypesFixed: {
  supply: "è£œå……",
  collect: "å›å"
},
returnPlacesFixed: {
  front: "ãƒ•ãƒ­ãƒ³ãƒˆ",
  linen4: "4Fãƒªãƒãƒ³åº«",
  linen5: "5Fãƒªãƒãƒ³åº«",
  linen6: "6Fãƒªãƒãƒ³åº«",
  linen7: "7Fãƒªãƒãƒ³åº«",
  linen8: "8Fãƒªãƒãƒ³åº«",
  linen9: "9Fãƒªãƒãƒ³åº«",
  linen10: "10Fãƒªãƒãƒ³åº«",
  linen11: "11Fãƒªãƒãƒ³åº«",
  linen12: "12Fãƒªãƒãƒ³åº«",
},
inspectorButtons: {
  revert: "â¤º æ¸…æƒå‰ã«æˆ»ã™",
  done:   "âœ… æ¸…æƒå®Œäº†",
  checked:"âœ” ç¢ºèªæ¸ˆã¿",
  beforeChecked:'ç¢ºèªã™ã‚‹'
},
cleaningStatusLabel: {
  not_started: "æœªæ¸…æƒ",
  in_progress: "æ¸…æƒä¸­",
  done: "æ¸…æƒå®Œäº†",
  checked: "ç¢ºèªæ¸ˆã¿"
},
cleaningToDo: "æƒé™¤å¯¾è±¡",
cleaningStarted: "é–‹å§‹æ¸ˆã¿",
 taskSentence: "%AMENITY% ã‚’%ACTION% â†’ %PLACE%ã¸",





  },
  pt: {
    title: "RoomSync",
    refresh: "ğŸ”„ Atualizar",
    cleaning: "Limpeza",
    amenity: "Amenidade",
    complete: "âœ… Concluir",
    cleaningMsg: "Informe quando a limpeza for concluÃ­da.",
    noTask: "âœ… Nenhuma tarefa no momento.",
    confirmCleaning: "Deseja marcar a limpeza como concluÃ­da?",
    confirmAmenity: "Deseja marcar a amenidade como concluÃ­da?",
    alertCleaningDone: "Limpeza concluÃ­da com sucesso.",
    alertAmenityDone: "Amenidade concluÃ­da com sucesso.",
    fetchError: "Falha ao obter dados.",
    returnFront: "RecepÃ§Ã£o",
    returnStorage: "DepÃ³sito",
    amenityTypes: { exchange: "Troca", supply: "ReposiÃ§Ã£o", collect: "Coleta" },
    amenitiesList: {
      pillow: "Travesseiro",
      hanger: "Cabide",
      charger: "Carregador",
      fan: "Ventilador",
      icepail: "Balde de gelo",
      extCord: "ExtensÃ£o elÃ©trica",
      humidifier: "Umidificador",
      smokeChange: "Troca Fumante/NÃ£o Fumante",

    },
    waitingApproval: "(Aguardando aprovaÃ§Ã£o)",
    cleaningBtn: "Abrir",
    amenityBtn: "ğŸ§´ Amenidade",
    allFloors: "Todos os andares",
    undoBtn: "â¤º Desfazer",
    taskTitle: "Tarefas",
    amenityListFixed: {
  pillow: "Travesseiro",
  hanger: "Cabide",
  charger: "Carregador",
  fan: "Ventilador",
  icepail: "Balde de gelo",
  extCord: "ExtensÃ£o elÃ©trica",
  humidifier: "Umidificador",
  smokeChange: "Trocar fumante â†’ nÃ£o fumante",
},
actionTypesFixed: {
  supply: "ReposiÃ§Ã£o",
  collect: "Coleta"
},
inspectorButtons: {
  revert: "â¤º Refazer",
  done:   "âœ… Limpeza concluÃ­da",
  checked:"Verificado",
  beforeChecked:'Verificar'
},
cleaningStatusLabel: {
  not_started: "NÃ£o limpo",
  in_progress: "Limpando",
  done: "Limpo",
  checked: "Limpo confirmado"
},
cleaningToDo: "Para limpar",
cleaningStarted: "Abertos",
returnPlacesFixed: {
  front: "RecepÃ§Ã£o",
  linen4: "deposito 4F",
  linen5: "deposito 5F",
  linen6: "deposito 6F",
  linen7: "deposito 7F",
  linen8: "deposito 8F",
  linen9: "deposito 9F",
  linen10: "deposito 10F",
  linen11: "deposito 11F",
  linen12: "deposito 12F",
},
 taskSentence: "%ACTION% de %AMENITY% â†’ levar para %PLACE%",



  },
  en: {
    title: "RoomSync",
    refresh: "ğŸ”„ Refresh",
    cleaning: "Cleaning",
    amenity: "Amenity",
    complete: "âœ… Complete",
    cleaningMsg: "Please report when cleaning is done.",
    noTask: "âœ… No tasks at the moment.",
    confirmCleaning: "Mark cleaning as complete?",
    confirmAmenity: "Mark amenity as complete?",
    alertCleaningDone: "Cleaning marked as complete.",
    alertAmenityDone: "Amenity marked as complete.",
    fetchError: "Failed to fetch data.",
    returnFront: "Front Desk",
    returnStorage: "Storage Room",
    amenityTypes: { exchange: "Exchange", supply: "Supply", collect: "Collect" },
    amenitiesList: {
      pillow: "Pillow",
      hanger: "Hanger",
      charger: "Charger",
      fan: "Fan",
      icepail: "Ice pail",
      extCord: "Extension cord",
      humidifier: "Humidifier",
      smokeChange: "Smokingâ†’Non-smoking switch",

    },
    waitingApproval: "(Awaiting approval)",
    allFloors: "All Floors",
    cleaningBtn: "open",
    amenityBtn: "ğŸ§´ Amenity",
    undoBtn: "â¤º Undo",
    taskTitle: "Tasks",
    amenityListFixed: {
  pillow: "Pillow",
  hanger: "Hanger",
  charger: "Charger",
  fan: "Fan",
  icepail: "Ice pail",
  extCord: "Extension cord",
  humidifier: "Humidifier",
  smokeChange: "Smoking â†’ Non-smoking switch",
},
actionTypesFixed: {
  supply: "Supply",
  collect: "Collect"
},
returnPlacesFixed: {
  front: "Front Desk",
  linen4: "4F Linen Room",
  linen5: "5F Linen Room",
  linen6: "6F Linen Room",
  linen7: "7F Linen Room",
  linen8: "8F Linen Room",
  linen9: "9F Linen Room",
  linen10: "10F Linen Room",
  linen11: "11F Linen Room",
  linen12: "12F Linen Room",
},
inspectorButtons: {
  revert: "â¤º Revert to Before Cleaning",
  done:   "âœ… Cleaning Done",
  checked:"Confirmed",
  beforeChecked:'check'
},
cleaningStatusLabel: {
  not_started: "Not cleaned",
  in_progress: "Cleaning",
  done: "Cleaned",
  checked: "Confirmed"
},
cleaningToDo: "To clean",
cleaningStarted: "Started",
taskSentence: "Take %ACTION% of %AMENITY% â†’ to %PLACE%",


},
es: {
  title: "RoomSync",
  refresh: "ğŸ”„ Actualizar",
  cleaning: "Limpieza",
  amenity: "Amenidad",
  complete: "âœ… Completar",
  cleaningMsg: "Informe cuando la limpieza estÃ© terminada.",
  noTask: "âœ… No hay tareas por el momento.",
  confirmCleaning: "Â¿Marcar la limpieza como completada?",
  confirmAmenity: "Â¿Marcar la amenidad como completada?",
  alertCleaningDone: "Limpieza registrada como completada.",
  alertAmenityDone: "Amenidad registrada como completada.",
  fetchError: "Error al obtener los datos.",
  returnFront: "RecepciÃ³n",
  returnStorage: "DepÃ³sito",
  amenityTypes: { exchange: "Cambio", supply: "ReposiciÃ³n", collect: "RecolecciÃ³n" },
  amenitiesList: {
    pillow: "Almohada",
    hanger: "Percha",
    charger: "Cargador",
    fan: "Ventilador",
    icepail: "Cubo de hielo",
    extCord: "Cable de extensiÃ³n",
    humidifier: "Humidificador",
    smokeChange: "Cambio Fumador/No fumador",
  },
  waitingApproval: "(En espera de aprobaciÃ³n)",
  allFloors: "Todos los pisos",
  cleaningBtn: "abrir",
  amenityBtn: "ğŸ§´ Amenidad",
  undoBtn: "â¤º Deshacer",
  taskTitle: "Tareas",
  amenityListFixed: {
  pillow: "Almohada",
  hanger: "Percha",
  charger: "Cargador",
  fan: "Ventilador",
  icepail: "Cubo de hielo",
  extCord: "Cable de extensiÃ³n",
  humidifier: "Humidificador",
  smokeChange: "Cambio Fumador â†’ No fumador",
},
actionTypesFixed: {
  supply: "ReposiciÃ³n",
  collect: "RecolecciÃ³n"
},
inspectorButtons: {
  revert: "Volver antes de limpiar",
  done:   "Limpieza completada",
  checked:"Verificado",
  beforeChecked:'Verificar'
},

// ğŸ”¥ è¿”å´å…ˆã®ç¿»è¨³ï¼ˆä»–è¨€èªã«ã‚‚ã‚ã‚‹ã®ã§ ES ã‚‚å¿…è¦ï¼‰
returnPlacesFixed: {
  front: "RecepciÃ³n",
  linen4: "DepÃ³sito 4F",
  linen5: "DepÃ³sito 5F",
  linen6: "DepÃ³sito 6F",
  linen7: "DepÃ³sito 7F",
  linen8: "DepÃ³sito 8F",
  linen9: "DepÃ³sito 9F",
  linen10: "DepÃ³sito 10F",
  linen11: "DepÃ³sito 11F",
  linen12: "DepÃ³sito 12F",
},
cleaningStatusLabel: {
  not_started: "No limpiado",
  in_progress: "En limpieza",
  done: "Limpio",
  checked: "Confirmado"
},
cleaningToDo: "Para limpiar",
cleaningStarted: "Abiertos",


},

taskSentence: "%ACTION% de %AMENITY% â†’ llevar a %PLACE%",

};


const amenityKeys = [
  "pillow",
  "hanger",
  "charger",
  "fan",
  "icepail",
  "extCord",
  "humidifier",
  "smokeChange"
];

const amenityNameToKey = {
  "ã¾ãã‚‰": "pillow",
  "ãƒãƒ³ã‚¬ãƒ¼": "hanger",
  "å……é›»å™¨": "charger",
  "æ‰‡é¢¨æ©Ÿ": "fan",
  "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«": "icepail",
  "å»¶é•·ã‚³ãƒ¼ãƒ‰": "extCord",
  "åŠ æ¹¿å™¨": "humidifier",
  "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ": "smokeChange",
};

const actionTypeToKey = {
  "è£œå……": "supply",
  "å›å": "collect"
};


const returnPlaceToKey = {
  "ãƒ•ãƒ­ãƒ³ãƒˆ": "front",
  "front": "front",
  "4F ãƒªãƒãƒ³å®¤": "linen4",
  "5F ãƒªãƒãƒ³å®¤": "linen5",
  "6F ãƒªãƒãƒ³å®¤": "linen6",
  "7F ãƒªãƒãƒ³å®¤": "linen7",
  "8F ãƒªãƒãƒ³å®¤": "linen8",
  "9F ãƒªãƒãƒ³å®¤": "linen9",
  "10F ãƒªãƒãƒ³å®¤": "linen10",
  "11F ãƒªãƒãƒ³å®¤": "linen11",
  "12F ãƒªãƒãƒ³å®¤": "linen12",
};




const btnCleaning = document.getElementById("btnShowCleaning");
const btnAmenity  = document.getElementById("btnShowAmenity");
let globalAmenitys = ""

// ========================
// ğŸ”¹ è¨€èªåæ˜ 
// ========================
function applyLang() {
  headerTitle.textContent = t[currentLang].title;
  refreshBtn.textContent = t[currentLang].refresh;
  document.documentElement.lang = currentLang;
  localStorage.setItem("lang", currentLang);

  // ğŸŸ¢ ãƒ•ãƒ­ã‚¢é¸æŠã®å…ˆé ­ï¼ˆå…¨ãƒ•ãƒ­ã‚¢ï¼‰ã‚’ç¿»è¨³
  const floorSelect = document.getElementById("floorSelect");
  if (floorSelect) {
    floorSelect.options[0].text = t[currentLang].allFloors;
  }

  // ğŸŸ¢ ãƒœã‚¿ãƒ³ç¿»è¨³
  if (btnCleaning && btnAmenity) {
    btnCleaning.textContent = t[currentLang].taskTitle;
    btnAmenity.textContent = t[currentLang].amenityBtn;
  }
}


langSelect.value = currentLang;
langSelect.addEventListener("change", () => {
  currentLang = langSelect.value;
  applyLang();
  loadTasks();
});


// btnCleaning.addEventListener("click", () => {
//   btnCleaning.classList.add("active");
//   btnAmenity.classList.remove("active");
//   applyFilters();
// });
//
// btnAmenity.addEventListener("click", () => {
//   btnAmenity.classList.add("active");
//   btnCleaning.classList.remove("active");
//   applyFilters();
// });

// =========================
// ğŸ¢ ãƒ•ãƒ­ã‚¢é¸æŠ
// =========================
document.getElementById("floorSelect").addEventListener("change", () => {
  applyFilters();
});

async function loadTasks() {
  showLoading();
  container.innerHTML = "";

  const now = new Date();
   now.setHours(now.getHours() + 9);  // JSTè£œæ­£

   const date = now.toISOString().split("T")[0];  // JSTã®æ—¥ä»˜ "YYYY-MM-DD"

  // console.log(date);

  const API_ROOMS = `${API_URL}/api/room/daily_room_list?date=${date}&hotel_id=${globalId}`;

  try {
    const [roomRes, amenityRes] = await Promise.all([
      fetch(API_ROOMS),
      fetch(API_AMENITIES)
    ]);

    const roomData = await roomRes.json();
    const amenityJson = await amenityRes.json();

    // â˜… æ­£ã—ã„é…åˆ—ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
    const amenitys = amenityJson.requests || amenityJson || [];
    globalAmenitys = amenitys


    // ğŸ”¹ éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿
    const sortedRoomData = roomData.rows.sort((a, b) => a.id - b.id);
    originalRoomsData = [...sortedRoomData];
    globalRoomsData   = [...sortedRoomData];

    // // ğŸ”¹ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿
    // originalAmenityData = [...amenitys];
    // globalAmenityData   = [...amenitys];

    // ğŸ”¹ è¡¨ç¤º
    renderRoomTasks(globalRoomsData);
    // renderAmenityTasks(globalAmenityData);

  } finally {
    hideLoading();
  }
}

function buildAmenityTaskText(a) {
  let lang = currentLang
  const key = amenityNameToKey[a.amenity];
  const translatedName = key ? t[lang].amenitiesList[key] : a.amenity;

  const actKey = actionTypeToKey[a.action_type];
  const actTranslated = actKey ? t[lang].amenityTypes[actKey] : a.action_type;

  const rtnKey = returnPlaceToKey[a.return_to];
  const rtnTranslated = rtnKey ? t[lang].returnPlacesFixed[rtnKey] : a.return_to;

  // è¨€èªåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ç½®æ›
  return t[lang].taskSentence
    .replace("%AMENITY%", translatedName)
    .replace("%ACTION%", actTranslated)
    .replace("%PLACE%", rtnTranslated);
}


function renderRoomTasks(roomData) {

  roomData.sort((a, b) => Number(a.room_number) - Number(b.room_number));
  container.innerHTML = "";
  globalRoomsData = roomData;


  console.log(`globalRoomsData`,globalRoomsData)

  const beforeCleanning =  roomData.filter(r =>
    r.clean_flag === 'æœªæ¸…æƒ' &&
    r.status!=='stay_noclean' &&
   r.status!=='stay_amenytyOnliy');
  const inProgressRooms = roomData.filter(r => r.cleaning_status === 'in_progress' && r.checkout_status === 'after');
  const doneRooms = roomData.filter(r => r.cleaning_status === 'done' && r.checkout_status === 'after');
  const checked = roomData.filter(r => r.cleaning_status === 'checked' && r.checkout_status === 'after');

  console.log(beforeCleanning)

  const tantouCleaningRoom = roomData.filter(e=> e.status==='æœªæ¸…æƒ'&&
  e.sub_status!=='stay_noclean'&&
  e.sub_status!=='stay_amenytyOnliy')
  const abertosRooms = roomData.filter(e=> e.open_flag===1)

    const L = t[currentLang];

    document.getElementById('cleansRooms').innerText= `${L.cleaningToDo}:${tantouCleaningRoom.length}`
    document.getElementById('cleansRoomsInitial').innerText = `${L.cleaningStarted}:${abertosRooms.length}`



  roomData.forEach(r => {
    if(r.room_number === '403'){
      console.log(r)
    }
    const card = document.createElement("div");
    card.className = "task-card";

    let bgColor = "#e0e0e0";
    let textColor = "#333";
    let iconHTML = "";
    let allowButtons = false;
    // let confirmdText =L.inspectorButtons.beforeChecked

// console.log(confirmdText)
//
// console.log(r)

    // ===============================
    //     ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»ãƒ­ãƒƒã‚¯åˆ¤å®š
    // ===============================

    // æ¸…æƒå‰ã®ç‰¹æ®ŠçŠ¶æ…‹
    // if(r.cleaning_status === 'checked'){
    //     bgColor = "#9d9a9a";
    // }else if (r.status === "before_check") {
    //   bgColor = "#b3e5ff";
    //   textColor = "#004a77";
    //   // iconHTML = `<img src="./img/bag.png" class="icon-img">`;
    // }

if(r.status==='æœªæ¸…æƒ' && r.sub_status !== 'stay_amenytyOnliy' && r.sub_status !== 'stay_noclean'){
  allowButtons = 'true'
}


    // ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã®ã¿
    if(r.sub_status === 'stay_amenytyOnliy'){
      bgColor = "#ffdfc2";
      iconHTML = `<img src="./img/bag.png" class="icon-img">`;
    }
//     }else if(r.excel_status === "S" && r.status === 'stay_noclean'){
//         bgColor = "#ff9d33";
//     }else if (r.excel_status === "S" && r.checkout_status === "before" && r.clean_flag==='æ¸…æƒ') {
//       bgColor = "#ff9d33";
//       allowButtons = false;
//
//       // iconHTML = `<img src="./img/seisou.png" class="icon-img">`;
//     }else if (r.excel_status === "S" && r.checkout_status === "before" && r.clean_flag==='æœªæ¸…æƒ') {
//       bgColor = "#ff9d33";
//       console.log(`è©²å½“${r.room_number}`)
// allowButtons = true
//     }

    // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‰ â†’ ç„¡åŠ¹çŠ¶æ…‹
    else if (r.checkout_time === null) {
      bgColor = "#cfcfcf";
      textColor = "#888";
      // allowButtons = false;
    }

    // afterï¼ˆS=é€£æ³Šï¼‰
    // else if (r.excel_status === "S" && r.checkout_status === "after") {
    //   bgColor = "#ffb974";
    //   // iconHTML = `<img src="./img/seisou.png" class="icon-img">`;
    // }
    //
    // // after é€šå¸¸
    // else if (r.checkout_status === "after") {
    //   bgColor = "#FFFFFF";
    //   // iconHTML = `<img src="./img/seisou.png" class="icon-img">`;
    // }

    let statusText = "";

    // cleaning_status ã®æ–‡å­—ã‚’è¡¨ç¤ºã™ã‚‹ãŒâ€¦
    // if (r.checkout_status !== "before") {
    //   statusText = t[currentLang].cleaningStatusLabel?.[r.cleaning_status] || "";
    // }

    if(r.stay_type==='individual'){
      iconHTML += `<img src="./img/esponja.png" class="icon-img">`;
    }


    // ãƒ‡ã‚¶ã‚¤ãƒ³é©ç”¨
    card.style.backgroundColor = bgColor;
    card.style.color = textColor;



    // if (!allowButtons) {
    //   card.classList.add("disabled-card");
    // }

    // ===============================
    //     3ã¤ã®ãƒœã‚¿ãƒ³ï¼ˆç¢ºèªè€…ç”¨ï¼‰
    // ===============================
    let buttonHTML = ''
    let verificarHtml = '';


        if(r.checked_done_at){
          console.log(`r.cleaning_status`,r.cleaning_status)
          console.log('nazeda')
          verificarHtml =
          ` <div id="confirmed-text-mother"class="confirmed-text-mother">
              <span id="confirmid-text">${t[currentLang].inspectorButtons.checked}</span>
            </div>
          `
          allowButtons =false
        }else{
          buttonHTML = getButtonsByStatus(r, currentLang);
        }

    // --- è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿å–å¾— ---
    const amenitysGet = globalAmenitys.filter(a => a.room_number === r.room_number&&a.status!=='done');
    // console.log(amenitysGet)

    // --- è¦³å¯Ÿãƒœã‚¿ãƒ³ï¼ˆå¤šè¨€èªå¯¾å¿œï¼‰ ---
    let observBadgeHTML = "";
    if (amenitysGet.length > 0) {

      const taskText = amenitysGet
        .map(a => buildAmenityTaskText(a))
        .join("<br>");

      observBadgeHTML = `
        <span class="task-badge" data-room="${r.room_number}">
          ${taskText}
        </span>
      `;
    }

    if(r.notes){
      console.log(r.notes)
      observBadgeHTML = `
        <span class="task-badge" data-room="${r.room_number}">
          ${r.notes}
        </span>
      `;
    }
        // console.log(r)
        card.innerHTML = `
          <div class="task-room-header">
            <span class="room-number">${r.room_number}</span>
            ${observBadgeHTML}
            <div class="icon-area">${iconHTML}</div>
          </div>

          ${buttonHTML}

          ${verificarHtml}



        `;


    // // ===============================
    // //     HTML ã‚»ãƒƒãƒˆ
    // // ===============================
    //
    // card.innerHTML = `
    //   <div class="task-room-header">
    //     <span class="room-number">${r.room_number}</span>
    //     <div class="status-text">${statusText}</div>
    //
    //   </div>
    //   ${buttonHTML}
    // `;

    container.appendChild(card);

    // ===============================
    //     ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸ï¼ˆå®‰å…¨ç‰ˆï¼‰
    // ===============================

// console.log(r)

    if (!allowButtons) return; // ãƒœã‚¿ãƒ³ç„¡åŠ¹æ™‚ã¯çµ‚äº†
    const btnRevert  = card.querySelector(".revert-btn");
    const btnDone    = card.querySelector(".done-btn");
    const btnChecked = card.querySelector(".checked-btn");

    if(r.cleaning_status !== 'checked' && r.status !== 'stay_amenytyOnliy'){
      // console.log('kokomade kitenai')
      btnChecked.innerText = L.inspectorButtons.beforeChecked
    }



    if (btnRevert)  btnRevert.addEventListener("click", () => inspectorRevert(r.id,r));
    if (btnDone)    btnDone.addEventListener("click", () => inspectorDone(r.id,r));
    if (btnChecked) btnChecked.addEventListener("click", () => inspectorChecked(r.id,r));


  });
}

function getButtonsByStatus(r, lang) {


  // ğŸ”¹ checkout_status === "before" ã¯ãƒœã‚¿ãƒ³ãªã—
  if (r.sub_status === "stay_amenytyOnliy" || r.sub_status === "stay_noclean" || r.status!=='æœªæ¸…æƒ') {
    return "";
  }

  // console.log(r)
  let yetPress = false



  if (r.cleaning_done_at  === null) {
    yetPress = true
  }


  const disabledAttr = yetPress ? "disabled" : "";
  const disabledClass = yetPress ? "disabled-btn" : "";

  if (r.cleaning_status !== "done") {
    return `
      <div class="task-buttons">

        <button class="btn checked-btn ${disabledClass}" ${disabledAttr} data-id="${r.id}">
          ${t[lang].inspectorButtons.beforeChecked}
        </button>
      </div>
    `;
  }

  if (r.cleaning_status === "done") {
    return `
      <div class="task-buttons">

        <button class="btn checked-btn ${disabledClass}" ${disabledAttr} data-id="${r.id}">
          ${t[lang].inspectorButtons.checked}
        </button>
      </div>
    `;
  }


  return "";
}


function inspectorDone(roomId) {
  updateRoomLocalStatus(roomId, "done");
  refreshTasks();

  withLoading(() =>
    fetch(`${API_URL}/api/room/cleaning/finish`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId })
    })
  );
}

function inspectorChecked(roomId,r) {

  console.log(r)

  const now = new Date();

  r.checked_done_at = now
  // â‘  ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  // updateRoomLocalStatus(roomId, "checked");

  // â‘¡ UIã‚’å³åæ˜ 
  refreshTasks();

  // â‘¢ ã‚µãƒ¼ãƒãƒ¼ã¸æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆéåŒæœŸï¼‰
  withLoading(() =>
    fetch(`${API_URL}/api/room/inspector/checked`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room_id: roomId,
        operator_id: operatorId,
        room_number:r.room_number   // â† è¿½åŠ ï¼ï¼
      })
    })
  );
}





function startCleaning(roomId) {
  console.log("Start cleaning:", roomId);

  // UIå³æ™‚æ›´æ–°
  updateRoomLocalStatus(roomId, "in_progress");
  refreshTasks();

  // é€šä¿¡æ™‚ã ã‘Loading
  withLoading(() =>
    fetch(`${API_URL}/api/room/cleaning/start`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId })
    })
  );
}

function finishCleaning(roomId) {
  console.log("Finish cleaning:", roomId);

  updateRoomLocalStatus(roomId, "done");
  refreshTasks();

  withLoading(() =>
    fetch(`${API_URL}/api/room/cleaning/finish`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId })
    })
  );
}


function undoCleaning(roomId) {
  console.log("Undo cleaning:", roomId);

  updateRoomLocalStatus(roomId, "not_started");
  refreshTasks();

  withLoading(() =>
    fetch(`${API_URL}/api/room/cleaning/undo`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId })
    })
  );
}

function inspectorRevert(roomId) {
  updateRoomLocalStatus(roomId, "not_started");
  refreshTasks();

  withLoading(() =>
    fetch(`${API_URL}/api/room/cleaning/undo`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId })
    })
  );
}




function updateRoomLocalStatus(roomId, newStatus) {
  // è¡¨ç¤ºç”¨
  // const r1 = globalRoomsData.find(r => r.id === roomId);
  // if (r1) r1.cleaning_status = newStatus;
  //
  // // å…ƒãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°ï¼ˆå‰Šã‚Œãªã„ï¼‰
  // const r2 = originalRoomsData.find(r => r.id === roomId);
  // if (r2) r2.cleaning_status = newStatus;
}



function refreshTasks() {
  console.log(`refreshTasks`)
  applyFilters()
  renderRoomTasks(globalRoomsData);
}


async function withLoading(promiseFunc) {
  try {
    showLoading();
    const result = await promiseFunc();
    return result;
  } catch (err) {
    console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
    throw err;
  } finally {
    hideLoading();
  }
}

// ========================
// ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼ˆ17:00ã€œç¿Œ07:00ï¼‰3è¨€èªè¡¨ç¤ºç‰ˆ
// ========================
function checkAccessTime() {
  const now = new Date();
  const hour = now.getHours();

  // å¤œé–“ (17:00ã€œ23:59) ã¾ãŸã¯ æœæ–¹ (0:00ã€œ6:59) ã¯ãƒ­ãƒƒã‚¯
  if (hour >= 17 || hour < 7) {
    const currentTime = now.toLocaleTimeString('ja-JP', {
      hour: '2-digit',
      minute: '2-digit'
    });

    document.body.innerHTML = `
      <div style="
        display:flex;
        justify-content:center;
        align-items:center;
        flex-direction:column;
        height:100vh;
        background:#f8f9fa;
        color:#333;
        font-family:'Noto Sans JP',sans-serif;
        text-align:center;
        line-height:1.8;
        padding:20px;
        overflow: auto;
      ">
        <!-- ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª -->
        <h2 style="margin-bottom:10px;">â° ç¾åœ¨ã¯ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨æ™‚é–“å¤–ã§ã™</h2>
        <p>åˆ©ç”¨å¯èƒ½æ™‚é–“ï¼š07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» ç¾åœ¨æ™‚åˆ»ï¼š${currentTime}</p>

        <hr style="width:60%;margin:20px 0;border:none;border-top:1px solid #ccc;">

        <!-- ğŸ‡§ğŸ‡· ãƒãƒ«ãƒˆã‚¬ãƒ«èª -->
        <h3 style="margin-bottom:6px;">â° O sistema estÃ¡ indisponÃ­vel no momento</h3>
        <p>HorÃ¡rio de uso: 07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» Hora atual: ${currentTime}</p>

        <hr style="width:60%;margin:20px 0;border:none;border-top:1px solid #ccc;">

        <!-- ğŸ‡ºğŸ‡¸ è‹±èª -->
        <h3 style="margin-bottom:6px;">â° System is currently unavailable</h3>
        <p>Available hours: 07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» Current time: ${currentTime}</p>

        <hr style="width:60%;margin:20px 0;border:none;border-top:1px solid #ccc;">

        <!-- ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³èª -->
        <h3 style="margin-bottom:6px;">â° El sistema no estÃ¡ disponible en este momento</h3>
        <p>Horario de uso: 07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» Hora actual: ${currentTime}</p>
      </div>
    `;

    // å‡¦ç†åœæ­¢
    throw new Error("Access restricted during night hours.");
  }
}

function applyFilters() {
  const floorSelectEl = document.getElementById("floorSelect");
  const selectedFloor = floorSelectEl.value;

  // const modeCleaning = document.getElementById("btnShowCleaning").classList.contains("active");
  // const modeAmenity  = document.getElementById("btnShowAmenity").classList.contains("active");

  // â­ å¿…ãš originalRoomsData ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å§‹ã‚ã‚‹ï¼ï¼
  console.log(`globalRoomsData`,globalRoomsData)
  let filtered = [...globalRoomsData];

  // â‘  ãƒ•ãƒ­ã‚¢
  if (selectedFloor !== "all") {
    filtered = filtered.filter(r => String(r.floor) === selectedFloor);
  }

  // â‘¡ æ¸…æƒã ã‘

    // filtered = filtered.filter(r =>
    //   r.checkout_status === "after" ||
    //   r.status === "before_check" ||
    //   ["not_started","in_progress","done"].includes(r.cleaning_status)
    // );


  // // â‘¢ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã ã‘
  // if (!modeCleaning && modeAmenity) {
  //   filtered = filtered.filter(r => r.status === "stay_amenytyOnliy");
  // }
  //
  // // â‘£ å…¨ãƒ•ãƒ­ã‚¢ + æ¸…æƒ + ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ â†’ å…¨è¡¨ç¤º
  // if (selectedFloor === "all" && modeCleaning && modeAmenity) {
  //   filtered = [...originalRoomsData];
  // }

  globalRoomsData = filtered;  // â† è¡¨ç¤ºç”¨ã ã‘æ›´æ–°
  renderRoomTasks(filtered);
}

// function renderAmenityTasks(amenityData) {
//   const lang = currentLang || "ja";
//   const L = t[lang];
//
//   // ğŸ”¹ ã‚³ãƒ³ãƒ†ãƒŠç¢ºèªï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰
//   let amenityContainer = document.getElementById("amenityContainer");
//   if (!amenityContainer) {
//     amenityContainer = document.createElement("div");
//     amenityContainer.id = "amenityContainer";
//     document.body.appendChild(amenityContainer);
//   }
//
//   amenityContainer.innerHTML = `
//     <h2 style="margin:15px 0 10px;">ğŸ§´ ${L.amenity}</h2>
//   `;
//
//   if (!amenityData || amenityData.length === 0) {
//     amenityContainer.innerHTML += `
//       <p style="text-align:center;color:#666;">${L.noTask}</p>
//     `;
//     return;
//   }
//
//   amenityData.forEach(a => {
//     const card = document.createElement("div");
//     card.className = "task-card";
//     // card.style.background = "#ffe7ba";
//
//     const key = amenityNameToKey[a.amenity] || null;
//     const displayName = key ? L.amenityListFixed[key] : a.amenity;
//
//     const actionKey = actionTypeToKey[a.action_type];
//     const actionLabel = actionKey
//       ? t[currentLang].amenityTypes[actionKey]
//       : a.action_type;
//
//     card.innerHTML = `
//       <div class="task-room-header">
//         <span class="room-number">${a.room_number}</span>
//
//       </div>
//
//       <div style="padding:6px 12px;font-size:15px;">
//         <div><b>${displayName}</b></div>
//         <div>${actionLabel}</div>
//         ${a.return_to ? `<div>${a.return_to}</div>` : ""}
//       </div>
//
//       <div class="task-buttons">
//         <button class="btn done-btn" data-id="${a.id}">
//           ${t[currentLang].complete}
//         </button>
//       </div>
//     `;
//
//
//
//     card.querySelector(".done-btn")
//       .addEventListener("click", () => finishAmenity(a.id));
//
//     amenityContainer.appendChild(card);
//   });
// }

// function finishAmenity(amenityId) {
//   console.log("Amenity Complete:", amenityId);
//
//   withLoading(() =>
//     fetch(`${API_URL}/api/room/amenity/${amenityId}`, {
//       method: "DELETE"
//     })
//   ).then(() => {
//     // UI ã‹ã‚‰å‰Šé™¤
//     globalAmenityData = globalAmenityData.filter(a => a.id !== amenityId);
//     renderAmenityTasks(globalAmenityData);
//   });
// }



// ========================
refreshBtn.addEventListener("click", loadTasks);
applyLang();
loadTasks();
</script>
</body>
</html>
