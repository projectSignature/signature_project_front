<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operator Tasks</title>
<link rel="stylesheet" href="./operator.css">

</head>
<body>
  <header>
    <select id="langSelect">
      <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
      <option value="pt">ğŸ‡§ğŸ‡· PortuguÃªs</option>
      <option value="en">ğŸ‡ºğŸ‡¸ English</option>
      <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>

    </select>
    <span id="headerTitle">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚¿ã‚¹ã‚¯</span>
    <button id="refreshBtn">ğŸ”„ æ›´æ–°</button>
  </header>

  <!-- ğŸŸ¢ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢è¿½åŠ  -->
  <div id="filterBar" style="display:flex;justify-content:center;align-items:center;gap:10px;padding:8px 0;background:#eef3f8;">
    <select id="floorSelect" style="display: none;padding:6px 10px;border-radius:8px;border:1px solid #ccc;">
      <option value="all">å…¨ãƒ•ãƒ­ã‚¢</option>
      <option value="4">4F</option>
      <option value="5">5F</option>
      <option value="6">6F</option>
      <option value="7">7F</option>
      <option value="8">8F</option>
      <option value="9">9F</option>
      <option value="10">10F</option>
      <option value="11">11F</option>
      <option value="12">12F</option>
    </select>
    <div id="summaryContainer">
      <div id="cleansRooms" class="summary-box"></div>
      <div id="cleansRoomsInitial" class="summary-box"></div>
    </div>
    <div>
      <button id="desfazerBtn">desfazer</button>

    </div>


    <button id="btnShowCleaning" style='display:none' class="filter-btn active">ğŸ§¹ æ¸…æƒ</button>
    <button id="btnShowAmenity" style='display:none'  class="filter-btn">ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£</button>

  </div>




  <div id="taskContainer"></div>

  <!-- ğŸ”¥ è¦³å¯Ÿãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="observModal" class="hidden">
    <div class="observ-content">
      <h3 id="observModalTitle"></h3>

      <div id="observText"></div>

      <button id="observDoneBtn" class="observ-done-btn"></button>
      <button id="observCloseBtn" class="observ-close-btn"></button>
    </div>
  </div>

  <!-- ğŸ”¥ Undo Modal -->
  <div id="undoModal" class="hidden">
    <div class="undo-modal-content">

      <h3 style="text-align:center;margin-bottom:10px;">Selecione os quartos</h3>

      <div id="undoRoomList"></div>

      <button id="undoApplyBtn" class="undo-apply-btn">Desfazer</button>
      <button id="undoCloseBtn" class="undo-close-btn">Fechar</button>
    </div>
  </div>






<div id="loadingOverlay">
  <div class="loader"></div>
  <div id="loadingText">Loading...</div>
</div>

<script>

const API_URL = `https://squid-app-ug7x6.ondigitalocean.app`
let userRole = ``
// const API_URL = `http://localhost:3000`


// èªè¨¼ãƒã‚§ãƒƒã‚¯
const token = localStorage.getItem("authToken");
let decoded = JSON.parse(atob(token.split('.')[1]));
// const decoded = JSON.parse(atob(token.split('.')[1]));

if (!token) {
  // ãƒˆãƒ¼ã‚¯ãƒ³ãªã— â†’ ãƒ­ã‚°ã‚¤ãƒ³ã¸å¼·åˆ¶é€é‚„
  window.location.href = "../index.html";
} else {
  try {
     decoded = JSON.parse(atob(token.split('.')[1]));

    // ãƒ‡ã‚³ãƒ¼ãƒ‰æˆåŠŸ â†’ decoded ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«æŒãŸã›ã‚‹
    window.decodedUser = decoded;

    userRole = decoded.role
    // userRole = `staffManeger`
    // userRole = `staff`

    // console.log("ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:", decoded);

    // ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
    const now = Math.floor(Date.now() / 1000);
    if (decoded.exp < now) {
      localStorage.removeItem("authToken");
      alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
      window.location.href = "../index.html";
    }

  } catch (e) {
    // console.error("ãƒˆãƒ¼ã‚¯ãƒ³è§£æã‚¨ãƒ©ãƒ¼:", e);

    // ãƒˆãƒ¼ã‚¯ãƒ³ç ´æ â†’ å‰Šé™¤ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã¸
    localStorage.removeItem("authToken");
    window.location.href = "../index.html";
  }
}


// console.log(decoded);
// ã“ã“ã«å…¨éƒ¨å…¥ã£ã¦ã‚‹
// { id, name, username, role, iat, exp }

const globalId = 1
// https://squid-app-ug7x6.ondigitalocean.app

// const API_ROOMS = `${API_URL}/api/room/daily_room_list?date=${date}&hotel_id=${hotel_id}`;
const API_AMENITIES = `${API_URL}/api/room/amenity/list`;
const API_UPDATE_STATUS = `${API_URL}/api/room/status`;
const API_DELETE_AMENITY = `${API_URL}/api/room/amenity`;

const container = document.getElementById("taskContainer");
const refreshBtn = document.getElementById("refreshBtn");
const langSelect = document.getElementById("langSelect");
const headerTitle = document.getElementById("headerTitle");

let currentLang = localStorage.getItem("lang") || "ja";
let originalRoomsData = [];
let globalRoomsData = []; // â† ã“ã‚Œã¯è¡¨ç¤ºç”¨ã«ã™ã‚‹
let globalAmenityData = [];  // â† ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ä½œæˆã—ã¦ãŠã
let originalAmenityData = [];




const loadingOverlay = document.getElementById("loadingOverlay");
const loadingText = document.getElementById("loadingText");

function showLoading() {
  loadingText.textContent = currentLang === "ja" ? "èª­ã¿è¾¼ã¿ä¸­..." :
                            currentLang === "pt" ? "Carregando..." :
                            "Loading...";
  loadingOverlay.classList.add("visible");
}
function hideLoading() {
  loadingOverlay.classList.remove("visible");
}

// ========================
// ğŸ”¹ ç¿»è¨³è¾æ›¸
// ========================
const t = {
  ja: {
    title: "RoomSync",
    refresh: "ğŸ”„ æ›´æ–°",
    cleaning: "æ¸…æƒ",
    amenity: "ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£",
    complete: "å®Œäº†",
    cleaningMsg: "æ¸…æƒã‚’å®Œäº†ã—ãŸã‚‰å ±å‘Šã—ã¦ãã ã•ã„ã€‚",
    noTask: "ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
    confirmCleaning: "æ¸…æƒã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ",
    confirmAmenity: "ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£å¯¾å¿œã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ",
    alertCleaningDone: "æ¸…æƒå®Œäº†ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚",
    alertAmenityDone: "ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£å¯¾å¿œã‚’å®Œäº†ã—ã¾ã—ãŸã€‚",
    fetchError: "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
    returnFront: "ãƒ•ãƒ­ãƒ³ãƒˆ",
    returnStorage: "å€‰åº«å®¤",
    amenityTypes: { exchange: "äº¤æ›", supply: "è£œå……", collect: "å›å" },
    amenitiesList: {
      pillow: "ã¾ãã‚‰",
      hanger: "ãƒãƒ³ã‚¬ãƒ¼",
      charger: "å……é›»å™¨",
      fan: "æ‰‡é¢¨æ©Ÿ",
      icepail: "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«",
      extCord: "å»¶é•·ã‚³ãƒ¼ãƒ‰",
      humidifier: "åŠ æ¹¿å™¨",
      smokeChange: "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ",

    },
    waitingApproval: "ï¼ˆç¢ºèªå¾…ã¡ï¼‰",
    allFloors: "å…¨ãƒ•ãƒ­ã‚¢",
cleaningBtn: "é–‹å§‹",
amenityBtn: "ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£",
undoBtn: "â¤º æˆ»ã™",
taskTitle: "ã‚¿ã‚¹ã‚¯",
amenityListFixed: {
  pillow: "ã¾ãã‚‰",
  hanger: "ãƒãƒ³ã‚¬ãƒ¼",
  charger: "å……é›»å™¨",
  fan: "æ‰‡é¢¨æ©Ÿ",
  icepail: "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«",
  extCord: "å»¶é•·ã‚³ãƒ¼ãƒ‰",
  humidifier: "åŠ æ¹¿å™¨",
  smokeChange: "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ",
},
actionTypesFixed: {
  supply: "è£œå……",
  collect: "å›å"
},
returnPlacesFixed: {
  front: "ãƒ•ãƒ­ãƒ³ãƒˆ",
  linen4: "4Fãƒªãƒãƒ³åº«",
  linen5: "5Fãƒªãƒãƒ³åº«",
  linen6: "6Fãƒªãƒãƒ³åº«",
  linen7: "7Fãƒªãƒãƒ³åº«",
  linen8: "8Fãƒªãƒãƒ³åº«",
  linen9: "9Fãƒªãƒãƒ³åº«",
  linen10: "10Fãƒªãƒãƒ³åº«",
  linen11: "11Fãƒªãƒãƒ³åº«",
  linen12: "12Fãƒªãƒãƒ³åº«",
},
cleaningToDo: "æƒé™¤å¯¾è±¡",
cleaningStarted: "é–‹å§‹æ¸ˆã¿",
observBtn: "è¦³å¯Ÿ",
observModalTitle: "è¦³å¯Ÿå†…å®¹",
observDone: "è¦³å¯Ÿã‚’å®Œäº†ã™ã‚‹",
 taskSentence: "%AMENITY% ã‚’%ACTION% â†’ %PLACE%ã¸",


  },
  pt: {
    title: "RoomSync",
    refresh: "ğŸ”„ Atualizar",
    cleaning: "Limpeza",
    amenity: "Amenity",
    complete: "Concluir",
    cleaningMsg: "Informe quando a limpeza for concluÃ­da.",
    noTask: "Nenhuma tarefa no momento.",
    confirmCleaning: "Deseja marcar a limpeza como concluÃ­da?",
    confirmAmenity: "Deseja marcar a amenidade como concluÃ­da?",
    alertCleaningDone: "Limpeza concluÃ­da com sucesso.",
    alertAmenityDone: "Amenidade concluÃ­da com sucesso.",
    fetchError: "Falha ao obter dados.",
    returnFront: "RecepÃ§Ã£o",
    returnStorage: "DepÃ³sito",
    amenityTypes: { exchange: "Troca", supply: "ReposiÃ§Ã£o", collect: "Coleta" },
    amenitiesList: {
      pillow: "Travesseiro",
      hanger: "Cabide",
      charger: "Carregador",
      fan: "Ventilador",
      icepail: "Balde de gelo",
      extCord: "ExtensÃ£o elÃ©trica",
      humidifier: "Umidificador",
      smokeChange: "Troca Fumante/NÃ£o Fumante",

    },
    waitingApproval: "(Aguardando aprovaÃ§Ã£o)",
    cleaningBtn: "Abrir",
    amenityBtn: "ğŸ§´ Amenidade",
    allFloors: "Todos os andares",
    undoBtn: "â¤º Desfazer",
    taskTitle: "Tarefas",
    amenityListFixed: {
  pillow: "Travesseiro",
  hanger: "Cabide",
  charger: "Carregador",
  fan: "Ventilador",
  icepail: "Balde de gelo",
  extCord: "ExtensÃ£o elÃ©trica",
  humidifier: "Umidificador",
  smokeChange: "Trocar fumante â†’ nÃ£o fumante",
},
actionTypesFixed: {
  supply: "ReposiÃ§Ã£o",
  collect: "Coleta"
},
cleaningToDo: "Para limpar",
cleaningStarted: "Abertos",
observBtn: "ObservaÃ§Ãµes",
observModalTitle: "Detalhes",
observDone: "Concluir observaÃ§Ã£o",
returnPlacesFixed: {
  front: "RecepÃ§Ã£o",
  linen4: "deposito 4F",
  linen5: "deposito 5F",
  linen6: "deposito 6F",
  linen7: "deposito 7F",
  linen8: "deposito 8F",
  linen9: "deposito 9F",
  linen10: "deposito 10F",
  linen11: "deposito 11F",
  linen12: "deposito 12F",
},
 taskSentence: "%ACTION% de %AMENITY% â†’ levar para %PLACE%",


  },
  en: {
    title: "RoomSync",
    refresh: "ğŸ”„ Refresh",
    cleaning: "Cleaning",
    amenity: "Amenity",
    complete: "Complete",
    cleaningMsg: "Please report when cleaning is done.",
    noTask: "No tasks at the moment.",
    confirmCleaning: "Mark cleaning as complete?",
    confirmAmenity: "Mark amenity as complete?",
    alertCleaningDone: "Cleaning marked as complete.",
    alertAmenityDone: "Amenity marked as complete.",
    fetchError: "Failed to fetch data.",
    returnFront: "Front Desk",
    returnStorage: "Storage Room",
    amenityTypes: { exchange: "Exchange", supply: "Supply", collect: "Collect" },
    amenitiesList: {
      pillow: "Pillow",
      hanger: "Hanger",
      charger: "Charger",
      fan: "Fan",
      icepail: "Ice pail",
      extCord: "Extension cord",
      humidifier: "Humidifier",
      smokeChange: "Smokingâ†’Non-smoking switch",

    },
    waitingApproval: "(Awaiting approval)",
    allFloors: "All Floors",
    cleaningBtn: "open",
    amenityBtn: "ğŸ§´ Amenity",
    undoBtn: "â¤º Undo",
    taskTitle: "Tasks",
    amenityListFixed: {
  pillow: "Pillow",
  hanger: "Hanger",
  charger: "Charger",
  fan: "Fan",
  icepail: "Ice pail",
  extCord: "Extension cord",
  humidifier: "Humidifier",
  smokeChange: "Smoking â†’ Non-smoking switch",
},
actionTypesFixed: {
  supply: "Supply",
  collect: "Collect"
},
returnPlacesFixed: {
  front: "Front Desk",
  linen4: "4F Linen Room",
  linen5: "5F Linen Room",
  linen6: "6F Linen Room",
  linen7: "7F Linen Room",
  linen8: "8F Linen Room",
  linen9: "9F Linen Room",
  linen10: "10F Linen Room",
  linen11: "11F Linen Room",
  linen12: "12F Linen Room",
},
cleaningToDo: "To clean",
cleaningStarted: "Started",
observBtn: "Observation",
observModalTitle: "Observation Details",
observDone: "Mark as Completed",
taskSentence: "Take %ACTION% of %AMENITY% â†’ to %PLACE%",

},
es: {
  title: "RoomSync",
  refresh: "ğŸ”„ Actualizar",
  cleaning: "Limpieza",
  amenity: "Amenidad",
  complete: "Completar",
  cleaningMsg: "Informe cuando la limpieza estÃ© terminada.",
  noTask: "No hay tareas por el momento.",
  confirmCleaning: "Â¿Marcar la limpieza como completada?",
  confirmAmenity: "Â¿Marcar la amenidad como completada?",
  alertCleaningDone: "Limpieza registrada como completada.",
  alertAmenityDone: "Amenidad registrada como completada.",
  fetchError: "Error al obtener los datos.",
  returnFront: "RecepciÃ³n",
  returnStorage: "DepÃ³sito",
  amenityTypes: { exchange: "Cambio", supply: "ReposiciÃ³n", collect: "RecolecciÃ³n" },
  amenitiesList: {
    pillow: "Almohada",
    hanger: "Percha",
    charger: "Cargador",
    fan: "Ventilador",
    icepail: "Cubo de hielo",
    extCord: "Cable de extensiÃ³n",
    humidifier: "Humidificador",
    smokeChange: "Cambio Fumador/No fumador",
  },
  waitingApproval: "(En espera de aprobaciÃ³n)",
  allFloors: "Todos los pisos",
  cleaningBtn: "abrir",
  amenityBtn: "ğŸ§´ Amenidad",
  undoBtn: "â¤º Deshacer",
  taskTitle: "Tareas",
  amenityListFixed: {
  pillow: "Almohada",
  hanger: "Percha",
  charger: "Cargador",
  fan: "Ventilador",
  icepail: "Cubo de hielo",
  extCord: "Cable de extensiÃ³n",
  humidifier: "Humidificador",
  smokeChange: "Cambio Fumador â†’ No fumador",
},
actionTypesFixed: {
  supply: "ReposiciÃ³n",
  collect: "RecolecciÃ³n"
},
cleaningToDo: "Para limpiar",
cleaningStarted: "Abiertos",
observBtn: "ObservaciÃ³n",
observModalTitle: "Detalles de observaciÃ³n",
observDone: "Marcar como completado",

},
returnPlacesFixed: {
  front: "RecepciÃ³n",
  linen4: "deposito 4F",
  linen5: "deposito 5F",
  linen6: "deposito 6F",
  linen7: "deposito 7F",
  linen8: "deposito 8F",
  linen9: "deposito 9F",
  linen10: "deposito 10F",
  linen11: "deposito 11F",
  linen12: "deposito 12F",
},
taskSentence: "%ACTION% de %AMENITY% â†’ llevar a %PLACE%",


};


const amenityKeys = [
  "pillow",
  "hanger",
  "charger",
  "fan",
  "icepail",
  "extCord",
  "humidifier",
  "smokeChange"
];

const amenityNameToKey = {
  "ã¾ãã‚‰": "pillow",
  "ãƒãƒ³ã‚¬ãƒ¼": "hanger",
  "å……é›»å™¨": "charger",
  "æ‰‡é¢¨æ©Ÿ": "fan",
  "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«": "icepail",
  "å»¶é•·ã‚³ãƒ¼ãƒ‰": "extCord",
  "åŠ æ¹¿å™¨": "humidifier",
  "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ": "smokeChange",
};

const actionTypeToKey = {
  "è£œå……": "supply",
  "å›å": "collect"
};

const returnPlaceToKey = {
  "ãƒ•ãƒ­ãƒ³ãƒˆ": "front",
  "front": "front",
  "4F ãƒªãƒãƒ³å®¤": "linen4",
  "5F ãƒªãƒãƒ³å®¤": "linen5",
  "6F ãƒªãƒãƒ³å®¤": "linen6",
  "7F ãƒªãƒãƒ³å®¤": "linen7",
  "8F ãƒªãƒãƒ³å®¤": "linen8",
  "9F ãƒªãƒãƒ³å®¤": "linen9",
  "10F ãƒªãƒãƒ³å®¤": "linen10",
  "11F ãƒªãƒãƒ³å®¤": "linen11",
  "12F ãƒªãƒãƒ³å®¤": "linen12",
};





const btnCleaning = document.getElementById("btnShowCleaning");
const btnAmenity  = document.getElementById("btnShowAmenity");
let globalAmenitys = ""
let beforeCleanning = []
let operatorId = decoded.id
// let operatorId = 11


// ========================
// ğŸ”¹ è¨€èªåæ˜ 
// ========================Abert
function applyLang() {
  headerTitle.textContent = t[currentLang].title;
  refreshBtn.textContent = t[currentLang].refresh;
  document.documentElement.lang = currentLang;
  localStorage.setItem("lang", currentLang);

  // ğŸŸ¢ ãƒ•ãƒ­ã‚¢é¸æŠã®å…ˆé ­ï¼ˆå…¨ãƒ•ãƒ­ã‚¢ï¼‰ã‚’ç¿»è¨³
  const floorSelect = document.getElementById("floorSelect");
  if (floorSelect) {
    floorSelect.options[0].text = t[currentLang].allFloors;
  }

  // // ğŸŸ¢ ãƒœã‚¿ãƒ³ç¿»è¨³
  // if (btnCleaning && btnAmenity) {
  //   btnCleaning.textContent = t[currentLang].taskTitle;
  //   btnAmenity.textContent = t[currentLang].amenityBtn;
  // }
}


langSelect.value = currentLang;
langSelect.addEventListener("change", () => {
  currentLang = langSelect.value;
  applyLang();
  loadTasks();
});


btnCleaning.addEventListener("click", () => {
  btnCleaning.classList.add("active");
  btnAmenity.classList.remove("active");
  applyFilters();
});

btnAmenity.addEventListener("click", () => {
  btnAmenity.classList.add("active");
  btnCleaning.classList.remove("active");
  applyFilters();
});

// =========================
// ğŸ¢ ãƒ•ãƒ­ã‚¢é¸æŠ
// =========================
document.getElementById("floorSelect").addEventListener("change", () => {
  applyFilters();
});

async function loadTasks() {
  showLoading();
  container.innerHTML = "";

  // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ YYYY-MM-DD ã§ä½œã‚‹
  const now = new Date();
   now.setHours(now.getHours() + 9);  // JSTè£œæ­£

   const date = now.toISOString().split("T")[0];  // JSTã®æ—¥ä»˜ "YYYY-MM-DD"

  // console.log(date);

  const API_ROOMS = `${API_URL}/api/room/daily_room_list?date=${date}&hotel_id=${globalId}`;
    // const API_ROOMS = `${API_URL}/api/room/daily_room_list?date=2025-12-08&hotel_id=${globalId}`;

  try {
    const [roomRes, amenityRes] = await Promise.all([
      fetch(API_ROOMS),
      fetch(API_AMENITIES)
    ]);
    const roomData = await roomRes.json();
    const amenityData = await amenityRes.json();
    globalAmenitys = amenityData.requests

    // operatorId = 11

    // console.log(roomData)
    //
    // console.log(operatorId)
    // console.log(globalAmenitys)
    beforeCleanning = roomData.rows.filter(e => e.assigned_staff_id === operatorId)

    // console.log(`beforeCleanning`,beforeCleanning)

    // // ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã®æ­£è¦åŒ–
    // const amenitys = amenityJson.requests || amenityJson || [];
    // globalAmenitys = amenitys;
    //
    // console.log(amenitys);

    // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿
    // const sortedRoomData = roomData.rows.sort((a, b) => a.id - b.id);
    // beforeCleanning = roomData.rows
    // originalRoomsData = [...sortedRoomData];
    // globalRoomsData   = [...sortedRoomData];
    //
    // console.log(sortedRoomData);

    // ç”»é¢æç”»
    renderRoomTasks(beforeCleanning);

  } finally {
    hideLoading();
  }
}


function buildAmenityTaskText(a) {
  let lang = currentLang
  const key = amenityNameToKey[a.amenity];
  const translatedName = key ? t[lang].amenitiesList[key] : a.amenity;
  const actKey = actionTypeToKey[a.action_type];
  const actTranslated = actKey ? t[lang].amenityTypes[actKey] : a.action_type;
  const rtnKey = returnPlaceToKey[a.return_to];
  const rtnTranslated = rtnKey ? t[lang].returnPlacesFixed[rtnKey] : a.return_to;
  // è¨€èªåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ç½®æ›
  return t[lang].taskSentence
    .replace("%AMENITY%", translatedName)
    .replace("%ACTION%", actTranslated)
    .replace("%PLACE%", rtnTranslated);
}


function renderRoomTasks(roomData) {

  roomData.sort((a, b) => (a.room_number-0) - (b.room_number-0));
  container.innerHTML = "";
  const lang = currentLang || "ja";
  const L = t[lang];

  // console.log(roomData)

  // <div id="summaryContainer">
  //   <div id="cleansRooms" class="summary-box"></div>
  //   <div id="cleansRoomsInitial" class="summary-box"></div>
  // </div>

  const tantouCleaningRoom = roomData.filter(e=> e.assigned_staff_id===operatorId && e.sub_status!=='stay_amenytyOnliy')
  const abertosRooms = roomData.filter(e=> e.open_flag===1|| e.checked_flag===1)
  console.log(roomData)

  document.getElementById('cleansRooms').innerText= `${L.cleaningToDo}:${tantouCleaningRoom.length}`
  document.getElementById('cleansRoomsInitial').innerText = `${L.cleaningStarted}:${abertosRooms.length}`

  roomData.forEach(r => {

    console.log(r)

    const checkOut = r.checkout_status === 'after' ? `` :`disabled`
    const checkOutFlg = r.checkout_status === 'after' ? true :false



    const card = document.createElement("div");
    card.className = "task-card";

    let bgColor = "#FFFFFF";
    let textColor = "#333";
    let iconHTML = "";
    let showButtons = true;
    let youseisouBeforeCheckOut = false
    let amenityOnliyRoom = false
    let textHTML = ''

    const amenityRoom = r.sub_status === 'stay_amenytyOnliy' ? true : false //ã“ã“ã§ã‚¹ãƒ†ãƒ¼ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã®ã¿ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‹

    const amenityClass =
  r.sub_status === 'stay_amenytyOnliy' ||
  r.sub_status === 'stay_clean';

  console.log(amenityClass)


    if (r.stay_type === 'individual') {
      iconHTML += `<img src="./img/esponja.png" class="icon-img">`;
    }

    let observBadgeHTML = "";
    if (r.notes) {
      const cleanNotes = r.notes.replace("ãã®ä»–ä¾é ¼ï¼š", "").trim();
      observBadgeHTML = `
        <span class="task-badge" data-room="${r.room_number}">
          ${cleanNotes}
        </span>
      `;
    }

    const getAmentys = globalAmenitys.filter(rm=> rm.room_number===r.room_number)

    if(getAmentys.length>0){
      getAmentys.forEach(a => {
        // console.log(a)
        const msg = a.action_type==='å›å'?`è¿”å´å…ˆ:${a.return_to}`:''
        const finalMsg = `${a.amenity}ã‚’${a.action_type} ${msg}`
        observBadgeHTML += `
          <span class="task-badge" data-room="${r.room_number}">
            ${finalMsg}
          </span>
        `;

      })
    }

    if (amenityRoom) {
      iconHTML = `<img src="./img/bag.png" class="icon-img">`;

    }


    card.style.backgroundColor = bgColor;
    card.style.color = textColor;



    // =======================
    // â‘£ ãƒœã‚¿ãƒ³HTML
    // =======================

    let buttonHTML = "";

    let open = false
    let showStart = false
    let showDone=false
    let amenityDone = false
    let limpostart = false

console.log(userRole)
// background-color:#1fa93b;
    if((r.checked_flag===1||r.amenity_complete_flag===1)||(userRole === `staff`&&r.cleaned_by!==null)){//å®Œäº†å½¢ã ã‹ã‚‰ã€ãƒ†ã‚­ã‚¹ãƒˆã®ã¿
        textHTML = `
        <div style="width:100%;text-align:right">
          <span style="

            color:green;
            padding:10px 12px;
            border-radius:10px;
            font-weight:bold;
            font-size:20px
          ">
            concluÃ­do
          </span>
        </div>

        `;
    }else{

      buttonHTML = `<div class="task-buttons">`;
      // console.log(`ã“ã“ã«å…¥ã‚‹ã‚ˆ`)
      const nextCheck = r.checked_flag===0 && r.cleaned_by!==null? true:false
      const nextSeisou = r.open_flag===1 && r.cleaned_by===null? true:false
      const nextOpen = r.open_flag===0?true:false
      const nextAmenityCheck = r.sub_status==='stay_amenytyOnliy'?true:false

      // console.log(`nextCheck`,nextCheck)
      // console.log(`nextSeisou`,nextSeisou)
      // console.log(`nextOpen`,nextOpen)

      // userRole='staff'

      if (nextSeisou && !nextAmenityCheck) {//Aberto mais sem regsitro de limpo => Aberto
        if(userRole==='staffManeger'){//Caso seja o operator2 ja mostramos o botao de concluir
          showDone = true
          buttonHTML += `
            <button class="btn done-btn" data-id="${r.id}">
              ${L.complete}
            </button>
          `;
          card.classList.add(`limpo-card`)
        }else{
          limpostart = true
          buttonHTML += `
            <button class="btn limpo-btn" data-id="${r.id}">
              Concluir
            </button>
          `;
        }



      }
      if (nextCheck && !nextAmenityCheck) {
        showDone = true;

        const isManager = userRole === 'staffManeger';

        buttonHTML += `
          <button
            class="btn done-btn ${isManager ? "" : "disabled-btn"}"
            data-id="${r.id}"
            ${isManager ? "" : "disabled"}
          >
            ${L.complete}
          </button>
        `;


      }

      if (nextAmenityCheck) {
        amenityDone = true
        buttonHTML += `
          <button class="btn done-btn-amenity" data-id="${r.id}">
            AMENITY
          </button>
        `;


      }

      if (nextOpen && !nextAmenityCheck) {
        open = true
        const disabledClass = r.checkout_status==='before' || r.checkout_status===null  ? " disabled-btn" : "";
        console.log(checkOut)
        buttonHTML += `
          <button class="btn open-btn" data-id="${r.id}" ${checkOut}>
            ${L.cleaningBtn}
          </button>
        `;


      }

      buttonHTML += `</div>`;
      if (!amenityRoom) card.classList.add("quarto-pendente");

    }

    card.innerHTML = `
      <div class="task-room-header">
      <div style="display:flex">
        <span class="room-number">${r.room_number}</span>
        <div class="icon-area">${iconHTML}</div>
      </div>

       ${buttonHTML}
       ${textHTML}

      </div>

    `;

    if (open) {
      const btn = card.querySelector(".open-btn");
      btn.addEventListener("click", () => startCleaning(r.id,r.room_number,r));
    }
    // userRole==='staffManeger')
    if(limpostart){
      card.querySelector(".limpo-btn")
        .addEventListener("click", () => limpoEsperarVerificar(r.id,r.room_number,r));
    }
    if (showDone) {
      card.querySelector(".done-btn")
        .addEventListener("click", () => finishCleaning(r.id,r.room_number,r));
    }
    if (amenityDone) {
      card.querySelector(".done-btn-amenity")
        .addEventListener("click", () => finishAmenity(r.id,r.room_number,r));
    }
    if(amenityClass){
      card.classList.add(`amenityOnlyRoom`);
      card.classList.remove('amenityClass')
    }

    if(!checkOutFlg){
      card.classList.add('notCheckOut')
    }
    // æœ€å¾Œã«è¿½åŠ 
    container.appendChild(card);
  });
}


async function startCleaning(roomId,number,r) {
  // console.log("Start cleaning:", roomId);

  if(!operatorId)return

  r.open_flag = 1

  // console.log(r)

  // UIå³æ™‚æ›´æ–°
  // updateRoomLocalStatus(roomId, "in_progress");
  // refreshTasks();


  // console.log()
showLoading()
  await handleStatusChange(roomId,'aberto')
    loadTasks()

}


async function finishCleaning(roomId,number,r) {
  console.log('kok')
  showLoading()

if(userRole==='staffManeger'){
  await   handleStatusChange(roomId,'limpo',number)
  await  handleStatusChange(roomId,'verificado',number)

}else{
  await  handleStatusChange(roomId,'limpo',number)

}
  loadTasks()
    hideLoading()
}

async function limpoEsperarVerificar (roomId,number,r){
  console.log(`kokoko222`)
    showLoading()
await handleStatusChange(roomId,'limpo',number)
  loadTasks()
    hideLoading()
}

function undoCleaning(roomId) {
  // console.log("Undo cleaning:", roomId);

  updateRoomLocalStatus(roomId, "not_started");
  refreshTasks();

  withLoading(() =>
    fetch(`${API_URL}/api/room/cleaning/undo`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId })
    })
  );
}



function updateRoomLocalStatus(roomId, newStatus) {
  // è¡¨ç¤ºç”¨
  const r1 = globalRoomsData.find(r => r.id === roomId);
  if (r1) r1.cleaning_status = newStatus;

  // å…ƒãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°ï¼ˆå‰Šã‚Œãªã„ï¼‰
  const r2 = originalRoomsData.find(r => r.id === roomId);
  if (r2) r2.cleaning_status = newStatus;
}



function refreshTasks() {
  applyFilters()
  renderRoomTasks(globalRoomsData);
}


async function withLoading(promiseFunc) {
  try {
    showLoading();
    const result = await promiseFunc();
    return result;
  } catch (err) {
    console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
    throw err;
  } finally {
    hideLoading();
  }
}

// ========================
// ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼ˆ17:00ã€œç¿Œ07:00ï¼‰3è¨€èªè¡¨ç¤ºç‰ˆ
// ========================
function checkAccessTime() {
  const now = new Date();
  const hour = now.getHours();

  // å¤œé–“ (17:00ã€œ23:59) ã¾ãŸã¯ æœæ–¹ (0:00ã€œ6:59) ã¯ãƒ­ãƒƒã‚¯
  if (hour >= 17 || hour < 7) {
    const currentTime = now.toLocaleTimeString('ja-JP', {
      hour: '2-digit',
      minute: '2-digit'
    });

    document.body.innerHTML = `
      <div style="
        display:flex;
        justify-content:center;
        align-items:center;
        flex-direction:column;
        height:100vh;
        background:#f8f9fa;
        color:#333;
        font-family:'Noto Sans JP',sans-serif;
        text-align:center;
        line-height:1.8;
        padding:20px;
        overflow: auto;
      ">
        <!-- ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª -->
        <h2 style="margin-bottom:10px;">â° ç¾åœ¨ã¯ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨æ™‚é–“å¤–ã§ã™</h2>
        <p>åˆ©ç”¨å¯èƒ½æ™‚é–“ï¼š07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» ç¾åœ¨æ™‚åˆ»ï¼š${currentTime}</p>

        <hr style="width:60%;margin:20px 0;border:none;border-top:1px solid #ccc;">

        <!-- ğŸ‡§ğŸ‡· ãƒãƒ«ãƒˆã‚¬ãƒ«èª -->
        <h3 style="margin-bottom:6px;">â° O sistema estÃ¡ indisponÃ­vel no momento</h3>
        <p>HorÃ¡rio de uso: 07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» Hora atual: ${currentTime}</p>

        <hr style="width:60%;margin:20px 0;border:none;border-top:1px solid #ccc;">

        <!-- ğŸ‡ºğŸ‡¸ è‹±èª -->
        <h3 style="margin-bottom:6px;">â° System is currently unavailable</h3>
        <p>Available hours: 07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» Current time: ${currentTime}</p>

        <hr style="width:60%;margin:20px 0;border:none;border-top:1px solid #ccc;">

        <!-- ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³èª -->
        <h3 style="margin-bottom:6px;">â° El sistema no estÃ¡ disponible en este momento</h3>
        <p>Horario de uso: 07:00ã€œ17:00</p>
        <p style="font-size:13px;color:#666;">â€» Hora actual: ${currentTime}</p>
      </div>
    `;

    // å‡¦ç†åœæ­¢
    throw new Error("Access restricted during night hours.");
  }
}

function applyFilters() {
  const floorSelectEl = document.getElementById("floorSelect");
  const selectedFloor = floorSelectEl.value;

  const modeCleaning = document.getElementById("btnShowCleaning").classList.contains("active");
  const modeAmenity  = document.getElementById("btnShowAmenity").classList.contains("active");

  // â­ å¿…ãš originalRoomsData ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å§‹ã‚ã‚‹ï¼ï¼
  let filtered = [...beforeCleanning];

  // console.log(`filtered`,filtered)

  // â‘  ãƒ•ãƒ­ã‚¢
  if (selectedFloor !== "all") {
    filtered = filtered.filter(r => String(r.floor) === selectedFloor);
  }

  // // â‘¡ æ¸…æƒã ã‘
  // if (modeCleaning && !modeAmenity) {
  //   filtered = filtered.filter(r =>
  //     r.checkout_status === "after" ||
  //     r.status === "before_check" ||
  //     ["not_started","in_progress","done"].includes(r.cleaning_status)
  //   );
  // }
  //
  // // â‘¢ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã ã‘
  // if (!modeCleaning && modeAmenity) {
  //   filtered = filtered.filter(r => r.status === "stay_amenytyOnliy");
  // }

  // â‘£ å…¨ãƒ•ãƒ­ã‚¢ + æ¸…æƒ + ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ â†’ å…¨è¡¨ç¤º
  if (selectedFloor === "all" && modeCleaning && modeAmenity) {
    filtered = [...originalRoomsData];
  }

  globalRoomsData = filtered;  // â† è¡¨ç¤ºç”¨ã ã‘æ›´æ–°
  renderRoomTasks(filtered);
}

// function renderAmenityTasks(amenityData) {
//   const lang = currentLang || "ja";
//   const L = t[lang];
//
//   // ğŸ”¹ ã‚³ãƒ³ãƒ†ãƒŠç¢ºèªï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰
//   let amenityContainer = document.getElementById("amenityContainer");
//   if (!amenityContainer) {
//     amenityContainer = document.createElement("div");
//     amenityContainer.id = "amenityContainer";
//     document.body.appendChild(amenityContainer);
//   }
//
//   amenityContainer.innerHTML = `
//     <h2 style="margin:15px 0 10px;">ğŸ§´ ${L.amenity}</h2>
//   `;
//
//   if (!amenityData || amenityData.length === 0) {
//     amenityContainer.innerHTML += `
//       <p style="text-align:center;color:#666;">${L.noTask}</p>
//     `;
//     return;
//   }
//
//   amenityData.forEach(a => {
//     const card = document.createElement("div");
//     card.className = "task-card";
//     // card.style.background = "#ffe7ba";
//
//     const key = amenityNameToKey[a.amenity] || null;
//     const displayName = key ? L.amenityListFixed[key] : a.amenity;
//
//     const actionKey = actionTypeToKey[a.action_type];
//     const actionLabel = actionKey
//       ? t[currentLang].amenityTypes[actionKey]
//       : a.action_type;
//
//     card.innerHTML = `
//       <div class="task-room-header">
//         <span class="room-number">${a.room_number}</span>
//
//       </div>
//
//       <div style="padding:6px 12px;font-size:15px;">
//         <div><b>${displayName}</b></div>
//         <div>${actionLabel}</div>
//         ${a.return_to ? `<div>${a.return_to}</div>` : ""}
//       </div>
//
//       <div class="task-buttons">
//         <button class="btn done-btn" data-id="${a.id}">
//           ${t[currentLang].complete}
//         </button>
//       </div>
//     `;
//
//
//
//     card.querySelector(".done-btn")
//       .addEventListener("click", () => finishAmenity(a.id));
//
//     amenityContainer.appendChild(card);
//   });
// }

async function finishAmenity(roomId,number,r) {

showLoading()
  await handleStatusChange(roomId,'done',number)


  loadTasks()

    hideLoading()

}

// document.addEventListener("click", async (e) => {
//   // è¦³å¯Ÿãƒœã‚¿ãƒ³æŠ¼ã•ã‚ŒãŸï¼Ÿ
//   console.log('amenityCheck')
//   if (e.target.classList.contains("observ-btn")) {
//     const roomNo = e.target.dataset.room;
//
//     const data = globalAmenitys.filter(a => a.room_number === roomNo);
//
//     // å†…å®¹ã‚’å·®ã—è¾¼ã‚€
//     const html = data.map(a => {
//       // â–¼ action_type ç¿»è¨³
//       const atKey = actionTypeToKey[a.action_type] || a.action_type;
//       const actionTranslated = t[currentLang].amenityTypes[atKey] || a.action_type;
//
//       // â–¼ return_to ç¿»è¨³
//       const rtnKey = returnPlaceToKey[a.return_to] || null;
//       console.log(t[currentLang].returnPlacesFixed)
//       console.log(rtnKey)
//       console.log(returnPlaceToKey)
//       console.log(a.return_to)
//       const returnTranslated = rtnKey ? t[currentLang].returnPlacesFixed[rtnKey] : a.return_to;
//
//       // â–¼ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£å ç¿»è¨³ï¼ˆå‰å›ä½œæˆï¼‰
//       const amKey = amenityNameToKey[a.amenity] || null;
//       const amenityTranslated = amKey ? t[currentLang].amenitiesList[amKey] : a.amenity;
//
//       return `
//         <div class="observ-item">
//           <b>${t[currentLang].amenity}:</b> ${amenityTranslated}<br>
//
//           <b>${t[currentLang].amenityTypes[atKey] || a.action_type}:</b><br>
//
//           <b>${t[currentLang].returnFront}: </b>${returnTranslated}<br>
//
//
//           <hr>
//         </div>
//       `;
//     }).join("");
//
//
//     document.getElementById("observText").innerHTML = html;
//
//     // å¤šè¨€èªãƒ©ãƒ™ãƒ«é©ç”¨
//     document.getElementById("observModalTitle").textContent = t[currentLang].observModalTitle;
//     document.getElementById("observDoneBtn").textContent = t[currentLang].observDone;
//     document.getElementById("observCloseBtn").textContent = "âœ– " + t[currentLang].undoBtn;
//
//     // å®Œäº†ã® roomNo ä¿å­˜
//     document.getElementById("observDoneBtn").dataset.room = roomNo;
//
//     // é–‹ã
//     document.getElementById("observModal").classList.remove("hidden");
//   }
//
//   // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
//   if (e.target.id === "observCloseBtn") {
//     document.getElementById("observModal").classList.add("hidden");
//   }
//
//   // å®Œäº†ãƒœã‚¿ãƒ³
//   if (e.target.id === "observDoneBtn") {
//     const roomNo = e.target.dataset.room;
//
//     await finishAmenity(roomNo);
//
//     document.getElementById("observModal").classList.add("hidden");
//     refreshTasks();
//   }
// });

async function handleStatusChange(roomId, newStatus,roomNumber) {
  // console.log("ğŸ“Œ handleStatusChange", roomId, newStatus);

  // ãƒãƒƒãƒ•ã‚¡ãªã©ã‚ãªãŸã®æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯
  // checkoutBuffer[roomId] = newStatus;

  // é€ä¿¡ãƒ‡ãƒ¼ã‚¿æº–å‚™
  const payload = {
    id: roomId,
    status: newStatus,
    user_id: operatorId,   // â† cleaning/checked ç”¨ï¼ˆå¿…è¦ãªã‚‰ï¼‰
    roomNumber:roomNumber,
    hotelId:globalId
  };
  // console.log(payload)
  // return
  // APIé€ä¿¡
  const res = await fetch(`${API_URL}/api/room/update_status`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  const data = await res.json();
  // console.log("ğŸ”¥ update response:", data);

}


async function openUndoModal() {

  await loadTasks()
  const modal = document.getElementById("undoModal");
  const list = document.getElementById("undoRoomList");

  list.innerHTML = "";

  // console.log("ğŸ“Œ beforeCleanning:", beforeCleanning);

  beforeCleanning.forEach(room => {
    // console.log(room)
    if(room.checked_flag){
      return
    }
    const div = document.createElement("div");
    div.className = "undo-room-card";
    div.dataset.id = room.id;

    div.innerHTML = `
      <span>Quarto ${room.room_number}</span>
      <input type="checkbox" class="undo-check" />
    `;

    list.appendChild(div);
  });

  modal.classList.remove("hidden");
}

/* ğŸŸ¦ å‹•çš„ç”Ÿæˆã‚«ãƒ¼ãƒ‰ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã¤ã‘ã‚‹ï¼ˆã“ã‚ŒãŒé‡è¦ï¼‰ */
document.addEventListener("click", (e) => {
  const card = e.target.closest(".undo-room-card");
  if (!card) return;

  card.classList.toggle("selected");

  const checkbox = card.querySelector(".undo-check");
  checkbox.checked = card.classList.contains("selected");
});

/* ğŸŸ¦ é¸æŠã•ã‚ŒãŸIDã‚’å–å¾— */
function getSelectedRoomIds() {
  return [...document.querySelectorAll(".undo-room-card.selected")]
    .map(card => Number(card.dataset.id));
}

/* ğŸŸ¦ APPLYï¼ˆå·»ãæˆ»ã—ï¼‰ */
document.getElementById("undoApplyBtn").onclick = async () => {
  const selectedIds = getSelectedRoomIds();

  if (selectedIds.length === 0) {
    alert("Selecione ao menos um quarto.");
    return;
  }

  // console.log("Selecionados:", selectedIds);

  /* æ­£ã—ã„ restoreList ã®ä½œã‚Šæ–¹ */
  const restoreList = beforeCleanning.filter(r => selectedIds.includes(r.id));

  // console.log("ğŸ“¤ å·»ãæˆ»ã™éƒ¨å±‹:", restoreList);

  const res = await fetch(`${API_URL}/api/room/undo_restore`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      rooms: restoreList
    })
  });

  const data = await res.json();
  // console.log("ğŸ“¥ restore response:", data);

  // alert("å·»ãæˆ»ã—å®Œäº†ã—ã¾ã—ãŸï¼");
  document.getElementById("undoModal").classList.add("hidden");

loadTasks(); // å†æç”»
};

/* ğŸŸ¦ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ */
document.getElementById("undoCloseBtn").onclick = () => {
  document.getElementById("undoModal").classList.add("hidden");
};

/* ğŸŸ¦ ãƒœã‚¿ãƒ³ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã */
document.getElementById("desfazerBtn").addEventListener("click", () => {
  openUndoModal();
});



// ========================
refreshBtn.addEventListener("click", loadTasks);
applyLang();
loadTasks();
</script>
</body>
</html>
