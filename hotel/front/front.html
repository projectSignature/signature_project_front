<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>RoomSync</title>
    <link rel="stylesheet" href="./front.css">
</head>
<body>
  <header class="header">
    <img src="./img/logo.png" alt="RoomSync ãƒ­ã‚´">

    <div class="header-right">

      <button id="amenityListBtn">ğŸ“‹ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ä¸€è¦§</button>
      <button id="masterBtn">âš™ï¸ä»–æŒ‡ç¤ºä¸€è¦§</button>
      <button id="toggleLegendBtn">å‡¡ä¾‹è¡¨ç¤º</button>
      <button id="bulkModeBtn" class="bulk-btn">ğŸ§© ä¸€æ‹¬ç™»éŒ²</button>
       <button id="bulkChangeBtn" class="bulk-btn" disabled>ğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</button>
       <button id="importExcelBtn" class="bulk-btn">ğŸ“‚ æ¸…æƒãƒ‡ãƒ¼ã‚¿å–è¾¼</button>
       <button id="exportStatusBtn" class="bulk-btn">ğŸ“¤ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡ºåŠ›</button>
       <button id="closeDayBtn" class="bulk-btn close-day-btn">ç· ã‚</button>
       <button id="fixCloseDayBtn" class="bulk-btn fix-close-day-btn">ç· ã‚ä¿®æ­£</button>
       <span id="closeStatusLabel">æœ¬æ—¥ç· æ¸ˆã¿</span>

    </div>
  <div id='summary-div'>
    <span id='total-guest'></span>
    <span id='total-seisou'></span>
    <span id='total-amenity'></span>
    <div>
  </header>

  <input type="file" id="excelUpload" accept=".xls,.xlsx" style="display:none">



<div id="map"></div>

<!-- å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<!-- <div class="context-menu" id="contextMenu">
  <ul>
    <li data-action="æƒé™¤ä¾é ¼">ğŸ§¹ æƒé™¤ä¾é ¼</li>
    <li data-action="ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£äº¤æ›">ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£äº¤æ›</li>
    <li data-action="å……é›»å™¨å›å">ğŸ”Œ å……é›»å™¨å›å</li>
    <li data-action="å»¶é•·ã‚³ãƒ¼ãƒ‰å›å">ğŸ”‹ å»¶é•·ã‚³ãƒ¼ãƒ‰å›å</li>
  </ul>
</div> -->

<div id="legend" class="hidden">
  <h4>å‡¡ä¾‹</h4>
<div class="legend-item"><span class="icon"><img src="./img/check.png" alt="ãƒã‚§ãƒƒã‚¯æ¸ˆ" class="icon-img"></span> ãƒã‚§ãƒƒã‚¯æ¸ˆ</div>
  <div class="legend-item"><span class="icon"><img src="./img/renpakuseisou.png" alt="é€£æ³Š" class="icon-img"></span>é€£æ³Šãƒ»è¦æ¸…æƒ</div>
  <div class="legend-item"><span class="icon"><img src="./img/noclean.png" alt="é€£æ³Š" class="icon-img"></span>é€£æ³Šãƒ»æ¸…æƒä¸è¦</div>
  <div class="legend-item"><span class="icon"><img src="./img/seisou.png" alt="é€£æ³Š" class="icon-img"></span>è¦æ¸…æƒ</div>
  <div class="legend-item"><span class="icon"><img src="./img/notuse.png" alt="æœªä½¿ç”¨" class="icon-img"></span>æœªä½¿ç”¨</div>
  <div class="legend-item"><span class="icon"><img src="./img/outOf.png" alt="æœªä½¿ç”¨" class="icon-img"></span>æ•…éšœéƒ¨å±‹</div>

</div>

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="actionModal" class="modal">
  <div class="modal-content">
    <h3>ã©ã®æ“ä½œã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div class="action-buttons">
      <button id="statusChangeBtn"> éƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</button>
      <button id="amenityBtn" disabled>ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ãƒ»ä»–ä¾é ¼</button>
    </div>
    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="statusModal" class="modal">
  <div class="modal-content large">
    <h3>éƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ</h3>
    <div id="statusGrid" class="status-grid"></div>
    <button class="close-btn">âœ–</button>
  </div>
</div>


<!-- ğŸŒŸ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="amenityTypeModalTop" class="amenity-modal">
  <div class="amenity-modal-content">
    <h3>ã©ã®ä¾é ¼ã‚’ã—ã¾ã™ã‹ï¼Ÿ</h3>

    <div class="action-buttons">
      <button class="amenity-type-btn" data-type="è£œå……">ğŸ§´ è£œå……</button>
      <button class="amenity-type-btn" data-type="å›å">â™»ï¸ å›å</button>
      <button id="otherRequestBtn">ğŸ“ ãã®ä»–ã®ä¾é ¼</button>
    </div>

    <!-- âœï¸ ãã®ä»–ä¾é ¼å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
    <div id="otherRequestArea" class="hidden">
      <textarea id="otherRequestInput" placeholder="ä¾é ¼å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
      <button id="sendOtherRequestBtn">é€ä¿¡</button>
    </div>


    <button class="close-btn-amenity-modal">âœ–</button>
  </div>
</div>

<!-- ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¸€è¦§é¸æŠ -->
<div id="amenityModal" class="modal">
  <div class="modal-content large">
    <h3>ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
    <div id="amenityGrid" class="status-grid"></div>
    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- è¿”å´å…ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="returnModal" class="modal">
  <div class="modal-content">
    <h3>ã©ã“ã¸è¿”å´ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div class="action-buttons">
      <button id="returnFrontBtn">ãƒ•ãƒ­ãƒ³ãƒˆ</button>
      <button class="linen-btn" data-floor="4">4Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="5">5Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="6">6Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="7">7Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="8">8Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="9">9Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="10">10Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="11">11Fãƒªãƒãƒ³åº«</button>
      <button class="linen-btn" data-floor="12">12Fãƒªãƒãƒ³åº«</button>
    </div>

    <button class="close-btn">âœ–</button>
  </div>
</div>

<!-- ğŸ”„ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="spinner"></div>
  <p>å‡¦ç†ä¸­ã§ã™â€¦</p>
</div>

<!-- éƒ¨å±‹è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="roomDetailModal" class="modal">
  <div class="modal-content large">
    <h3>éƒ¨å±‹æƒ…å ±è©³ç´°</h3>

    <form id="roomDetailForm">
      <div class="form-grid">
        <label>å®¿æ³Šè€…åï¼š
          <input type="text" id="guestName" name="guestName">
        </label>
        <label>ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆäºˆå®šï¼š
          <input type="time" id="checkoutTime" name="checkoutTime">
        </label>
        <label>äººæ•°ï¼š
          <input type="number" id="guestCount" name="guestCount" min="1" max="10">
        </label>
        <label>å‚™è€ƒï¼š
          <textarea id="notes" name="notes" rows="3"></textarea>
        </label>
      </div>

      <div class="action-buttons">
        <button type="button" id="saveRoomDetailBtn">ç™»éŒ²</button>
        <button type="button" class="close-btn">âœ– é–‰ã˜ã‚‹</button>
      </div>
    </form>
  </div>
</div>

<!-- ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="amenityListModal" class="modal">
  <div class="modal-content large">
    <h3>ğŸ“‹ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ä¸€è¦§</h3>
    <div id="amenityListTableContainer">
      <table id="amenityListTable">
        <thead>
          <tr>
            <th>éƒ¨å±‹ç•ªå·</th>
            <th>ä¾é ¼å†…å®¹</th>
            <th>ç¨®åˆ¥</th>
            <th>è¿”å´å…ˆ</th>
            <th>ç™»éŒ²æ—¥æ™‚</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="amenityListBody">
          <tr><td colspan="6" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="action-buttons">
      <button class="close-btn">âœ– é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- âš™ï¸ãã®ä»–ä¾é ¼ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="otherRequestListModal" class="modal">
  <div class="modal-content large">
    <h3>âš™ï¸ ãã®ä»–ä¾é ¼ä¸€è¦§</h3>

    <div id="otherRequestTableContainer">
      <table id="otherRequestTable">
        <thead>
          <tr>
            <th>éš</th>
            <th>éƒ¨å±‹ç•ªå·</th>
            <th>ä¾é ¼å†…å®¹</th>
            <th>æœ€çµ‚æ›´æ–°</th>
          </tr>
        </thead>
        <tbody id="otherRequestBody">
          <tr><td colspan="4" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="action-buttons">
      <button class="close-btn">âœ– é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>


<!-- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLã‚’ãƒ•ãƒƒã‚¿ãƒ¼ç›´å‰ãªã©ã«è¿½åŠ  -->
<div id="bulkConfirmModal" style="
  display:none;
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
  z-index:9999;
">
  <div style="
    background:#fff;
    padding:20px;
    border-radius:8px;
    width:320px;
    box-shadow:0 3px 8px rgba(0,0,0,0.3);
    text-align:left;
  ">
    <h3>ğŸ§¹ ä¸€æ‹¬æ›´æ–°å†…å®¹ã®é¸æŠ</h3>
    <p>ä»¥ä¸‹ã®å†…å®¹ã‚’æ›´æ–°ã—ã¾ã™ã€‚ä¸è¦ãªé …ç›®ã¯ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãã ã•ã„ã€‚</p>
    <label><input type="checkbox" id="chkStatus" checked> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæ¸…æƒä¾é ¼ï¼‰</label><br>
    <label><input type="checkbox" id="chkGuest" checked> äººæ•°</label><br><br>
    <div style="text-align:right;">
      <button id="bulkCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="bulkOkBtn">OK</button>
    </div>
  </div>
</div>

<div id="closeDayModal" class="close-day-modal">
  <div class="close-day-content">
    <h3>ç™»éŒ²æ—¥ã‚’é¸æŠ</h3>
    <input type="date" id="closeDayDate">

    <div class="close-day-actions">
      <button id="closeDayCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="closeDaySubmit" class="close-day-submit">ç™»éŒ²</button>
    </div>
  </div>
</div>

<div id="fixCloseDayModal" class="modal-fix-close">
  <div class="modal-fix-box">
    <div class="fix-modal-header">
      ç· ã‚ãƒ‡ãƒ¼ã‚¿ä¿®æ­£
      <span class="fix-close-btn" onclick="closeFixCloseDayModal()">âœ•</span>
    </div>

    <label>æ—¥ä»˜</label>
    <input type="date" id="fixCloseDayDate">

    <button class="fetch-fix-btn" onclick="loadFixCloseDayData()">èª­ã¿è¾¼ã¿</button>

    <div id="fixCloseDayList" class="fix-list"></div>

    <div class="fix-save-wrapper">
      <button class="save-fix-btn" onclick="submitFixCloseDay()">ç¢ºå®š</button>
    </div>

  </div>
</div>








<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
const types = ["TP","TD","TM","SM","TC","DS"];
const statuses = ["å®¿æ³Šä¸­","é€£æ³Šä¸­","æƒé™¤å‰","ç¢ºèªæ¸ˆ","æœªä½¿ç”¨"];

let globalRoomStatus = {}
let stayTypeBuffer = {}; // { roomId: "group" or "individual" }
let stayTypeTimer = null;

let checkoutBuffer = {};  // { roomId: "after" or "before" }
let checkoutTimer = null;



// ===========================
// ğŸ¨ éƒ¨å±‹çŠ¶æ…‹ã‚¢ã‚¤ã‚³ãƒ³ä¸€è¦§
// ===========================


const icons = {
  checked: `<img src="./img/check.png" alt="ãƒã‚§ãƒƒã‚¯æ¸ˆ" class="icon-img">`,
  stay_clean: `<img src="./img/renpakuseisou.png" alt="é€£æ³Šãƒ»è¦æ¸…æƒ" class="icon-img">`,
  stay_noclean: `<img src="./img/noclean.png" alt="é€£æ³Šãƒ»æ¸…æƒä¸è¦" class="icon-img">`,
  need_clean: `<img src="./img/seisou.png" alt="è¦æ¸…æƒ" class="icon-img">`,
  before_check: `<img src="./img/seisou.png" alt="æ¸…æƒç¢ºèªä¸­" class="icon-img">`,
  unused: `<img src="./img/notuse.png" alt="æœªä½¿ç”¨" class="icon-img">`,
  checkOut: `<img src="./img/checkOut.png" alt="æœªä½¿ç”¨" class="icon-img">`,
  singleGuest :`<img src="./img/single.png" alt="FIT" class="icon-img">`,
  groupe :`<img src="./img/grouped.png" alt="å›£ä½“" class="icon-img">`,
  outOf:`<img src="./img/outOf.png" alt="æ•…éšœéƒ¨å±‹" class="icon-img">`,
  stay_amenytyOnliy:`<img src="./img/amenityOnly.png" class="icon-img">`,
};


const statusLabels = {
  checked: "ãƒã‚§ãƒƒã‚¯æ¸ˆã¿",
  stay_clean: "é€£æ³Šï¼ˆæ¸…æƒã‚ã‚Šï¼‰",
  stay_noclean: "é€£æ³Šï¼ˆæ¸…æƒä¸è¦ï¼‰",
  stay_amenytyOnliy: "é€£æ³Š(æ¸…æƒä¸è¦)<br>ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£è¿½åŠ ",

  need_clean: "è¦æ¸…æƒ",
  unused: "æœªä½¿ç”¨",
  checkOut:'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ',
  singleGuest:'FITã¸å¤‰æ›´',
  groupe:'å›£ä½“ã¸å¤‰æ›´',
  outOf:'æ•…éšœéƒ¨å±‹ã¸å¤‰æ›´'
};




// ========================================
// ğŸ¨ è‰²è¨­å®šï¼šã‚¿ã‚¤ãƒ— or éƒ¨å±‹ç•ªå·ã”ã¨ã«è‡ªç”±å¤‰æ›´
// ========================================
const roomColors = {
  // ã‚¿ã‚¤ãƒ—åˆ¥ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  TP: "#f2e6ff",
  TD: "#ffeacc",
  TM: "#fff6cc",
  SM: "#e6f7e6",
  TC: "#e6f2ff",
  DS: "#ffe6e6",

  // å€‹åˆ¥è¨­å®šï¼ˆå„ªå…ˆã•ã‚Œã‚‹ï¼‰
  "1201": "#ffebf0",  // è–„ãƒ”ãƒ³ã‚¯
  "1202": "#ebf8ff",  // è–„æ°´è‰²
  "804":  "#f7ffe6",  // è–„é»„ç·‘
  "501":  "#fff0e6",  // ãƒ™ãƒ¼ã‚¸ãƒ¥
  "401": "#99e6b3",
  "402": "#66b3ff",
  "403": "#66b3ff",
  "404": "#66b3ff",
  "405": "#66b3ff",
  "406": "#ebf8ff",
  "407": "#ebf8ff",
  "408": "#ffeb3b",
  "409": "#66b3ff",
  "410": "#66b3ff",
  "411": "#ffb3b3",
  "412": "#66b3ff",
  "413": "#66b3ff",
  "414": "#99e6b3",
  "415": "#66b3ff",
  "416": "#66b3ff",
  "417": "#ffeb3b",
  "418": "#99e6b3",
  "419": "#66b3ff",
  "420": "#66b3ff",
  "421": "#66b3ff",
  // ==== 5Fï¼ˆ501ã€œ521ï¼‰ ====
"501": "#66b3ff",
"502": "#66b3ff",
"503": "#66b3ff",
"504": "#66b3ff",
"505": "#66b3ff",
"506": "#66b3ff",
"507": "#66b3ff",
"508": "#ffeb3b",
"509": "#66b3ff",
"510": "#66b3ff",
"511": "#ffb3b3",
"512": "#66b3ff",
"513": "#66b3ff",
"514": "#99e6b3",
"515": "#66b3ff",
"516": "#66b3ff",
"517": "#ffeb3b",
"518": "#99e6b3",
"519": "#66b3ff",
"520": "#66b3ff",
"521": "#66b3ff",

// ==== 6Fï¼ˆ601ã€œ621ï¼‰ ====
"601": "#66b3ff",
"602": "#66b3ff",
"603": "#66b3ff",
"604": "#66b3ff",
"605": "#66b3ff",
"606": "#66b3ff",
"607": "#66b3ff",
"608": "#ffeb3b",
"609": "#66b3ff",
"610": "#66b3ff",
"611": "#ffb3b3",
"612": "#66b3ff",
"613": "#66b3ff",
"614": "#99e6b3",
"615": "#66b3ff",
"616": "#66b3ff",
"617": "#ffeb3b",
"618": "#99e6b3",
"619": "#66b3ff",
"620": "#66b3ff",
"621": "#66b3ff",

// ==== 7Fï¼ˆ701ã€œ721ï¼‰ ====
"701": "#66b3ff",
"702": "#66b3ff",
"703": "#66b3ff",
"704": "#66b3ff",
"705": "#66b3ff",
"706": "#66b3ff",
"707": "#66b3ff",
"708": "#ffeb3b",
"709": "#66b3ff",
"710": "#66b3ff",
"711": "#ffb3b3",
"712": "#66b3ff",
"713": "#66b3ff",
"714": "#99e6b3",
"715": "#66b3ff",
"716": "#66b3ff",
"717": "#ffeb3b",
"718": "#99e6b3",
"719": "#66b3ff",
"720": "#66b3ff",
"721": "#66b3ff",

// ==== 8Fï¼ˆ801ã€œ821ï¼‰ ====
"801": "#66b3ff",
"802": "#66b3ff",
"803": "#66b3ff",
"804": "#66b3ff",
"805": "#66b3ff",
"806": "#66b3ff",
"807": "#66b3ff",
"808": "#ffeb3b",
"809": "#66b3ff",
"810": "#66b3ff",
"811": "#ffb3b3",
"812": "#66b3ff",
"813": "#66b3ff",
"814": "#99e6b3",
"815": "#66b3ff",
"816": "#66b3ff",
"817": "#ffeb3b",
"818": "#99e6b3",
"819": "#66b3ff",
"820": "#66b3ff",
"821": "#66b3ff",

// ==== 9Fï¼ˆ901ã€œ917ï¼‰ ====
"901": "#99e6b3",
"902": "#ff8800",
"904": "#99e6b3",
"905": "#99e6b3",
"907": "#ff8800",
"908": "#ffeb3b",
"909": "#99e6b3",
"910": "#99e6b3",
"911": "#ffb3b3",
"912": "#99e6b3",
"913": "#99e6b3",
"914": "#ff8800",
"916": "#99e6b3",
"917": "#ffeb3b",
"918": "#99e6b3",
"919": "#ff8800",
"921": "#99e6b3",

"1001": "#99e6b3",
"1002": "#ff8800",
"1004": "#99e6b3",
"1005": "#99e6b3",
"1007": "#ff8800",
"1008": "#ffeb3b",
"1009": "#99e6b3",
"1010": "#99e6b3",
"1011": "#ffb3b3",
"1012": "#99e6b3",
"1013": "#99e6b3",
"1014": "#ff8800",
"1016": "#99e6b3",
"1017": "#ffeb3b",
"1018": "#99e6b3",
"1019": "#ff8800",
"1021": "#99e6b3",

"1101": "#99e6b3",
"1102": "#ff8800",
"1104": "#99e6b3",
"1105": "#ff8800",
"1107": "#99e6b3",
"1108": "#ffeb3b",
"1109": "#99e6b3",
"1110": "#99e6b3",
"1111": "#ffb3b3",
"1112": "#99e6b3",
"1113": "#99e6b3",
"1114": "#ff8800",
"1116": "#99e6b3",
"1117": "#ffeb3b",
"1118": "#99e6b3",
"1119": "#ff8800",
"1121": "#99e6b3",

"1201" : "#cc99ff",
"1202" : "#ccccff",
"1203" : "#ccccff",
"1204" : "#ccccff",
"1205" : "#9933ff",
"1206" : "#ccccff",
"1207" : "#ccccff",
"1208" : "#ccccff",
"1209" : "#ccccff",
"1210" : "#ccccff",
"1211" : "#ccccff",
"1212" : "#ccccff",



};

const maxGuestsByType = {
  TP: 2,
  TS: 2,
  TR: 2,
  SM: 1,
  TD: 3,
  DS: 2,
  TMS: 2,
  TC: 2,
};

let currentRoomId = null;
let currentHotelId = null;
let globalShimeFlag=false
let globalShimeData = []

async function showLoading() {
  console.log('kokoni deteru')
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.remove("hidden");
  await new Promise(r => setTimeout(r, 50)); // ğŸ’¡ å¼·åˆ¶çš„ã«å†æç”»
}

function hideLoading() {
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.add("hidden");
}

let globalId = 1
let globalBlukMode = false
let roomsDatas = []

// https://squid-app-ug7x6.ondigitalocean.app

// const statusLabels = {
//   "available": "ç¢ºèªæ¸ˆï¼ˆä½¿ç”¨å¯èƒ½ï¼‰",
//   "occupied": "å®¿æ³Šä¸­",
//   "stayover": "é€£æ³Šä¸­",
//   "cleaning": "æ¸…æƒä¸­",
//   "dirty": "æ¸…æƒå‰",
//   "maintenance": "æ•…éšœãƒ»ç‚¹æ¤œä¸­",
//   "reserved": "äºˆç´„æ¸ˆ",
//   "outofservice": "ä½¿ç”¨åœæ­¢ä¸­",
//   "unavailable": "æœªä½¿ç”¨ãƒ»é–‰é–ä¸­"
// };
// const API_URL = "http://localhost:3000";
const API_URL = "https://squid-app-ug7x6.ondigitalocean.app"
// https://squid-app-ug7x6.ondigitalocean.app

const map = document.getElementById("map");
const legend = document.getElementById("legend");
const toggleLegendBtn = document.getElementById("toggleLegendBtn");
let selectedRoom = null;


let updateTimers = {}; // éƒ¨å±‹ã”ã¨ã«ã‚¿ã‚¤ãƒãƒ¼ä¿æŒ

function scheduleGuestCountUpdate(roomId, newCount) {
  // ã™ã§ã«ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚‹ãªã‚‰ãƒªã‚»ãƒƒãƒˆ
  if (updateTimers[roomId]) {
    clearTimeout(updateTimers[roomId]);
  }

  // 1ç§’å¾Œã«é€ä¿¡
  updateTimers[roomId] = setTimeout(() => {
    updateGuestCount(roomId,globalId, newCount);
    delete updateTimers[roomId];
  }, 1000);
}
let savedRoomStatus

function saveRoomStatusToLocal() {
  const hotelId = globalId || "default"; // å¿…è¦ãªã‚‰å–å¾—å…ƒåˆã‚ã›ã¦
  const keyName = `roomStatus_${hotelId}`;

  localStorage.setItem(keyName, JSON.stringify(globalRoomStatus));
  console.log("âœ… ä¿å­˜å®Œäº†:", keyName);
   savedRoomStatus= loadRoomStatusFromLocal();
}

function loadRoomStatusFromLocal() {
  const hotelId = globalId || "default";
  const keyName = `roomStatus_${hotelId}`;
  const saved = localStorage.getItem(keyName);
  return saved ? JSON.parse(saved) : {};
}

 savedRoomStatus= loadRoomStatusFromLocal();



// ================================
// ğŸ”¹ éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// ================================
async function loadRooms() {
  try {
    showLoading();
    const res = await fetch(`${API_URL}/api/room/status?hotel_id=${globalId}`);

//     const now = new Date();
// now.setHours(now.getHours() + 9);   // JSTè£œæ­£
//
// // â˜… æ˜æ—¥ã«ã™ã‚‹
// now.setDate(now.getDate() + 1);
//
// const date = now.toISOString().split("T")[0];

    // // showLoading()
    const today = new Date().toLocaleDateString("ja-JP", {
      timeZone: "Asia/Tokyo",
    })
      .replace(/\//g, "-");   // 2025/11/30 â†’ 2025-11-30
console.log(today)
    const url = `${API_URL}/api/room/daily_room_list?date=${today}&hotel_id=${globalId}`;
    const getDayList = await fetch(url)
    const DayList= await getDayList.json();
    const closeStatusLabel = document.getElementById("closeStatusLabel");

    // ----------- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ -----------
if (DayList.rows && DayList.rows.length > 0) {

  // ç· æ¸ˆã¿ â†’ ç· ã‚ãƒœã‚¿ãƒ³éè¡¨ç¤º
  closeDayBtn.style.display = "none";

  // ç· ã‚ä¿®æ­£ã®ã¿è¡¨ç¤º
  fixCloseDayBtn.style.display = "inline-block";
    closeStatusLabel.style.display = "inline-block";

  globalShimeFlag=true
globalShimeData = DayList.rows

} else {

  // æœªç· ã‚ â†’ ç· ã‚ãƒœã‚¿ãƒ³è¡¨ç¤º
  closeDayBtn.style.display = "inline-block";

  // ç· ã‚ä¿®æ­£ãƒœã‚¿ãƒ³éè¡¨ç¤º
  fixCloseDayBtn.style.display = "none";
    closeStatusLabel.style.display = "none";
}


    hideLoading();
    if (!res.ok) throw new Error("APIå–å¾—å¤±æ•—");

    const data = await res.json();
    const rooms = data.rooms || [];
    const grouped = groupByFloor(rooms);

    globalRoomStatus=rooms
    // saveRoomStatusToLocal()

    console.log(grouped)

    map.innerHTML = "";
    let totalGuestCount = 0;
    let totalseisou = 0;
    let totalAmenity = 0

    // ğŸŸ¢ å„roomè¦ç´ ã”ã¨ã«ã‚¯ãƒªãƒƒã‚¯ã‚¿ã‚¤ãƒãƒ¼ã‚’ç®¡ç†ã™ã‚‹WeakMap
    const clickTimers = new WeakMap();

    Object.keys(grouped)
      .sort((a, b) => b - a)
      .forEach((floor) => {

        // console.log(floor)

        const {targetClean, targetAmenity} =  getSummaryRooms(floor)
        const floorRooms = grouped[floor];
        let floorGuestCount = 0;

        const floorDiv = document.createElement("div");
        floorDiv.className = "floor";

        const floorHeader = document.createElement("div");
        floorHeader.className = "floor-header";

        const floorTitle = document.createElement("h3");
        floorTitle.textContent = `${floor}F`;

        // const floorTotal = document.createElement("span");
        // floorTotal.className = "floor-total";
        // floorTotal.textContent = `ğŸ‘¥ ${floorGuestCount}`;

        floorHeader.appendChild(floorTitle);
        // floorHeader.appendChild(floorTotal);
        floorDiv.appendChild(floorHeader);

        const roomsContainer = document.createElement("div");
        roomsContainer.className = "rooms";

        floorRooms.forEach((r) => {

          const local = savedRoomStatus?.[r.room_number]?.renpakuFlag;
          const global = globalRoomStatus?.[r.room_number]?.renpakuFlag;
          const renpakuFlag = local || global || "";
          const isRenpaku = (r.status === 'stay_clean'||r.status ==='stay_amenytyOnliy') && r.excel_status==='S'?true:false
          let checkOutAndSatyFlag = false



            if(r.status==='before_check'&&r.excel_statu==='S'){
                checkOutAndSatyFlag = true
            }


          const room = document.createElement("div");
          room.className = `room room-${r.room_number} ${r.status} type-${r.room_type}`;
          room.dataset.room = r.room_number;
          room.dataset.status = r.status;
          room.dataset.id = r.id;
          room.dataset.guest_count = r.guest_count || 0;
          room.style.backgroundColor = getRoomColor(r);

          floorGuestCount += Number(r.guest_count || 0);

          room.innerHTML = `
            <div class="room-header ${r.stay_type !== "group" ? "group-border" : ""}">
              ${r.room_number}<br><small>${r.room_type || "-"}</small>
            </div>
            <div class="room-guest">
              <button class="guest-btn up">â–³</button>
              <span class="guest-count">${r.guest_count || 0}</span>
              <button class="guest-btn down">â–½</button>
            </div>
            <div class="room-status ${r.status === "outOf" ? "outof-status" : ""}">
              ${r.status !== "outOf" ? (icons[r.status] || "?") : ""}
            </div>
          `;

            const statusDiv = room.querySelector(".room-status");

            if(r.room_number==='406'||r.room_number==='407'){

              statusDiv.classList.remove("checkout-border", "renpaku-border");
              statusDiv.classList.add("mishiyou-room");
              statusDiv.innerHTML=""
              roomsContainer.appendChild(room);
            return
            }


          statusDiv.classList.remove("checkout-border", "renpaku-border");

          // âœ… åˆæœŸè¡¨ç¤ºã®æ ãƒ«ãƒ¼ãƒ«
          if (r.checkout_status === "after"&&r.status!=='checked') {
            if (isRenpaku||checkOutAndSatyFlag) {
              statusDiv.classList.add("renpaku-border");   // ğŸ”µ é€£æ³Š â†’ åˆ¥è‰²
            } else {
              statusDiv.classList.add("checkout-border");  // ğŸ”´ é€šå¸¸ â†’ èµ¤æ 
            }
          }

          // if(r.outOf)

          // ğŸ§© äººæ•°æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ
          const guestCountEl = room.querySelector(".guest-count");
          const upBtn = room.querySelector(".guest-btn.up");
          const downBtn = room.querySelector(".guest-btn.down");

          const updateDisplay = (newCount) => {
            guestCountEl.textContent = newCount;
            room.dataset.guest_count = newCount;
            scheduleGuestCountUpdate(r.id, newCount);
            updateTotals();
          };

//å®¢æ•°ã®ï¼‹ãƒœã‚¿ãƒ³å‡¦ç†
          upBtn.addEventListener("click", (e) => {
            e.stopPropagation();

            const roomType = r.room_type; // â† éƒ¨å±‹ã‚¿ã‚¤ãƒ—å–å¾—
            const maxGuests = maxGuestsByType[roomType] || 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ2äºº

            let count = Number(room.dataset.guest_count);
            if (count >= maxGuests) {
              // alert(`âš ï¸ ${roomType}ã‚¿ã‚¤ãƒ—ã¯æœ€å¤§${maxGuests}åã¾ã§ã§ã™`);
              return;
            }

            updateDisplay(++count);
          });

//å®¢æ•°ã®-ãƒœã‚¿ãƒ³å‡¦ç†
          downBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            let count = Number(room.dataset.guest_count);
            if (count > 0) updateDisplay(--count);
          });

          // ================================
          // ğŸŸ¢ ã‚¯ãƒªãƒƒã‚¯ãƒ»ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å…±å­˜å‡¦ç†ï¼ˆWeakMapç‰ˆï¼‰
          // ================================
          room.addEventListener("click", (e) => {
            e.stopPropagation();
            currentRoomId = room.dataset.id;
            currentHotelId = room.dataset.hotel_id;

            // æ—¢å­˜ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            if (clickTimers.has(room)) {
              clearTimeout(clickTimers.get(room));
            }

            const timer = setTimeout(() => {
              clickTimers.delete(room);

              // ğŸŸ¢ â˜… ã‚·ãƒ³ã‚°ãƒ«ã‚¯ãƒªãƒƒã‚¯ç¢ºå®šã—ãŸç¬é–“ã ã‘ Shime ãƒã‚§ãƒƒã‚¯
              if (globalShimeFlag) {
                alert('æœ¬æ—¥ã¯æ—¢ã«ãƒ‡ãƒ¼ã‚¿ç· ã‚æ¸ˆã¿ã§ã™ã€‚ä¿®æ­£ãŒå¿…è¦ã‚ã‚‹å ´åˆã¯ç· ã‚ä¿®æ­£ãƒœã‚¿ãƒ³ã‚ˆã‚Šè¡Œã£ã¦ãã ã•ã„');
                return;
              }

              // ğŸŸ¢ ä¸€æ‹¬é¸æŠãƒ¢ãƒ¼ãƒ‰
              if (bulkMode) {
                if (room.classList.contains("selected-bulk")) {
                  room.classList.remove("selected-bulk");
                  selectedRoomsBulk = selectedRoomsBulk.filter((r) => r !== room);
                } else {
                  room.classList.add("selected-bulk");
                  selectedRoomsBulk.push(room);
                }
                return;
              }

              // ğŸŸ£ é€šå¸¸ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
              selectedRoom = room;
              showActionModal(r);

            }, 250);

            clickTimers.set(room, timer);
          });


          room.addEventListener("dblclick", async (e) => {
            console.log(`ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆç™»éŒ²å‡¦ç†ã®é–‹å§‹`)

            if (clickTimers.has(room)) {
  clearTimeout(clickTimers.get(room));
  clickTimers.delete(room);
}

  e.stopPropagation();

  if (e.target.closest(".guest-btn")) return;

  if (clickTimers.has(room)) {
    clearTimeout(clickTimers.get(room));
    clickTimers.delete(room);
  }

  const statusDiv = room.querySelector(".room-status");
  const prevStatus = r.checkout_status;
  const optimisticStatus = prevStatus === "after" ? "before" : "after";

  const isRenpaku = r.excel_status === "S";

  // ===== UI å³æ™‚åæ˜  =====
  r.checkout_status = optimisticStatus;
  statusDiv.classList.remove("checkout-border", "renpaku-border");

  if (optimisticStatus === "after") {
    if (isRenpaku) statusDiv.classList.add("renpaku-border");
    else statusDiv.classList.add("checkout-border");
  }

  // ===== ãƒãƒƒãƒ•ã‚¡ã«è¿½åŠ  =====
  checkoutBuffer[r.id] = optimisticStatus;

  // ===== ä¸€æ‹¬é€ä¿¡ã‚’äºˆç´„ =====
  scheduleCheckoutBatch();

  // ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆUIåæ˜ ä¸­ï¼‰
  const toast = document.createElement("div");
  toast.textContent =
    optimisticStatus === "after"
      ? "ğŸšª ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ¸ˆã«å¤‰æ›´ï¼ˆåæ˜ ä¸­...ï¼‰"
      : "ğŸ  ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸­ã«å¤‰æ›´ï¼ˆåæ˜ ä¸­...ï¼‰";
  toast.className = "toast";
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 1200);
});


          room.addEventListener("mousedown", (e) => {
            if (e.button !== 2) return;

            if(globalShimeFlag){
              alert('æœ¬æ—¥ã¯æ—¢ã«ãƒ‡ãƒ¼ã‚¿ç· ã‚æ¸ˆã¿ã§ã™ã€‚ä¿®æ­£ãŒå¿…è¦ã‚ã‚‹å ´åˆã¯ç· ã‚ä¿®æ­£ãƒœã‚¿ãƒ³ã‚ˆã‚Šè¡Œã£ã¦ãã ã•ã„')
              return
            }

            e.preventDefault();

            console.log(r.stay_type)

            const header = room.querySelector(".room-header");
            const isGroup = r.stay_type === "group";

            // å³UIåæ˜ 
            if (isGroup) {
              header.classList.add("group-border");
              r.stay_type = "individual";
            } else {
              header.classList.remove("group-border");
              r.stay_type = "group";
            }

            // ãƒãƒƒãƒ•ã‚¡ã«ä¿å­˜ï¼ˆä¸Šæ›¸ãOKï¼‰
            stayTypeBuffer[r.id] = r.stay_type;

            // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã—ã¦ã¾ã¨ã‚ã¦é€ä¿¡
            scheduleStayTypeBatch();
          });


          // âœ… ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾ç­–ï¼‰
          room.addEventListener("contextmenu", (e) => e.preventDefault());

          // DOMã¸è¿½åŠ 
          roomsContainer.appendChild(room);
        });

        // let

        const floorInfo = document.createElement("div");
        floorInfo.className = "floor-info-inline";

        floorInfo.innerHTML = `
          <span class="info-tag total">ãŠå®¢æ§˜äººæ•°ï¼š${floorGuestCount}äºº</span>
          <span class="info-tag clean">æ¸…æƒå¯¾è±¡ï¼š${targetClean}</span>
          <span class="info-tag amenity">ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ï¼š${targetAmenity}</span>
        `;

        floorHeader.appendChild(floorInfo);



        floorDiv.appendChild(roomsContainer);
        map.appendChild(floorDiv);
        totalGuestCount += floorGuestCount;
        totalseisou += targetClean
        totalAmenity += targetAmenity
      });

      // è¦ªè¦ç´ ã‚’å–å¾—ï¼ˆä¾‹: ã™ã¹ã¦ã® room-status ã«å¯¾ã—ã¦ï¼‰
document.querySelectorAll(".room-status.outof-status").forEach((el) => {
  const width = el.offsetWidth;
  const height = el.offsetHeight;
  // è§’åº¦ = atan(é«˜ã• / å¹…)
  const angle = Math.atan(height / width) * (180 / Math.PI);
  el.style.setProperty("--diag-angle", `${angle}deg`);
});

document.querySelectorAll(".room-status.mishiyou-room").forEach((el) => {
  const width = el.offsetWidth;
  const height = el.offsetHeight;
  // è§’åº¦ = atan(é«˜ã• / å¹…)
  const angle = Math.atan(height / width) * (180 / Math.PI);
  el.style.setProperty("--diag-angle", `${angle}deg`);
});


    // âœ… å…¨ä½“äººæ•°æ›´æ–°
    updateHeaderTotal(totalGuestCount);
     totalElements(totalseisou,totalAmenity)

    function updateTotals() {
      let newTotal = 0;
      document.querySelectorAll(".floor").forEach((floorDiv) => {
        const guestEls = floorDiv.querySelectorAll(".guest-count");
        let floorSum = 0;
        guestEls.forEach((el) => (floorSum += Number(el.textContent.replace("ğŸ‘¤", ""))));
        const totalEl = floorDiv.querySelector(".floor-total");
        if (totalEl) totalEl.innerHTML = `ãŠå®¢æ§˜äººæ•°:${floorSum}`;
        newTotal += floorSum;
      });
      updateHeaderTotal(newTotal);
    }
  } catch (err) {
    console.error("âŒ éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    map.innerHTML = `<p style="color:red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
  }
}

function padRoomNumber(num) {
  return num.toString().padStart(4, "0");
}


function scheduleStayTypeBatch() {
  if (stayTypeTimer) clearTimeout(stayTypeTimer);

  stayTypeTimer = setTimeout(() => {
    sendStayTypeBatch();
  }, 1000); // â† é€£ç¶šæ“ä½œã‹ã‚‰0.6ç§’å¾Œã«ä¸€æ‹¬é€ä¿¡
}

function scheduleCheckoutBatch() {
  if (checkoutTimer) clearTimeout(checkoutTimer);

  checkoutTimer = setTimeout(() => {
    sendCheckoutBatch();
  }, 1000); // â† 0.6ç§’ä»¥å†…ã®é€£ç¶šæ“ä½œã¯ã¾ã¨ã‚ã‚‹
}

async function sendStayTypeBatch() {
  const payload = stayTypeBuffer;
  stayTypeBuffer = {}; // ãƒãƒƒãƒ•ã‚¡ãƒªã‚»ãƒƒãƒˆ

  try {
    console.log("ğŸ“¤ ä¸€æ‹¬æ›´æ–°é€ä¿¡:", payload);

    const res = await fetch(`${API_URL}/api/room/stay_type/bulk`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        hotel_id: globalId,
        updates: payload,
      }),
    });

    const data = await res.json();
    console.log("ğŸ“¥ ä¸€æ‹¬æ›´æ–°çµæœ:", data);

  } catch (err) {
    console.error("âŒ ä¸€æ‹¬æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
  }
}

function getSummaryRooms(floor){

  if(globalShimeFlag){
    // console.log(globalShimeData)
    const beforeCleanning = globalShimeData.filter(r =>
      r.status === 'æœªæ¸…æƒ' &&
      r.sub_status !== 'stay_noclean' &&
      Number(r.floor) === Number(floor) &&

      (r.amenity_only ?? 0) === 0
    );
    const stayAmenityOnly = globalShimeData.filter(r => r.sub_status==='stay_amenytyOnliy'&&
    Number(r.floor) === Number(floor));
    return  {
      targetClean:beforeCleanning.length, targetAmenity:stayAmenityOnly.length
    }
  }else{
    const beforeCleanning = globalRoomStatus.filter(r => (r.status === 'need_clean' || r.status === 'stay_clean') &&
    Number(r.floor) === Number(floor))

    const stayAmenityOnly = globalRoomStatus.filter(r => (r.status === 'stay_amenytyOnliy' || r.notes !== '')
    && Number(r.floor) === Number(floor))

    return  {
      targetClean:beforeCleanning.length, targetAmenity:stayAmenityOnly.length
    }
  }
}

async function sendCheckoutBatch() {
  const payload = checkoutBuffer;
  checkoutBuffer = {}; // ãƒªã‚»ãƒƒãƒˆ

  console.log("ğŸ“¤ ä¸€æ‹¬ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ›´æ–°é€ä¿¡:", payload);

  // --- 1) ãƒ¡ã‚¤ãƒ³APIï¼ˆç¾çŠ¶ç¶­æŒï¼‰
  try {
    const res = await fetch(`${API_URL}/api/room/checkout_status/bulk`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        hotel_id: globalId,
        updates: payload,  // â† {811:"before", ...}
      }),
    });

    const data = await res.json();
    console.log("ğŸ“¥ ä¸€æ‹¬æ›´æ–°çµæœ:", data);

  } catch (err) {
    console.error("âŒ ä¸€æ‹¬ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
  }

  console.log(globalShimeFlag);
  console.log(globalRoomStatus)

  // --- 2) ç· ã‚ä¸­ã®å ´åˆã®ã¿ DailyRoomList ã‚‚æ›´æ–°
  if (globalShimeFlag) {

    // ğŸ”¥ room_number â†’ id ã¸å¤‰æ›ã™ã‚‹ï¼ˆå¿…è¦ãªåˆ†ã ã‘ï¼‰
    const convertedList = [];

    for (const roomNumber in payload) {
      const status = payload[roomNumber];

      const targetRoom = globalRoomStatus.find(
        d => d.id ===roomNumber-0
      )

      console.log(targetRoom)

 console.log(roomNumber)
      console.log(payload)

      // globalShimeData ã®ä¸­ã‹ã‚‰ room_number ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ¤œç´¢
      const item = globalShimeData.find(
        d => String(d.room_number) === String(targetRoom.room_number)
      );

      if (item) {
        convertedList.push({
          id: item.id,
          checkout_status: status
        });
      } else {
        console.warn("âš  IDè¦‹ã¤ã‹ã‚‰ãš:", roomNumber);
      }
    }

    console.log("ğŸ“¤ Dailyç”¨å¤‰æ›ãƒ‡ãƒ¼ã‚¿:", convertedList);

    // ğŸ”¥ 3) å¤‰æ›æ¸ˆã¿ã®å¿…è¦ãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’ãƒãƒƒã‚¯ã«é€ã‚‹
    await fetch(`${API_URL}/api/room/daily_checkout/bulk`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        updates: convertedList // â† â˜… é€ã‚‹ã®ã¯ id + status ã®ã¿
      }),
    });
  }
}






async function toggleStayType(roomId) {
  try {
    const res = await fetch(`${API_URL}/api/room/${roomId}/stay_type`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hotel_id: globalId }),
    });

    const data = await res.json();
    if (data.success) {
      console.log("âœ… stay_type æ›´æ–°:", data.newType);
      return data.newType;
    } else {
      console.warn("âš ï¸ stay_type æ›´æ–°å¤±æ•—:", data.error);
      return null;
    }
  } catch (err) {
    console.error("âŒ stay_type æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
    return null;
  }
}

async function toggleCheckoutStatus(roomId,newStatus) {//ã“ã“ã¯ä»–ã§ã¤ã‹ã£ã¦ãªã„ã‹ãƒã‚§ãƒƒã‚¯å¿…è¦
  try {
    const res = await fetch(`${API_URL}/api/room/${roomId}/checkout_status`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hotel_id: globalId,status:newStatus  }),
    });

    const data = await res.json();
    if (data.success) {
      console.log("âœ… ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ›´æ–°:", data.newStatus);
      return data.newStatus;
    } else {
      console.warn("âš ï¸ æ›´æ–°å¤±æ•—:", data.error);
      return null;
    }
  } catch (err) {
    console.error("âŒ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
    return null;
  }
}

function totalElements(totalseisou,totalAmenity){
  // const totalEl = document.getElementById('total-guest')
  const totalSeisou = document.getElementById('total-seisou')
  const totalAmenityRom = document.getElementById('total-amenity')

  // totalEl.innerText = `ç·ãŠå®¢æ§˜äººæ•°: ${total}äºº`;
  totalSeisou.innerText = `ç·æ¸…æƒå¯¾è±¡: ${totalseisou}`;
  totalAmenityRom.innerText = `ç·ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£æ•°: ${totalAmenity}`;
}

// ğŸ”§ Headerã«ç·äººæ•°ã‚’è¡¨ç¤º
function updateHeaderTotal(total) {
  const totalEl = document.getElementById('total-guest')
  // const header = document.querySelector("header");
  // if (!header) return;
  // let totalEl = header.querySelector(".total-guests");
  // if (!totalEl) {
  //   totalEl = document.createElement("span");
  //   totalEl.className = "total-guests";
  //   header.appendChild(totalEl);
  // }
  totalEl.innerText = `ç·ãŠå®¢æ§˜äººæ•°: ${total}äºº`;
}


// ğŸ”§ DBæ›´æ–°APIå‘¼ã³å‡ºã—
async function updateGuestCount(roomId, hotelId, newCount) {
  try {
    console.log(hotelId)
    await fetch(`${API_URL}/api/room/${roomId}/guest_count`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        hotel_id: hotelId,
        guest_count: newCount,
      }),
    });
  } catch (err) {
    console.error("äººæ•°æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
  }
}




// ================================
// ğŸ”¹ ãƒ•ãƒ­ã‚¢ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
// ================================
function groupByFloor(rooms) {
  const grouped = {};
  for (const r of rooms) {
    const f = Number(r.floor);
    if (!grouped[f]) grouped[f] = [];
    grouped[f].push(r);
  }
  return grouped;
}

// ================================
// ğŸ”¹ è‰²è¨­å®š
// ================================
function getRoomColor(r) {
  const defaultColors = {
    "SM": "#e6f7e6",
    "SMS": "#e6f7e6",
    "TM": "#fff6cc",
    "TMS": "#fff6cc",
    "TD": "#ffeacc",
    "TDS": "#ffeacc",
    "TS": "#f2e6ff",
    "TP":"#d9b3ff",
    "TC": "#e6f2ff",
    "DS": "#ffe6e6",
    "DSS":"#ffe6e6",
    "TR":"#a64dff"
  };
  return defaultColors[r.room_type] || "#eee";
}

// ================================
// ğŸ”¹ å‡¡ä¾‹åˆ‡ã‚Šæ›¿ãˆ
// ================================
toggleLegendBtn.addEventListener("click", () => {
  legend.classList.toggle("hidden");
  toggleLegendBtn.textContent = legend.classList.contains("hidden") ? "å‡¡ä¾‹è¡¨ç¤º" : "å‡¡ä¾‹éè¡¨ç¤º";
});

// ================================
// ğŸ”¹ ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
// ================================
const actionModal = document.getElementById("actionModal");
const statusModal = document.getElementById("statusModal");
const statusGrid = document.getElementById("statusGrid");
const statusChangeBtn = document.getElementById("statusChangeBtn");
const closeButtons = document.querySelectorAll(".close-btn");
let currentRoom = null;

// ã€Œéƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€ã‚’æŠ¼ã—ãŸæ™‚
statusChangeBtn.addEventListener("click", () => {

console.log('koko')
  if(globalShimeFlag){
    alert('æœ¬æ—¥ã¯æ—¢ã«ãƒ‡ãƒ¼ã‚¿ç· ã‚æ¸ˆã¿ã§ã™ã€‚ä¿®æ­£ãŒå¿…è¦ã‚ã‚‹å ´åˆã¯ç· ã‚ä¿®æ­£ãƒœã‚¿ãƒ³ã‚ˆã‚Šè¡Œã£ã¦ãã ã•ã„')
  }
  closeModal(actionModal);
  openModal(statusModal);
  renderStatusOptions();
});

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ã‚’æç”»
function renderStatusOptions() {
  statusGrid.innerHTML = "";

  Object.entries(icons).forEach(([key, icon]) => {
    console.log(key)

if(key==='before_check'){
  return
}

    if ((key === 'checkOut' || key === 'singleGuest' || key === 'groupe') && !bulkMode) {

      console.log('kokoknikiteru')
      return
    }
    const div = document.createElement("div");
    div.className = "status-option";
    div.innerHTML = `
      <span>${icon}</span>
      <small>${statusLabels[key] || key}</small>
    `;

    div.onclick = async () => {
      // ğŸ”¸ é€šå¸¸å‡¦ç†ï¼ˆå˜ä½“å¤‰æ›´ï¼‰
      if (!bulkMode) {
        if (!selectedRoom) {
          alert("âš ï¸ éƒ¨å±‹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }

        selectedRoom.dataset.status = key;
        console.log(key)
        if (key === 'outOf') {
          // .room-status è¦ç´ ã‚’å–å¾—
          const statusDiv = selectedRoom.querySelector('.room-status');
          if (statusDiv) {
            statusDiv.className = 'room-status outof-status';
            statusDiv.innerHTML = ''; // outOfã¯Ã—ãƒãƒ¼ã‚¯ã ã‘ãªã®ã§ä¸­èº«æ¶ˆã™
          }
        } else {
          const statusDiv = selectedRoom.querySelector('.room-status');
          if (statusDiv) {
            statusDiv.className = 'room-status'; // â†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åŸºæœ¬ã‚¯ãƒ©ã‚¹ã«æˆ»ã™
            statusDiv.innerHTML = icon; // â†é€šå¸¸ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
          }

          // ãƒ«ãƒ¼ãƒ æœ¬ä½“å´ã¯ãã®ã¾ã¾ç¶­æŒï¼ˆéƒ¨å±‹ç•ªå·ãªã©æ®‹ã™ï¼‰
          selectedRoom.className = `room room-${selectedRoom.dataset.room} ${key}`;
        }



        try {
          showLoading();

          const res = await fetch(`${API_URL}/api/room/status`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              room_id: selectedRoom.dataset.id,
              status: key,
            }),
          });

          hideLoading();
          const result = await res.json();
          if (result.success) {
            console.log("âœ… æ›´æ–°æˆåŠŸ:", result.message);
          } else {
            console.warn("âš ï¸ æ›´æ–°å¤±æ•—:", result.error);
          }
        } catch (err) {
          hideLoading();
          console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
        }

        closeModal(statusModal);
        return;
      }

      // ğŸ”¸ ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰å‡¦ç†
      if (bulkMode && selectedRoomsBulk.length > 0) {
        const confirmChange = confirm(
          `é¸æŠã•ã‚ŒãŸ ${selectedRoomsBulk.length} éƒ¨å±‹ã‚’ã€Œ${statusLabels[key]}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`
        );
        if (!confirmChange) return;

        showLoading();

        for (const roomEl of selectedRoomsBulk) {

          console.log(roomEl)


console.log(key)

if(key==='checkOut'){
  try {
    const statusDiv = roomEl.querySelector(".room-status");
    statusDiv.classList.add('checkout-border');
    await fetch(`${API_URL}/api/room/status/checkOut/after`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room_id: roomEl.dataset.id,
        status: key,
      }),
    });
  } catch (err) {
    console.error(`âŒ ${roomEl.dataset.room} æ›´æ–°å¤±æ•—`, err);
  }
}else if(key==='singleGuest'){
  console.log('kokoni')
changeGroupOrSingle('individual', roomEl)
}else if(key==='groupe'){
  console.log('koko2')
  changeGroupOrSingle('group', roomEl)
}else{
  roomEl.dataset.status = key;

  const statusDiv = roomEl.querySelector(".room-status");
  if (statusDiv) statusDiv.innerHTML = icon;
  // ç¾åœ¨ã®ã‚¯ãƒ©ã‚¹ã‚’ç¶­æŒã—ã¦ã€statusã ã‘ä¸Šæ›¸ã
const currentClasses = roomEl.className.split(" ").filter(c => !Object.keys(icons).includes(c));
roomEl.className = [...currentClasses, key].join(" ");
  try {
    await fetch(`${API_URL}/api/room/status`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room_id: roomEl.dataset.id,
        status: key,
      }),
    });
  } catch (err) {
    console.error(`âŒ ${roomEl.dataset.room} æ›´æ–°å¤±æ•—`, err);
  }
}

        }

        hideLoading();
        alert(`âœ… ${selectedRoomsBulk.length} éƒ¨å±‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`);

        // ãƒ¢ãƒ¼ãƒ‰è§£é™¤ã¨é¸æŠè§£é™¤
        selectedRoomsBulk.forEach((r) => r.classList.remove("selected-bulk"));
        selectedRoomsBulk = [];
        bulkMode = false;
        const bulkBtn = document.getElementById("bulkModeBtn");
        if (bulkBtn) {
          bulkBtn.classList.remove("active");
          bulkBtn.textContent = "ğŸ§© ä¸€æ‹¬ç™»éŒ²";
        }

        closeModal(statusModal);
        return;
      }

      // ğŸ”¸ ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰ãªã®ã«é¸æŠãŒãªã„å ´åˆ
      if (bulkMode && selectedRoomsBulk.length === 0) {
        alert("âš ï¸ ä¸€æ‹¬å¤‰æ›´å¯¾è±¡ã®éƒ¨å±‹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    };

    statusGrid.appendChild(div);
  });
}


async function changeGroupOrSingle(status, roomEl){
  console.log(status)

  try {
    const statusDiv = roomEl.querySelector(".room-header");
    if(status==='individual'){
          statusDiv.classList.add('group-border');
    }else{
          statusDiv.classList.remove('group-border');
    }


    // https://squid-app-ug7x6.ondigitalocean.app
    await fetch(`${API_URL}/api/room/status/singleGuest`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room_id: roomEl.dataset.id,
        status,
      }),
    });
  } catch (err) {
    console.error(`âŒ ${roomEl.dataset.room} æ›´æ–°å¤±æ•—`, err);
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰é–¢æ•°
function openModal(modal) { modal.style.display = "flex"; }
function closeModal(modal) {
  console.log(modal)
  modal.style.display = "none";
}

closeButtons.forEach(btn => btn.onclick = () => closeModal(btn.closest(".modal")));
window.onclick = (e) => {
  if (e.target.classList.contains("modal")) closeModal(e.target);
};


// ============================
// ğŸ§´ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼ï¼ˆäº¤æ›ãƒ»è£œå……ãƒ»å›åï¼‰
// ============================

const amenityBtn = document.getElementById("amenityBtn");
const amenityTypeModalTop = document.getElementById("amenityTypeModalTop");
const amenityModal = document.getElementById("amenityModal");
const amenityGrid = document.getElementById("amenityGrid");
const returnModal = document.getElementById("returnModal");
// const returnFrontBtn = document.getElementById("returnFrontBtn");
const returnStorageBtn = document.getElementById("returnStorageBtn");

let selectedAmenity = null;
let selectedAmenityType = null;

// ğŸ”¸ ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
amenityBtn.disabled = false;

// ğŸ”¸ ã€Œã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ãƒ»ä»–ä¾é ¼ã€ã‚¯ãƒªãƒƒã‚¯ â†’ ç¨®é¡é¸æŠã¸
amenityBtn.addEventListener("click", () => {
  closeModal(actionModal);
  openModal(amenityTypeModalTop);
});

// ğŸ”¸ äº¤æ›ï¼è£œå……ï¼å›åãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã‹
document.querySelectorAll(".amenity-type-btn").forEach(btn => {

  btn.addEventListener("click", () => {
      console.log('here')
    selectedAmenityType = btn.dataset.type;
    console.log(selectedAmenityType)
    closeModal(amenityTypeModalTop);
    openModal(amenityModal);
    renderAmenityOptions();
  });
});

const closeAmenityModalBtn = document.querySelector(".close-btn-amenity-modal");

closeAmenityModalBtn.addEventListener("click", () => {
closeModal(amenityTypeModalTop)
});

// ğŸ”¸ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¸€è¦§
const amenities = [
  "ã¾ãã‚‰",
  "ãƒãƒ³ã‚¬ãƒ¼",
  "å……é›»å™¨",
  "æ‰‡é¢¨æ©Ÿ",
  "ã‚¢ã‚¤ã‚¹ãƒšãƒ¼ãƒ«",
  "å»¶é•·ã‚³ãƒ¼ãƒ‰",
  "åŠ æ¹¿å™¨",
  "å–«ç…™â†’ç¦ç…™åˆ‡ã‚Šæ›ãˆ"
];



function renderAmenityOptions() {
  amenityGrid.innerHTML = "";
  amenities.forEach(item => {
    const div = document.createElement("div");
    div.className = "status-option";
    div.innerHTML = `<span></span><small>${item}</small>`;

    div.onclick = async () => {
      selectedAmenity = item;
      closeModal(amenityModal);

      // âœ… æ¡ä»¶åˆ†å²ï¼šäº¤æ› or å›å â†’ è¿”å´å…ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      if (selectedAmenityType === "äº¤æ›" || selectedAmenityType === "å›å") {
        openModal(returnModal);
      }
      // âœ… è£œå…… â†’ è¿”å´å…ˆãªã—ã§å³ç™»éŒ²
      else if (selectedAmenityType === "è£œå……") {
        const payload = {
          room_id: selectedRoom.dataset.id,
          action_type: selectedAmenityType,
          amenity: selectedAmenity
        };
        try {
          showLoading();
          const res = await fetch(`${API_URL}/api/room/amenity`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const result = await res.json();
          hideLoading();
          if (result.success) {
            alert(`éƒ¨å±‹ ${selectedRoom.dataset.room}ï¼š${selectedAmenity} ã®ã€Œè£œå……ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
          } else {
            alert(`âš ï¸ ç™»éŒ²å¤±æ•—: ${result.error}`);
          }
        } catch (err) {
          hideLoading();
          console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
        }
        // ãƒªã‚»ãƒƒãƒˆ
        selectedAmenity = null;
        selectedAmenityType = null;
      }
    };

    amenityGrid.appendChild(div);
  });
}



// ğŸ”¸ è¿”å´å…ˆé¸æŠ
async function handleReturnToDisnation(location) {
  if (!selectedRoom || !selectedAmenityType || !selectedAmenity) return;

  const payload = {
    room_id: selectedRoom.dataset.id,
    action_type: selectedAmenityType,  // äº¤æ›ï¼è£œå……ï¼å›å
    amenity: selectedAmenity,
    return_to: location
  };

  try {
    showLoading()
    const res = await fetch(`${API_URL}/api/room/amenity`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    hideLoading();
    if (result.success) {
      alert(`éƒ¨å±‹ ${selectedRoom.dataset.room}ï¼š${selectedAmenity} ã®ã€Œ${selectedAmenityType}ã€ã‚’ ${location} ã«ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
    } else {
      alert(`âš ï¸ ç™»éŒ²å¤±æ•—: ${result.error}`);
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
  }

  // ãƒªã‚»ãƒƒãƒˆ
  selectedAmenity = null;
  selectedAmenityType = null;
  closeModal(returnModal);
}

// ãƒ•ãƒ­ãƒ³ãƒˆãƒœã‚¿ãƒ³
const returnFrontBtn = document.getElementById("returnFrontBtn");
if (returnFrontBtn) {
  returnFrontBtn.addEventListener("click", () => handleReturnToDisnation("ãƒ•ãƒ­ãƒ³ãƒˆ"));
}

// 4Fã€œ12Fãƒªãƒãƒ³åº«ãƒœã‚¿ãƒ³
document.querySelectorAll(".linen-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const floor = btn.dataset.floor;
    handleReturnToDisnation(`${floor}Fãƒªãƒãƒ³åº«`);
  });
});

// å…±é€šå‡¦ç†é–¢æ•°
// function handleReturn(destination) {
//   console.log(`ğŸ“¦ ${destination} ã«æˆ»ã—ã¾ã™`);
//   // ã“ã“ã«å®Ÿéš›ã®å‡¦ç†ã‚’è¿½åŠ ï¼ˆä¾‹ï¼šAPIå‘¼ã³å‡ºã—ã€çŠ¶æ…‹æ›´æ–°ãªã©ï¼‰
//   handleReturn(destination)
// }


console.log('yes')

const roomDetailModal = document.getElementById("roomDetailModal");
const saveRoomDetailBtn = document.getElementById("saveRoomDetailBtn");
const guestNameInput = document.getElementById("guestName");
const checkoutTimeInput = document.getElementById("checkoutTime");
const guestCountInput = document.getElementById("guestCount");
const notesInput = document.getElementById("notes");

// é–‹ãå‡¦ç†
function openRoomDetailModal(roomElement) {
  const modal = document.getElementById("roomDetailModal");

  // datasetã‹ã‚‰æƒ…å ±ã‚’å–å¾—
  document.getElementById("guestName").value = roomElement.dataset.guest_name || "";
  document.getElementById("checkoutTime").value = roomElement.dataset.checkout_time || "";
  document.getElementById("guestCount").value = roomElement.dataset.guest_count || "";
  document.getElementById("notes").value = roomElement.dataset.notes || "";

  openModal(roomDetailModal);
}

// ä¿å­˜å‡¦ç†
saveRoomDetailBtn.addEventListener("click", async () => {
  const payload = {
    room_id: selectedRoom.dataset.id,
    guest_name: guestNameInput.value,
    checkout_time: checkoutTimeInput.value,
    guest_count: guestCountInput.value,
    notes: notesInput.value
  };

  try {
    showLoading();
    const res = await fetch(`${API_URL}/api/room/details`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    hideLoading();

    if (result.success) {
      alert("ğŸ’¾ éƒ¨å±‹æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
      // datasetã‚’æ›´æ–°ï¼ˆå†è¡¨ç¤ºç”¨ï¼‰
      selectedRoom.dataset.guestName = payload.guest_name;
      selectedRoom.dataset.checkoutTime = payload.checkout_time;
      selectedRoom.dataset.guestCount = payload.guest_count;
      selectedRoom.dataset.notes = payload.notes;
    } else {
      alert(`âš ï¸ æ›´æ–°å¤±æ•—: ${result.error}`);
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
  }

  closeModal(roomDetailModal);
});

const amenityListBtn = document.getElementById("amenityListBtn");
const amenityListModal = document.getElementById("amenityListModal");
const amenityListBody = document.getElementById("amenityListBody");

// ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
amenityListBtn.addEventListener("click", () => {
  openModal(amenityListModal);
  loadAmenityRequests();
});

// ä¾é ¼ä¸€è¦§ã‚’å–å¾—
async function loadAmenityRequests() {
  try {
    showLoading();
    const res = await fetch(`${API_URL}/api/room/amenity/list`); // â† æ–°API
    hideLoading();
    if (!res.ok) throw new Error("APIå–å¾—å¤±æ•—");

    const data = await res.json();
    const list = data.requests || [];

    amenityListBody.innerHTML = "";

    if (list.length === 0) {
      amenityListBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
      return;
    }

    list.forEach(req => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${req.room_number}</td>
        <td>${req.amenity}</td>
        <td>${req.action_type}</td>
        <td>${req.return_to || "-"}</td>
        <td>${new Date(req.created_at).toLocaleString("ja-JP")}</td>
        <td><button onclick="completeAmenity(${req.id})">å®Œäº†</button></td>
      `;
      amenityListBody.appendChild(tr);
    });
  } catch (err) {
    hideLoading();
    console.error("âŒ ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¸€è¦§ã‚¨ãƒ©ãƒ¼:", err);
    amenityListBody.innerHTML = `<tr><td colspan="6" style="color:red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>`;
  }
}

// å®Œäº†å‡¦ç†ï¼ˆå‰Šé™¤ï¼‰
async function completeAmenity(id) {
  if (!confirm("ã“ã®ä¾é ¼ã‚’å®Œäº†ã¨ã—ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  try {
    showLoading();
    const res = await fetch(`${API_URL}/api/room/amenity/${id}`, {
      method: "DELETE"
    });
    const result = await res.json();
    hideLoading();

    if (result.success) {
      alert("âœ… å®Œäº†ã—ã¾ã—ãŸï¼");
      loadAmenityRequests(); // å†èª­è¾¼
    } else {
      alert("âš ï¸ å‰Šé™¤å¤±æ•—: " + result.error);
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", err);
  }
}
function showActionModal(roomData) {
  const modal = document.getElementById("actionModal");
  const closeBtn = modal.querySelector(".close-btn");
  const statusBtn = modal.querySelector("#statusChangeBtn");
  const amenityBtn = modal.querySelector("#amenityBtn");

  // è¡¨ç¤º
  modal.style.display = "flex";



  // é–‰ã˜ã‚‹å‡¦ç†
  closeBtn.onclick = () => (modal.style.display = "none");
  modal.onclick = (e) => {
    if (e.target.id === "actionModal") modal.style.display = "none";
  };

  // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  // statusBtn.onclick = () => {
  //   console.log(`ğŸŸ¢ ${roomData.room_number} éƒ¨å±‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´`);
  //   modal.style.display = "none";
  //   // â†’ ã“ã“ã«åˆ¥ã®ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ãå‡¦ç†ãªã©ã‚’è¿½åŠ å¯
  // };

  amenityBtn.onclick = () => {
    console.log(`ğŸ§´ ${roomData.room_number} ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼`);
    modal.style.display = "none";
    // â†’ ã“ã“ã§ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©ã‚’é–‹ãå‡¦ç†ã¸
  };
}

let bulkMode = false;
let selectedRoomsBulk = [];

const bulkChangeBtn = document.getElementById("bulkChangeBtn");

// ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
document.getElementById("bulkModeBtn").addEventListener("click", (e) => {
  bulkMode = !bulkMode;
  selectedRoomsBulk = [];

  e.target.classList.toggle("active", bulkMode);
  e.target.textContent = bulkMode ? "âœ… é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­" : "ğŸ§© ä¸€æ‹¬ç™»éŒ²";
  document.querySelectorAll(".room").forEach((room) => {
    room.classList.remove("selected-bulk");
  });

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹/ç„¡åŠ¹
  bulkChangeBtn.disabled = !bulkMode;
});

// âœ… ã€ŒğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
bulkChangeBtn.addEventListener("click", () => {
  if (!bulkMode) return;
  if (selectedRoomsBulk.length === 0) {
    alert("âš ï¸ ä¸€æ‹¬å¤‰æ›´ã™ã‚‹éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  openModal(statusModal);
  renderStatusOptions(); // â† ã“ã“ã§ä¸€æ‹¬å¤‰æ›´å‡¦ç†ãŒå‹•ãï¼ï¼
});

document.getElementById("importExcelBtn").addEventListener("click", () => {
  document.getElementById("excelUpload").click();
});

document.getElementById("excelUpload").addEventListener("change", handleExcelUpload);

async function handleExcelUpload(e) {
  const file = e.target.files[0];
  if (!file) return;

  showLoading();

  try {
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    // ğŸ”¹ Aåˆ—ï¼ˆéƒ¨å±‹ç•ªå·ï¼‰ï¼‹Eåˆ—ï¼ˆæ¸…æƒçŠ¶æ…‹ï¼‰æŠ½å‡º
    const result = [];
    const guestUpdateList = {}; // â† é…åˆ—ã§ã¯ãªãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã™ã‚‹
    const updateToRenpaku = []

    for (let i = 5; i < json.length; i++) {
      const row = json[i];
      const roomNoRaw = row[0];
      const status = row[4];     // Eåˆ—ï¼ˆæ¸…æƒçŠ¶æ…‹ï¼‰
      const guestCount = row[5] ?? 0; // Fåˆ—ï¼ˆäººæ•°ï¼‰
      const renpakuFlag = row[3];     // Dåˆ—ï¼ˆé€£æ³Šãƒ•ãƒ©ã‚°ï¼‰

      if (!roomNoRaw || !status) continue;

      const roomNo = String(roomNoRaw)
        .replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xfee0))
        .replace(/\s/g, "")
        .padStart(4, "0");

        // âœ… äººæ•°æ›´æ–°ãƒªã‚¹ãƒˆ
        guestUpdateList[roomNo] = Number(guestCount) || 0;

        globalRoomStatus[roomNo] = {
          status: status,
          guestCount: guestUpdateList[roomNo],
          renpakuFlag: renpakuFlag || "",
        };


        if(renpakuFlag === 'V'){
          result.push({ roomNo, newStatus: "unused",excelStatus:renpakuFlag,seisouFlag:status});
          continue
        }

        if(renpakuFlag === 'X'){
          result.push({ roomNo, newStatus: "outOf",excelStatus:renpakuFlag,seisouFlag:status});
          continue
        }

        if (status === 'æœªæ¸…æƒ' && renpakuFlag === "S") {
          newStatus = "stay_clean"
          result.push({ roomNo, newStatus: "stay_clean",excelStatus:renpakuFlag,seisouFlag:status});
          continue
        }else if(status === 'æ¸…æƒ' && renpakuFlag === "S"){
          result.push({ roomNo, newStatus:  "stay_noclean",excelStatus:renpakuFlag,seisouFlag:status});
        } else if(status === 'æœªæ¸…æƒ') {
          result.push({ roomNo, newStatus:  "need_clean",excelStatus:renpakuFlag,seisouFlag:status});
          continue
        }

        result.push({roomNo, newStatus:status,excelStatus:renpakuFlag,seisouFlag:status})
    }

    const ok = confirm(`ã‚¨ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`);
    if (!ok) {
      hideLoading();
      return;
    }

    const roomsOnMap = document.querySelectorAll(".room");
    const updatePayload = [];

    for (const room of roomsOnMap) {
      const roomNo = String(room.dataset.room || "")
        .replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xfee0))
        .replace(/\s/g, "")
        .padStart(4, "0");

      const match = result.find(r => r.roomNo === roomNo);
      if (!match) continue;

      updatePayload.push({
        room_id: room.dataset.id,
        room_number: roomNo,
        status: match.newStatus,
        guest_count: guestUpdateList[roomNo] || 0,
        excel_status:match.excelStatus,
        clean_flag:match.seisouFlag
      });
    }

    if (updatePayload.length === 0) {
      hideLoading();
      alert("å¯¾è±¡ã®éƒ¨å±‹ãŒãƒãƒƒãƒ—ä¸Šã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return;
    }



    // âœ… APIå‘¼ã³å‡ºã—
    const res = await fetch(`${API_URL}/api/room/status/bulk`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
          updates: updatePayload,           // â† å¾“æ¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
          updateGuestList: guestUpdateList,  // â† æ–°è¦ï¼šå…¨å®¤ã®äººæ•°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
          hotelId:globalId
        }),

    });

    const resultJson = await res.json();
    hideLoading();

    if (resultJson.success) {
      alert(`âœ… ${resultJson.updated} éƒ¨å±‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸€æ‹¬æ›´æ–°ã—ã¾ã—ãŸï¼`);

      // ğŸ”„ æˆåŠŸå¾Œã«ç”»é¢ã‚’å†ç”Ÿæˆ
      await loadRooms(); // â† å†æç”»ã§å…¨æƒ…å ±ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    } else {
      alert("âš ï¸ ä¸€æ‹¬æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  } catch (err) {
    hideLoading();
    console.error("âŒ Excelè§£æã‚¨ãƒ©ãƒ¼:", err);
    alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
}


document.getElementById("exportStatusBtn").addEventListener("click", exportRoomStatus);

function exportRoomStatus() {
  const rooms = document.querySelectorAll(".room");
  if (!rooms.length) {
    alert("éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  const data = [];

  rooms.forEach(room => {
    const roomNumber = room.dataset.room;
    const floor = room.closest(".floor")?.querySelector("h3")?.textContent?.replace("F", "") || "";
    const statusClass = Object.keys(icons).find(k => room.classList.contains(k)) || "ä¸æ˜";
    const stayType = room.querySelector(".room-header")?.classList.contains("group-border") ? "ã‚°ãƒ«ãƒ¼ãƒ—" : "å€‹åˆ¥";
    const checkoutStatus = room.querySelector(".room-status")?.classList.contains("checkout-border") ? "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ¸ˆ" : "æ»åœ¨ä¸­";
    const guestCount = room.dataset.guest_count || "0";

    data.push({
      éƒ¨å±‹ç•ªå·: roomNumber,
      éš: floor,
      ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: statusLabels[statusClass] || statusClass,
      æ»åœ¨ã‚¿ã‚¤ãƒ—: stayType,
      ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹: checkoutStatus,
      å®¿æ³Šäººæ•°: guestCount,
    });
  });

  // ğŸ”¹ Excel ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ä½œæˆ
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Room Status");

  // ğŸ”¹ æ—¥ä»˜å…¥ã‚Šãƒ•ã‚¡ã‚¤ãƒ«å
  const today = new Date().toISOString().slice(0, 10);
  const fileName = `room_status_${today}.xlsx`;

  XLSX.writeFile(wb, fileName);
}

function showBulkConfirmModal() {
  return new Promise((resolve) => {
    const modal = document.getElementById("bulkConfirmModal");
    modal.style.display = "flex";

    const okBtn = document.getElementById("bulkOkBtn");
    const cancelBtn = document.getElementById("bulkCancelBtn");

    const cleanup = (result) => {
      modal.style.display = "none";
      okBtn.onclick = null;
      cancelBtn.onclick = null;
      resolve(result);
    };

    okBtn.onclick = () => {
      cleanup({
        ok: true,
        updateStatus: document.getElementById("chkStatus").checked,
        updateGuest: document.getElementById("chkGuest").checked,
      });
    };

    cancelBtn.onclick = () => cleanup({ ok: false });
  });
}

// const amenityModal = document.getElementById("amenityTypeModal");
const otherBtn = document.getElementById("otherRequestBtn");
const otherArea = document.getElementById("otherRequestArea");
const sendOtherBtn = document.getElementById("sendOtherRequestBtn");
const input = document.getElementById("otherRequestInput");

// ãã®ä»–ã®ä¾é ¼ã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
otherBtn.addEventListener("click", () => {
  otherArea.classList.toggle("hidden");
  input.focus();
});

// ğŸ“¨ ãã®ä»–ä¾é ¼é€ä¿¡å‡¦ç†
sendOtherBtn.addEventListener("click", async () => {
  const text = input.value.trim();
  if (!text) {
    alert("ä¾é ¼å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  try {
    showLoading()
    const res = await fetch(`${API_URL}/api/room/other-request`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room_id: currentRoomId,       // â† ç¾åœ¨ã®éƒ¨å±‹ID
        instruction: text             // â† å…¥åŠ›å†…å®¹
      }),
    });

hideLoading()

    if (res.ok) {
      alert("ä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
      input.value = "";
      otherArea.classList.add("hidden");
      amenityModal.style.display = "none";
    } else {
      alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  } catch (err) {
    console.error(err);
    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
  }
});

// âœ– ãƒœã‚¿ãƒ³ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å‡¦ç†

// const amenityModal = document.getElementById("amenityTypeModal");



const masterBtn = document.getElementById("masterBtn");
const otherModal = document.getElementById("otherRequestListModal");
const otherBody = document.getElementById("otherRequestBody");

// âš™ï¸ ä»–æŒ‡ç¤ºä¸€è¦§ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å–å¾—ï¼†è¡¨ç¤º
masterBtn.addEventListener("click", async () => {
  console.log(currentHotelId)
  otherModal.style.display = "flex";
  otherBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>`;

  try {
    const res = await fetch(`${API_URL}/api/room/other-request/list?hotel_id=${globalId}`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      otherBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">ãã®ä»–ã®ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
      return;
    }

    // è¡¨çµ„ã¿ç”Ÿæˆ
    otherBody.innerHTML = "";
    data.forEach((r) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${r.floor || "-"}</td>
        <td>${r.room_number || "-"}</td>
        <td style="text-align:left; white-space:pre-wrap;">
          ${r.notes.replace(/ğŸ“/g, "ğŸ“ ")}
          <button class="delete-btn" data-id="${r.id}">ğŸ—‘å‰Šé™¤</button>
        </td>
        <td>${r.updated_at ? new Date(r.updated_at).toLocaleString("ja-JP") : "-"}</td>
      `;

      otherBody.appendChild(tr);
    });

    // ğŸ—‘å‰Šé™¤ãƒœã‚¿ãƒ³å‡¦ç†
    otherBody.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const id = btn.dataset.id;

        if (!confirm("ã“ã®éƒ¨å±‹ã®ã€ãã®ä»–ä¾é ¼ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
          const res = await fetch(`${API_URL}/api/room/other-request/${id}`, {
            method: "DELETE"
          });

          const result = await res.json();

          if (res.ok) {
            alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
            btn.closest("tr").remove(); // ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å‰Šé™¤
          } else {
            alert(result.error || "å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        } catch (err) {
          console.error(err);
          alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
      });
    });


  } catch (err) {
    console.error(err);
    otherBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>`;
  }
});

// âœ– é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
otherModal.querySelector(".close-btn").addEventListener("click", () => {
  otherModal.style.display = "none";
});

// èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚é–‰ã˜ã‚‹
otherModal.addEventListener("click", (e) => {
  if (e.target === otherModal) {
    otherModal.style.display = "none";
  }
});


//1æ—¥ã®ç· ãƒªã‚¹ãƒˆä½œæˆ

const closeDayBtn = document.getElementById("closeDayBtn");
const closeDayModal = document.getElementById("closeDayModal");
const closeDayCancel = document.getElementById("closeDayCancel");
const closeDaySubmit = document.getElementById("closeDaySubmit");
const closeDayDate = document.getElementById("closeDayDate");

// ãƒ¢ãƒ€ãƒ«é–‹ã
closeDayBtn.addEventListener("click", () => {
  closeDayDate.value = new Date().toISOString().split("T")[0];
  closeDayModal.style.display = "flex";
});

// ãƒ¢ãƒ€ãƒ«é–‰ã˜ã‚‹
closeDayCancel.addEventListener("click", () => {
  closeDayModal.style.display = "none";
});

// ç™»éŒ²
closeDaySubmit.addEventListener("click", async () => {
  const date = closeDayDate.value;

  if (!date) {
    alert("æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  try {
     showLoading()
    const res = await fetch(`${API_URL}/api/room/daily-list/close`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ work_date: date, hotel_id: globalId})
    });

    const data = await res.json();
    hideLoading()

    if (data.exists) {
      alert("âš ï¸ æ—¢ã«ã“ã®æ—¥ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚");
    } else if (data.success) {
      alert("âœ… ç™»éŒ²ã—ã¾ã—ãŸï¼");
      closeDayModal.style.display = "none";
    } else {
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }

  } catch (err) {
    hideLoading()
    console.error(err);
    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
  }
});

fixCloseDayBtn.addEventListener("click", () => {
  document.getElementById("fixCloseDayModal").style.display = "flex";
});

async function loadFixCloseDayData() {
  const date = fixCloseDayDate.value;
  if (!date) return alert("æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„");

  showLoading();

  const res = await fetch(`${API_URL}/api/room/daily_room_list?date=${date}&hotel_id=${globalId}`);
  const data = await res.json();

  hideLoading();

  console.log(data)

  if(data.rows.length === 0){
    alert('é¸æŠæ—¥ã®ç· ã‚ãƒ‡ãƒ¼ã‚¿ã¯å­˜åœ¨ã—ã¾ã›ã‚“')
    return
  }

  // ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
  renderFixCloseDayList(data.rows || []);
}

function renderFixCloseDayList(rows) {
  rows.sort((a, b) => Number(a.floor) - Number(b.floor));

  console.log(rows)
  let html = `
    <table class="fix-table">
      <tr>
        <th>éƒ¨å±‹</th>
        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
        <th>ã‚²ã‚¹ãƒˆã‚¿ã‚¤ãƒ—</th>
        <th>ä»–ä¾é ¼</th>

      </tr>
  `;

  rows.forEach(r => {
    html += `
      <tr data-id="${r.id}">

        <td>${r.room_number}</td>

        <!-- ğŸ”¥ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆï¼‰ -->
        <td>
          <select class="fix-status">
            ${Object.entries(statusLabels).map(([key, jp]) => `
              <option value="${key}" ${r.sub_status === key ? "selected" : ""}>${jp.replace("<br>", " ")}</option>
            `).join("")}
          </select>
        </td>

        <!-- ğŸ”¥ ã‚²ã‚¹ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆFIT / å›£ä½“ï¼‰ -->
        <td>
          <select class="fix-stay-type">
            <option value="single" ${r.stay_type === "individual" ? "selected" : ""}>FIT</option>
            <option value="group"  ${r.stay_type === "group"  ? "selected" : ""}>å›£ä½“</option>
          </select>
        </td>

        <!-- ğŸ”¥ ã‚³ãƒ¡ãƒ³ãƒˆ -->
        <td>
          <textarea class="fix-notes">${r.notes || ""}</textarea>
        </td>



      </tr>
    `;
  });

  html += "</table>";

  document.getElementById("fixCloseDayList").innerHTML = html;
}

async function submitFixCloseDay() {
  console.log('koko2306')
  const rows = [...document.querySelectorAll(".fix-table tr[data-id]")].map(tr => ({
    id: tr.dataset.id,
    status: tr.querySelector(".fix-status").value,
    stay_type: tr.querySelector(".fix-stay-type").value,
    notes: tr.querySelector(".fix-notes").value
  }));

  console.log(rows)

  showLoading();

  const res = await fetch(`${API_URL}/api/room/daily-list/update`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ rows, hotel_id: globalId }),
  });

  hideLoading();

  const data = await res.json();
  if (data.success) {
    alert("ä¿®æ­£ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    closeFixCloseDayModal();
  } else {
    alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼");
  }
}




document.addEventListener("input", function (e) {
  if (e.target.classList.contains("fix-notes")) {
    e.target.style.height = "auto";
    e.target.style.height = (e.target.scrollHeight + 2) + "px";
  }
});

function closeFixCloseDayModal(){
  const fixModal = document.getElementById('fixCloseDayModal')
  fixModal.style.display='none'
}




// ================================
// ğŸš€ åˆæœŸåŒ–
// ================================
loadRooms();
</script>
</body>
</html>
