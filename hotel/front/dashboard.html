<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>RoomSync Painel Administrativo</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="./dashboard.css">
</head>

<body>
<header>
  <div class="logo">
    <img src="./img/logo.png" alt="RoomSync ãƒ­ã‚´">
    <!-- <div>RoomSync</div> -->
  </div>
  <div class="menu-btn" onclick="toggleMenu()">
    <i class="fas fa-bars"></i>
  </div>
</header>

<!-- SIDE MENU -->
<div class="side-menu" id="sideMenu">
  <h3>Menu</h3>
  <div class="menu-item" onclick="openDashboard()">Dashboard</div>
  <div class="menu-item" onclick="openServiceList()">Lista de quartos</div>
  <div class="menu-item" onclick="openServiceRegister()">Registrar ServiÃ§os</div>

<div class="menu-item" onclick="openUserAdmin()">Gerenciar UsuÃ¡rios</div>
  <!-- <div class="menu-item" onclick="goLogs()">HistÃ³rico</div> -->
  <!-- <div class="menu-item" onclick="goAmenity()">Pedidos de Amenidades</div>
  <div class="menu-item" onclick="goRooms()">Mapa dos Quartos</div>
  <div class="menu-item" onclick="goExcel()">Exportar Excel</div> -->

  <div class="menu-item" onclick="logout()">Sair</div>
</div>

<!-- ğŸ”¥ æ—¥ä»˜é¸æŠã‚¨ãƒªã‚¢ï¼ˆDashboardæœ€ä¸Šéƒ¨ã«è¿½åŠ ï¼‰ -->
<div class="date-selector" id='data-selector'>
<label for="dailyDate">Data selecionada:</label>
<input type="date" id="dailyDate" onchange="loadDashboard()" />
</div>
<div class="floor-buttons" id="floorButtons"></div>
<div class="dashboard" id="dashboard">




  <div class="dash-card" style="background-color: #2196f3" onclick="openTomorrowModal('today')">
    <h1 id="card_before">--</h1>
    <p>Para limpar</p>
  </div>

  <div class="dash-card" style="background-color: #9c27b0" onclick="openTomorrowModal('opend')">
    <h1 id="card_progress">--</h1>
    <p>Abertos</p>
  </div>

  <div class="dash-card" style="background-color: #e74c3c" onclick="openTomorrowModal('done')">
    <h1 id="card_done">--</h1>
    <p>Finalizados</p>
  </div>

  <div class="dash-card" style='background-color: green' onclick="openTomorrowModal('checked')">
    <h1 id="card_checked">--</h1>
    <p>Verificados</p>
  </div>

  <div class="dash-card orange" onclick="openAmenityListModal('amenity')">
    <h1 id="card_amenity">--</h1>
    <p>Amenity</p>
  </div>


  <div class="dash-card orange" onclick="openAmenityObervacion('note')">
  <h1 id="card_observation">0</h1>
  <p>ObservaÃ§Ã£o</p>
</div>


<div class="dash-card " style='background-color:#333'onclick="openTomorrowModal('tomorrow')">
  <h1 id="card_tomorrow">--</h1>
  <p>Para limpar AmanhÃ£</p>
</div>


</div>
<div id="tabela-overlay"></div>
<div class="tabela-div-mother">
<div id="tabela-div"></div>




<!-- <h3 style="padding:16px 16px 0;">Por Andar</h3> -->




<div id="floorModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span id="modalFloorName">Andar</span>
      <button class="close-btn" onclick="closeFloorModal()">âœ•</button>
    </div>

    <div id="modalRoomList" class="modal-body">
      <!-- éƒ¨å±‹ä¸€è¦§ã‚’ã“ã“ã«è¡¨ç¤º -->
    </div>
  </div>
</div>



<!-- USER ADMIN MODAL -->
<div id="userAdminModal" class="modal">
  <div class="modal-box">

    <div class="modal-header">
      <span>Gerenciar UsuÃ¡rios</span>
      <button class="close-btn" onclick="closeUserAdmin()">âœ•</button>
    </div>

    <div class="modal-content">

      <button class="admin-btn" onclick="showUserForm('create')">Cadastrar UsuÃ¡rio</button>
      <button class="admin-btn" onclick="openEditUserModal()">Alterar UsuÃ¡rio</button>
      <button class="admin-btn" onclick="openDeleteUserModal()">Excluir UsuÃ¡rio</button>

      <div id="userFormArea" class="user-form-area"></div>

    </div>
  </div>
</div>

<div id="toast" class="toast"></div>


<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="spinner"></div>
  <p>å‡¦ç†ä¸­ã§ã™â€¦</p>
</div>

<!-- USER LIST MODAL -->
<div id="userSelectModal" class="modal">
  <div class="modal-content user-modal">
    <div class="modal-header">
      <h3>Selecionar UsuÃ¡rio</h3>
      <button class="close-btn" onclick="closeUserSelect()">âœ•</button>
    </div>

    <div id="userListBox" class="user-list-box"></div>
  </div>
</div>

<!-- TOMORROW CLEAN MODAL -->
<div id="tomorrowModal" class="modal">
  <div class="modal-box floor-summary-box">
    <div class="modal-header">
      <span>Limpeza AmanhÃ£ â€” Por Andar</span>
      <button class="close-btn" onclick="closeTomorrowModal()">âœ•</button>
    </div>

    <div id="tomorrowFloorList" class="modal-body floor-summary-body">
      <!-- JS ã«ã¦æŒ¿å…¥ -->
    </div>
  </div>
</div>

<!-- SERVICE REGISTER MODAL -->
<div id="serviceRegisterModal" class="modal">
  <div class="modal-box">

    <div class="modal-header">
      <span>Registrar ServiÃ§os</span>
      <button class="close-btn" onclick="closeServiceRegister()">âœ•</button>
    </div>

    <div class="modal-content">
      <label style='display:none'>Selecione a data</label>
      <input style='display:none' type="date" id="serviceDate" onchange="onServiceDateChange()">

      <div id="roomSelectCounter" class="room-select-counter" style='display:none'>
        Operador: -- / 0 quartos
      </div>
      <!-- ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ -->
      <label>Operador</label>
      <select id="bulkWorker" class="worker-select" onchange="onOperatorChange()">
      </select>

      <!-- éƒ¨å±‹ä¸€è¦§ -->
      <div id="bulkRoomList" class="bulk-room-list"></div>

      <!-- ä¸€æ‹¬ãƒœã‚¿ãƒ³ -->
      <button class="assign-bulk-btn" onclick="assignBulk()">Registrar</button>

    </div>
  </div>
</div>



<button id="regisCondition" class="status-btn" onclick="openAssignStatusModal()" style='display:none'>
  SituaÃ§Ã£o de Registro
</button>

<script>

  const API_URL = "https://squid-app-ug7x6.ondigitalocean.app"
  // const API_URL = "http://localhost:3000"
  const globalId = 1
  let globalRoomData = []
  let globalObservation = []
  let globalAmenitys = []
  let globalConferidos = []
  let finalizados = []
  let globalWorkerList = [];
  let globalStayAmenityOnly = []
  let globalAmenityShoukai = []
  let selectedRooms = new Set();
  let selectedOperatorName = "";   // â† é¸æŠä¸­ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åã‚’ä¿å­˜
  let globalAssignedMap = {};
  let currentAssignedCount = [];
  let roomAssignedMap = {};  // room_id â†’ staffId
  let globalRoomDailyList = []
  let globalOpnedRooms = []
  let globalDoneRoos = []
  let globalCheckedRooms = []

  const token = localStorage.getItem("authToken");
  console.log(token)
  if (!token) {
    // ãƒˆãƒ¼ã‚¯ãƒ³ãªã— â†’ ãƒ­ã‚°ã‚¤ãƒ³ã¸å¼·åˆ¶é€é‚„
    window.location.href = "../index.html";
  } else {
    try {
      const decoded = JSON.parse(atob(token.split('.')[1]));

      // ãƒ‡ã‚³ãƒ¼ãƒ‰æˆåŠŸ â†’ decoded ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«æŒãŸã›ã‚‹
      window.decodedUser = decoded;

      userRole = decoded.role
      // userRole = `staffManeger`
      // userRole = `staff`

      // console.log("ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:", decoded);

      // ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
      const now = Math.floor(Date.now() / 1000);
      if (decoded.exp < now) {
        localStorage.removeItem("authToken");
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        window.location.href = "../index.html";
      }

    } catch (e) {
      // console.error("ãƒˆãƒ¼ã‚¯ãƒ³è§£æã‚¨ãƒ©ãƒ¼:", e);

      // ãƒˆãƒ¼ã‚¯ãƒ³ç ´æ â†’ å‰Šé™¤ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã¸
      localStorage.removeItem("authToken");
      window.location.href = "../index.html";
    }
  }
  const decoded = JSON.parse(atob(token.split('.')[1]));

  let operatorId = decoded.id
  // let globalWorkers = []

function toggleMenu() {
  document.getElementById("sideMenu").classList.toggle("open");
}

function logout() {
  localStorage.removeItem("authToken");
  alert("Logout efetuado.");
}

function goUsers() { window.location.href = "./user_admin.html"; }
function goLogs() { window.location.href = "/system_logs.html"; }
function goAmenity() { window.location.href = "/amenity_list.html"; }
function goRooms() { window.location.href = "/rooms_map.html"; }
function goExcel() { window.location.href = "/excel_upload.html"; }

/* Safe load (without login redirect) */
async function loadDashboard() {
  const token = localStorage.getItem("authToken");
  const date = document.getElementById("dailyDate").value;
const hotel_id = globalId; // æ—¢å­˜ã®ãƒ›ãƒ†ãƒ«ID
  // if (!token) return;

  try {
    showLoading()
    const url = `${API_URL}/api/room/daily_room_list?date=${date}&hotel_id=${hotel_id}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("APIå–å¾—å¤±æ•—");

    const data = await res.json();

    const roomData = data.rows || [];

    globalRoomDailyList = data.rows || [];
    // console.log(`globalRoomData`,globalRoomData)

    // console.log(roomData)

    const beforeCleanning = roomData.filter(r =>
      ![
        'stay_amenytyOnliy',
        'noclean',
        'stay_noclean',
        'outOf',
        'unused'
      ].includes(r.sub_status ?? '')
    );


    globalRoomData = beforeCleanning
     //Quartos abertos
    const inProgressRooms = beforeCleanning.filter(r => r.open_flag === 1 && r.cleaned_by === null);
    //Quartos feitos
    const doneRooms = beforeCleanning.filter(r => r.cleaned_by !== null);
    //Quartos checados
    const checked = beforeCleanning.filter(r => r.checked_flag === 1);
    //Quartos com observacoes
    const notes = roomData.filter(r => r.notes !== '' && r.notes !== null);
    //Quartos amenitys
    const stayAmenityOnly = roomData.filter(r => r.sub_status==='stay_amenytyOnliy');
    //Pecar os amenitys
    const API_AMENITIES = await fetch(`${API_URL}/api/room/amenity/list`);
    // globalAmenityShoukai =
    const amenityJson = await API_AMENITIES.json();

        globalAmenitys =amenityJson.requests //amenitys list
        globalAmenityShoukai = [
          ...stayAmenityOnly
        ];
        globalObservation = [
          ...notes,
          ...amenityJson.requests
        ];

        globalStayAmenityOnly = stayAmenityOnly
        globalOpnedRooms = inProgressRooms
        globalDoneRoos = doneRooms
        globalCheckedRooms = checked

    const firstBtn = document.querySelector("#floorButtons button");
    await selectFloor("ALL", firstBtn);

// openServiceList()
   hideLoading()
  } catch (err) {
     hideLoading()
    console.log("Erro:", err);
  }

    // await openServiceList()
}

// ========= è¿½åŠ ï¼šæ˜æ—¥æ¸…æƒã®éšåˆ¥ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« =========
function openTomorrowModal(kubun) {
  const modal = document.createElement("div");
  modal.id = "tomorrowModal";
  modal.className = "modal";
  modal.style.display = "flex";
  let text = 'Limpeza para AmanhÃ£'

  let targetRooms=""

if(kubun==='tomorrow'){
  targetRooms =globalRoomDailyList.filter(r => r.guest_count > 0);
}else if(kubun==='today'){
  text= 'Limpezas para hoje'
  targetRooms =globalRoomData
}else if(kubun==='opend'){
  text= 'Quartos abertos'
  targetRooms =globalOpnedRooms
}else if(kubun==='checked'){
  text= 'Quartos verificados'
  targetRooms =globalCheckedRooms
}else if(kubun==='done'){
  text= 'Quartos finalizados'
  targetRooms = globalDoneRoos
}

  // â‘¡ éšåˆ¥ã«é›†è¨ˆï¼ˆã¾ãš 4Fã€œ12F ã‚’ 0 ã§åˆæœŸåŒ–ï¼‰
  const countByFloor = {};
  for (let f = 4; f <= 12; f++) {
    countByFloor[`${f}F`] = 0;
  }

console.log(`targetRooms`,targetRooms)

  // å¯¾è±¡éƒ¨å±‹ã§ã‚«ã‚¦ãƒ³ãƒˆä¸Šæ›¸ã
  targetRooms.forEach(r => {
    const floor = `${r.floor}F`;
    if (countByFloor[floor] !== undefined) {
      countByFloor[floor]++;
    }
  });

  // â‘¢ æ•°å€¤é †ã«ã‚½ãƒ¼ãƒˆï¼ˆ4F â†’ 12Fï¼‰
  const sortedList = Object.entries(countByFloor).sort((a, b) => {
    const fa = parseInt(a[0]);
    const fb = parseInt(b[0]);
    return fa - fb;
  });

  // â‘£ HTMLãƒªã‚¹ãƒˆç”Ÿæˆ
  let listHtml = "";
  sortedList.forEach(([floor, count]) => {
    listHtml += `
      <div class="floor-row">
        <span>${floor}</span>
        <span class="count">${count}</span>
      </div>
    `;
  });

  // â‘¤ ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“çµ„ã¿ç«‹ã¦
  modal.innerHTML = `
    <div class="modal-box tomorrow-box">
      <div class="modal-header-tomorrow">
        ${text}
        <span class="close-btn" onclick="closeTomorrowModal()">âœ•</span>
      </div>
      <div class="floor-list">
        ${listHtml}
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function closeMenu() {
  document.getElementById("sideMenu").classList.remove("open");
}
// ç”»é¢ã©ã“ã‹ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã®å ´åˆï¼‰
document.addEventListener("click", function (e) {
  const menu = document.getElementById("sideMenu");
  const button = document.querySelector(".menu-btn");

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã„ã¦ã„ã¦ã€ã‚¯ãƒªãƒƒã‚¯å¯¾è±¡ãŒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã‚‚ãƒœã‚¿ãƒ³ã§ã‚‚ãªã„å ´åˆã¯é–‰ã˜ã‚‹
  if (menu.classList.contains("open") &&
      !menu.contains(e.target) &&
      !button.contains(e.target)) {
    closeMenu();
  }
});

function openFloorModal(floor) {
  document.getElementById("modalFloorName").innerText = floor;

  // å–å¾—æ¸ˆã¿ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç‰¹å®šéšã®éƒ¨å±‹ã‚’æŠ½å‡º
  const rooms = globalRoomData.filter(r => `${r.floor}F` === floor);

  const box = document.getElementById("modalRoomList");
  box.innerHTML = "";

  if (rooms.length === 0) {
    box.innerHTML = "<p>Nenhum quarto encontrado.</p>";
  } else {
    rooms.forEach(r => {
      box.innerHTML += `
        <div class="room-item">
          <strong>${r.room_number}</strong> â€” ${r.clean_flag}
        </div>
      `;
    });
  }

  document.getElementById("floorModal").style.display = "flex";
}

function closeFloorModal() {
  document.getElementById("floorModal").style.display = "none";
}

function renderFloorButtons() {
  const box = document.getElementById("floorButtons");
  box.innerHTML = "";

  // ğŸ”µ ã¾ãšã€Œå…¨ãƒ«ãƒ¼ãƒ ã€ãƒœã‚¿ãƒ³
  const allBtn = document.createElement("button");
  allBtn.innerText = "Todos";
  allBtn.classList.add("floor-active");   // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
  allBtn.onclick = () => selectFloor("ALL", allBtn);
  box.appendChild(allBtn);

  // ğŸ”µ 4Fã€œ12F ãƒœã‚¿ãƒ³
  for (let i = 4; i <= 12; i++) {
    const btn = document.createElement("button");
    btn.innerText = `${i}F`;
    btn.onclick = () => selectFloor(`${i}F`, btn);
    box.appendChild(btn);
  }
}

function selectFloor(floor, clickedButton) {
  // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
  document.querySelectorAll(".floor-buttons button").forEach(btn =>
    btn.classList.remove("floor-active")
  );
  clickedButton.classList.add("floor-active");



  let targetRooms = [];
  let amenytyRooms = [];
  let notesRooms = []
  let tomorrowRooms = []
  let stayAmenityOnly =[]

  if (floor === "ALL") {
    targetRooms = globalRoomData;
    amenytyRooms = globalAmenitys;
    tomorrowRooms = globalRoomDailyList.filter(r => r.guest_count >0);
    notesRooms = globalObservation.filter(r => r.notes !== '' && r.notes !== null);
    stayAmenityOnly = globalRoomDailyList.filter(r => r.sub_status==='stay_amenytyOnliy');
  } else {
    targetRooms = globalRoomData.filter(r => `${r.floor}F` === floor);
    notesRooms = globalObservation.filter(r => `${r.floor}F` === floor && r.notes !== '' && r.notes !== null);
    tomorrowRooms = globalRoomDailyList.filter(r => `${r.floor}F` === floor && r.guest_count >0);
    stayAmenityOnly = globalRoomDailyList.filter(r => `${r.floor}F` === floor &&  r.sub_status==='stay_amenytyOnliy');

  }



const inProgressRooms =targetRooms.filter(r => r.open_flag === 1 || r.checked_flag === 1);
//Quartos feitos
const doneRooms = targetRooms.filter(r => r.cleaned_by !== null || r.checked_flag === 1);
//Quartos checados
const checked = targetRooms.filter(r => r.checked_flag === 1);
//Quartos amenitys
// const stayAmenityOnly = globalRoomDailyList.filter(r => r.sub_status==='stay_amenytyOnliy');




  // ã‚«ãƒ¼ãƒ‰æ›´æ–°
  document.getElementById("card_before").innerText = targetRooms?.length ?? 0;
  document.getElementById("card_progress").innerText = inProgressRooms?.length ?? 0;
  document.getElementById("card_done").innerText = doneRooms?.length ?? 0;
  document.getElementById("card_checked").innerText = checked?.length ?? 0;
  document.getElementById("card_amenity").innerText =  (stayAmenityOnly?.length ?? 0);
  document.getElementById("card_observation").innerText = notesRooms?.length ?? 0;
  document.getElementById("card_tomorrow").innerText = tomorrowRooms?.length ?? 0;

}


function openUserAdmin() {
  document.getElementById("userAdminModal").style.display = "flex";
  closeMenu();
}

function closeUserAdmin() {
  document.getElementById("userAdminModal").style.display = "none";
  document.getElementById("userFormArea").innerHTML = "";
}

function showUserForm(type) {
  let area = document.getElementById("userFormArea");
  area.innerHTML = ""; // reset

  if (type === "create") {
    area.innerHTML = `
      <h3>Novo UsuÃ¡rio</h3>
      <input placeholder="Username" id="u_username">
      <input placeholder="Nome" id="u_name">
      <input placeholder="Senha" type="password" id="u_password">
      <select id="u_role">
        <option value="staff">operador</option>
        <option value="staffManeger">operador2</option>
        <option value="inspector">conferente</option>
        <option value="admin">Administrador</option>
      </select>
      <select id="u_contract">
        <option value="baito">Baito (Part-time)</option>
        <option value="fulltime">Full-time</option>
      </select>

      <select id="u_language">
        <option value="pt">PortuguÃªs</option>
        <option value="jp">æ—¥æœ¬èª</option>
        <option value="en">English</option>
      </select>

      <button onclick="submitCreateUser()">Salvar</button>
    `;
  }

  if (type === "edit") {
    area.innerHTML = `
      <h3>Alterar UsuÃ¡rio</h3>
      <input placeholder="Username para alterar" id="e_username">
      <input placeholder="Novo nome" id="e_name">
      <input placeholder="Nova senha (opcional)" id="e_password">
      <select id="e_role">
        <option value="staff">Staff</option>
        <option value="inspector">Inspector</option>
        <option value="admin">Admin</option>
      </select>
      <select id="e_contract">
  <option value="baito">Baito (Part-time)</option>
  <option value="fulltime">Full-time</option>
</select>

<select id="e_language">
  <option value="pt">PortuguÃªs</option>
  <option value="jp">æ—¥æœ¬èª</option>
  <option value="en">English</option>
</select>

      <button onclick="submitEditUser()">Salvar AlteraÃ§Ãµes</button>
    `;
  }

  if (type === "delete") {
    area.innerHTML = `
      <h3>Excluir UsuÃ¡rio</h3>
      <input placeholder="Username para excluir" id="d_username">
      <button onclick="submitDeleteUser()" style="background:#c62828">Excluir</button>
    `;
  }
}

async function submitCreateUser() {
  const payload = {
    username: document.getElementById("u_username").value,
    password: document.getElementById("u_password").value,
    name: document.getElementById("u_name").value,
    role: document.getElementById("u_role").value,
    hotel_id: globalId,
    contract_type: document.getElementById("u_contract").value,
    language: document.getElementById("u_language").value
  };
showLoading()
  const res = await fetch(`${API_URL}/api/user/create`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  hideLoading()

  if (!json.success) {
    showToast(json.error || "Falha ao criar usuÃ¡rio", true);
    return;
  }

  // ğŸ”¥ ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥é€šçŸ¥
  showToast("UsuÃ¡rio criado com sucesso!");

  // ğŸ”¥ å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
  clearInputs(["u_username", "u_password", "u_name"]);

  // role / contract_type / language ã‚’åˆæœŸå€¤ã«æˆ»ã™
  document.getElementById("u_role").value = "staff";
  document.getElementById("u_contract").value = "baito";
  document.getElementById("u_language").value = "pt";
}


async function submitEditUser() {
  const payload = {
    username: document.getElementById("e_username").value,
    newName: document.getElementById("e_name").value,
    newPassword: document.getElementById("e_password").value,
    newRole: document.getElementById("e_role").value,
    newContract: document.getElementById("e_contract").value,
    newLanguage: document.getElementById("e_language").value
  };
showLoading()
  const res = await fetch(`${API_URL}/api/user/update`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const json = await res.json();
hideLoading()
  if (!json.success) {
    showToast(json.error || "Falha ao atualizar usuÃ¡rio", true);
    return;
  }

  showToast("UsuÃ¡rio atualizado!");

  clearInputs(["e_username", "e_name", "e_password"]);
}

async function submitDeleteUser() {
  const username = document.getElementById("d_username").value;
showLoading()
  const res = await fetch(`${API_URL}/api/user/delete`, {
    method: "DELETE",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username })
  });

  const json = await res.json();
hideLoading()
  if (!json.success) {
    showToast(json.error || "Falha ao excluir usuÃ¡rio", true);
    return;
  }

  showToast("UsuÃ¡rio excluÃ­do.");
  clearInputs(["d_username"]);
}

function showToast(message, isError = false) {
  const t = document.getElementById("toast");
  t.innerText = message;

  t.classList.add("show");
  if (isError) t.classList.add("error");
  else t.classList.remove("error");

  setTimeout(() => {
    t.classList.remove("show");
  }, 2500);
}

function clearInputs(ids) {
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
}

async function showLoading() {
  // console.log('kokoni deteru')
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.remove("hidden");
  await new Promise(r => setTimeout(r, 50)); // ğŸ’¡ å¼·åˆ¶çš„ã«å†æç”»
}

function hideLoading() {
  const overlay = document.getElementById("loadingOverlay");
  overlay.classList.add("hidden");
}

async function openUserList(mode) {
  window.userEditMode = mode;
  // mode = "edit" or "delete"

  const res = await fetch(`${API_URL}/api/user/list?hotel_id=1`);
  const json = await res.json();

  console.log(json.users)



  if (!json.success) {
    showToast("Falha ao obter usuÃ¡rios", true);
    return;
  }

  const list = json.users;
  const box = document.getElementById("userListBox");
  box.innerHTML = "";

  list.forEach(u => {
    console.log(u)
    box.innerHTML += `
      <div class="user-item" onclick="selectUser('${u.username}', '${u.name}', '${u.role}', '${u.contract_type}', '${u.language}')">
        <strong>${u.name}</strong>
        <div class="user-role">${u.role}</div>
      </div>
    `;
  });

  document.getElementById("userSelectModal").style.display = "flex";
}

function closeUserSelect() {
  document.getElementById("userSelectModal").style.display = "none";
}

function selectUser(username, name, role, contract, language) {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
  closeUserSelect();

  // ====== ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ ======
  if (window.userEditMode === "edit") {
    document.getElementById("e_username").value = username;
    document.getElementById("e_name").value = name;
    document.getElementById("e_role").value = role;
    document.getElementById("e_contract").value = contract;
    document.getElementById("e_language").value = language;

    showToast("UsuÃ¡rio carregado para ediÃ§Ã£o!");
    return;
  }

  // ====== å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ ======
  if (window.userEditMode === "delete") {
    document.getElementById("d_username").value = username;

    showToast("UsuÃ¡rio selecionado para exclusÃ£o.");
    return;
  }
}

function openEditUserModal() {
  showUserForm('edit');   // â† ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…ˆã«æç”»
  openUserList("edit");   // â† ãã®å¾Œã«ä¸€è¦§è¡¨ç¤º
}

function openDeleteUserModal() {
  showUserForm('delete');
  openUserList("delete");
}






function closeTomorrowModal() {
  const m = document.getElementById("tomorrowModal");
  if (m) m.remove();
}

function openAmenityObervacion(listTYpe) {
  // æ—¢ã«é–‹ã„ã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ã—ã¦å†ç”Ÿæˆï¼ˆäºŒé‡è¡¨ç¤ºé˜²æ­¢ï¼‰
  const old = document.getElementById("amenityListModal");
  if (old) old.remove();

  const modal = document.createElement("div");
  modal.id = "amenityListModal";
  modal.className = "amenity-list-modal";
  modal.style.display = "flex";
  let text=`lista de Amenitys`

  if(listTYpe==='amenity'){
    lists = globalAmenitys
  }else{
    lists = globalObservation
    text = `Lista de observaÃ§Ãµes`
  }

  console.log(lists)

  // â‘¡ HTMLãƒªã‚¹ãƒˆæ§‹ç¯‰
  let listHtml = "";
  if (lists.length === 0) {
    listHtml = `<div class="amenity-empty">Nenhum pedido encontrado.</div>`;
  } else {
    lists.forEach(r => {
console.log(r)
const henkyakusaki = r.action_type === 'å›å'? `è¿”å´å…ˆï¼š${r.return_to}`: ``


const msg = !r.notes ? `${r.amenity}ã‚’${r.action_type} ${henkyakusaki}`: r.notes

      listHtml += `
        <div class="amenity-room-row">
          <div class="amenity-room-number">${r.room_number}</div>
          <div class="amenity-notes">${msg}</div>
        </div>
      `;
    });
  }

  // â‘¢ ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“
  modal.innerHTML = `
    <div class="amenity-list-modal-box">
      <div class="amenity-list-header">
        ${text}
        <span class="amenity-list-close" onclick="closeAmenityListModal()">âœ•</span>
      </div>

      <div class="amenity-list-body">
        ${listHtml}
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function openAmenityListModal(listType) {
  const old = document.getElementById("amenityListModal");
  if (old) old.remove();
  console.log(`listType`,listType)

  const modal = document.createElement("div");
  modal.id = "amenityListModal";
  modal.className = "amenity-list-modal";
  modal.style.display = "flex";

  console.log(`listType`,listType)

  let lists = [];
  let title = "";

  if (listType === "amenity") {
    lists = globalAmenityShoukai;   // â†çµåˆã—ãŸã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¸€è¦§
    title = "Lista de Amenitys";
  } else {
    lists = globalObservation;
    title = "Lista de observaÃ§Ãµes";
  }


  let listHtml = "";

  if (lists.length === 0) {
    listHtml = `<div class="amenity-empty">Nenhum pedido encontrado.</div>`;
  } else {
    lists.forEach(r => {
      console.log(r)
      const isNormalAmenity = r.action_type !== undefined;

      let msg = "-";

      if (isNormalAmenity) {
        // âœ” é€šå¸¸ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ä¾é ¼
        // const
        msg = `${r.amenity || ""}ï¼ˆ${r.action_type || ""} â†’ ${r.return_to || ""}ï¼‰`;
      } else {
        // âœ” STAYã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ Only ã®éƒ¨å±‹ â†’ notesã¯çµ¶å¯¾ä½¿ã‚ãªã„
        msg = "STAYã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã®å¯¾å¿œ";
      }

      listHtml += `
        <div class="amenity-room-row">
          <div class="amenity-room-number">${r.room_number}</div>
          <div class="amenity-notes">${msg}</div>
        </div>
      `;
    });
  }

  modal.innerHTML = `
    <div class="amenity-list-modal-box">
      <div class="amenity-list-header">
        ${title}
        <span class="amenity-list-close" onclick="closeAmenityListModal()">âœ•</span>
      </div>

      <div class="amenity-list-body">
        ${listHtml}
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}


function closeAmenityListModal() {
  const modal = document.getElementById("amenityListModal");
  if (modal) modal.remove();
}


async function openServiceRegister() {
  selectedRooms = new Set();
  selectedOperatorName = "--";
  updateRoomSelectCounter();

  document.getElementById("serviceRegisterModal").style.display = "flex";
  document.getElementById("roomSelectCounter").style.display = "flex";
  document.getElementById("regisCondition").style.display = "flex";
  closeMenu();

  const now = new Date();
  now.setHours(now.getHours() + 9);  // JSTã«è£œæ­£

  const todayJST = now.toISOString().split("T")[0];
  document.getElementById("serviceDate").value = todayJST;

  await loadWorkerOptions();
  loadBulkRoomList();
   // loadServiceRooms();
}


async function loadWorkerOptions() {
  const res = await fetch(`${API_URL}/api/user/list?hotel_id=${globalId}`);
  const json = await res.json();

  if (!json.success) return;

    globalWorkerList = json.users;
    console.log(`globalWorkerList`,globalWorkerList)

  const staffList = json.users.filter(u => u.role === "staff" || u.role === 'staffManeger');
  const sel = document.getElementById("bulkWorker");
  sel.innerHTML = `<option value="">-- Selecionar --</option>`;

  staffList.forEach(s => {
    sel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
  });
}

async function loadBulkRoomList() {
  const date = document.getElementById("serviceDate").value;

  globalRoomData.sort((a, b) => a.room_number - b.room_number);
  globalRoomDailyList = globalRoomData;

  const box = document.getElementById("bulkRoomList");
  box.innerHTML = "";

console.log(globalRoomDailyList)
console.log(globalAmenityShoukai)

  tgtDatas = [
    ...globalRoomDailyList,
    ...globalAmenityShoukai
  ];

  console.log(tgtDatas)

  tgtDatas.sort((a, b) => a.room_number - b.room_number);
  globalRoomDailyList = tgtDatas;

  tgtDatas.forEach(r => {

// console.log(r)
    // ============================
    // â˜… ã‚¢ã‚¤ã‚³ãƒ³åˆ¤å®š
    // ============================
    let amenytyOnlyFlag = false
    let iconHTML = "";
    if (r.stay_type === "individual") {
      iconHTML = `<img src="./img/esponja.png" class="icon-img-lista">`;
    } else if (r.sub_status === "stay_amenytyOnliy") {
      amenytyOnlyFlag=true
      iconHTML = `<img src="./img/bag.png" class="icon-img-lista">`;
    }

    const operatorName = getStaffNameById(r.assigned_staff_id);

    const assignedClass = r.assigned_staff_id  ? "assigned-room" : "";
    const amenityClass = r.sub_status === "stay_amenytyOnliy" && !r.assigned_staff_id  ? "stay-amenity" : "";
    const amenityOnlyRegisterDone = r.sub_status === "stay_amenytyOnliy" && r.assigned_staff_id  ? "stay-amenity-registDone" : "";



    // if(r.room_number===1118){
    //   console.log(r)
    //   console.log(amenityOnlyRegisterDone)
    //   console.log(amenityClass)
    // }


    // ============================
    // â˜… ç”»é¢æç”»
    // ============================
    box.innerHTML += `
      <div class="bulk-room-item ${assignedClass} ${amenityClass} ${amenityOnlyRegisterDone}"
           id="room_${r.id}"
           onclick="toggleRoomSelect(${r.id})">

        <div class="room-line">
          <strong>${r.room_number}</strong>
          ${iconHTML}
          <span class="operator-name">${operatorName}</span>
        </div>

      </div>
    `;
  });
}


function toggleRoomSelect(roomId) {

  console.log(globalRoomDailyList.map(r => r.id));


  const selectedOperatorId = String(document.getElementById("bulkWorker").value);

  const targetRoom = globalRoomDailyList.find((r) => r.id === roomId);
  const item = document.getElementById(`room_${roomId}`);

  const roomHasAssigned = targetRoom.assigned_staff_id != null && targetRoom.assigned_staff_id !== 0;

  // =========================================================
  // â˜… ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æœªé¸æŠ ï¼† ã“ã®éƒ¨å±‹ã¯ç™»éŒ²æ¸ˆã¿ â†’ åˆæœŸåŒ–ã—ã¦OK
  // =========================================================
  if (!selectedOperatorId && roomHasAssigned) {

    // åˆæœŸåŒ–ï¼ˆè§£é™¤ï¼‰
    targetRoom.assigned_staff_id = null;
    targetRoom.upateFlag = true;  // â† åˆæœŸåŒ–ã‚‚æ›´æ–°å¯¾è±¡ã¨ã—ã¦æ‰±ã†ãªã‚‰ true ã®ã¾ã¾ã§OK

    item.classList.remove("selected-room", "assigned-room");
    item.querySelector(".operator-name").innerText = "";
      currentAssignedCount =globalRoomDailyList.filter(r=> r.assigned_staff_id === selectedOperatorId - 0)

    updateRoomSelectCounter();
    console.log("â˜… æœªé¸æŠã ã‘ã©ç™»éŒ²æ¸ˆ â†’ åˆæœŸåŒ–å®Œäº†");
    return;
  }

  // =========================================================
  // â˜… ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æœªé¸æŠ ï¼† æœªç™»éŒ² â†’ ã‚¨ãƒ©ãƒ¼ï¼ˆå¾“æ¥ã®å‹•ä½œï¼‰
  // =========================================================
  if (!selectedOperatorId) {
    showToast("Selecione o operador", true);
    return;
  }

  // =========================================================
  // â˜… ã™ã§ã«åŒã˜ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ç™»éŒ²æ¸ˆã¿ â†’ è§£é™¤
  // =========================================================
  if (targetRoom.assigned_staff_id === selectedOperatorId - 0) {

    targetRoom.assigned_staff_id = null;
    targetRoom.upateFlag = true;

    item.classList.remove("selected-room", "assigned-room");
    item.querySelector(".operator-name").innerText = "";
      currentAssignedCount =globalRoomDailyList.filter(r=> r.assigned_staff_id === selectedOperatorId - 0)

    updateRoomSelectCounter();
    console.log("â˜… åŒã˜ID â†’ å–ã‚Šæ¶ˆã—å®Œäº†");
    return;
  }

  // =========================================================
  // â˜… é€šå¸¸ã®ç™»éŒ²å‡¦ç†
  // =========================================================
  targetRoom.assigned_staff_id = selectedOperatorId - 0;
  targetRoom.upateFlag = true;

  item.classList.remove("assigned-room");
  item.classList.add("selected-room");

  const workerName = globalWorkerList.find(w => w.id === selectedOperatorId - 0);
  item.querySelector(".operator-name").innerText = workerName?.name ?? "";

  console.log(`é¸æŠå¾Œã®ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ³`,globalRoomDailyList)
  currentAssignedCount =globalRoomDailyList.filter(r=> r.assigned_staff_id === selectedOperatorId - 0)

  updateRoomSelectCounter();
}


// function toggleRoomSelect(roomId) {
//
//   const selectedOperatorId = String(document.getElementById("bulkWorker").value);
//   console.log(roomAssignedMap)
//   console.log(selectedOperatorId)
//   if(!selectedOperatorId){
// showToast("Selecione o operador", true);
//     return
//   }
//
// console.log(`globalRoomDailyList`,globalRoomDailyList)
//   const targetRoom = globalRoomDailyList.filter((r)=> r.id===roomId)
//   console.log(`targetRoom`,targetRoom)
//   console.log(targetRoom[0].assigned_staff_id)
//   console.log(selectedOperatorId)
//
//
//
//   // â˜… DBã§æ—¢ã«ã“ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
//   if (targetRoom[0].assigned_staff_id === selectedOperatorId-0) {
//     console.log("ã“ã®éƒ¨å±‹ã¯ã™ã§ã«ç™»éŒ²æ¸ˆã¿ â†’ ã‚«ã‚¦ãƒ³ãƒˆå¤‰æ›´ã—ãªã„");
//     return;
//   }
//
//   targetRoom[0].assigned_staff_id = selectedOperatorId-0
//   targetRoom[0].upateFlag = true
//
//   const item = document.getElementById(`room_${roomId}`);
//   item.classList.remove(`assigned-room`)
//   item.classList.add("selected-room");
//
//
//
//
// console.log(`AfterglobalRoomDailyList`,globalRoomDailyList)
//
//   const workerName = globalWorkerList.filter(w=> w.id ===selectedOperatorId-0)
//
//   console.log(`workerName`,workerName)
//
//   const assignedCount = globalRoomDailyList.filter((r)=> r.assigned_staff_id-0===selectedOperatorId-0)
//
//
//
//     console.log(`assignedCount`,assignedCount)
//
//   currentAssignedCount = assignedCount.length; // â†â˜…ã“ã‚Œé‡è¦ï¼
//
// // globalWorkerLis
//
//   // selectedOperatorId
//
//   item.querySelector(".operator-name").innerText = workerName[0].name;
//
// console.log(item)
//
//
//   updateRoomSelectCounter();
// }







function closeServiceRegister() {
  currentAssignedCount=[]
  selectedRooms = new Set();
  const modal = document.getElementById("serviceRegisterModal");
  if (modal) modal.style.display = "none";

  document.getElementById("roomSelectCounter").style.display = "none";
  document.getElementById("regisCondition").style.display = "none";


  // å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰æ¶ˆã™
  const list1 = document.getElementById("serviceRoomList");
  if (list1) list1.innerHTML = "";

  const list2 = document.getElementById("bulkRoomList");
  if (list2) list2.innerHTML = "";
}


// async function loadServiceRooms() {
//   const date = document.getElementById("serviceDate").value;
//
//   const res = await fetch(`${API_URL}/api/room/daily_room_list?date=${date}&hotel_id=${globalId}`);
//   const json = await res.json();
//   const rooms = json.rows;
//
//   // â˜… ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚’åˆæœŸåŒ–
//   globalAssignedMap = {};
//
//   rooms.forEach(r => {
//     if (!r.assigned_staff_id) return;
//
//     const staffId = String(r.assigned_staff_id);
//
//     // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ â†’ éƒ¨å±‹
//     if (!globalAssignedMap[staffId]) {
//       globalAssignedMap[staffId] = [];
//     }
//     globalAssignedMap[staffId].push(r.room_id);
//
//     // éƒ¨å±‹ â†’ ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼
//     roomAssignedMap[r.room_id] = staffId;
//   });
//
//   console.log("ğŸŸ¦ globalAssignedMap", globalAssignedMap);
// }




// async function loadWorkerList() {
//   const res = await fetch(`${API_URL}/api/user/list?hotel_id=${globalId}`);
//   const json = await res.json();
//
//   if (!json.success) return;
//
//   const workers = json.users.filter(u => u.role === "staff");
//   console.log(`workers`,workers)
//   globalWorkers = workers
//
//   workers.forEach(w => {
//     document.querySelectorAll(".worker-select").forEach(sel => {
//       sel.innerHTML += `<option value="${w.username}">${w.name}</option>`;
//     });
//   });
// }

async function assignBulk() {
  const worker = document.getElementById("bulkWorker").value;

  const targetUpdate = globalRoomDailyList
    .filter(r => r.upateFlag === true)
    .map(r => ({
      room_id: r.id,
      worker: r.assigned_staff_id
    }));

  const payload = {
    hotel_id: globalId,
    date: document.getElementById("serviceDate").value,
    updates: targetUpdate
  };

  targetUpdate.forEach(({ room_id, worker }) => {
    const item = document.getElementById(`room_${room_id}`);
    if (!item) return;
    item.classList.remove("selected-room");
    item.classList.add("assigned-room");
  });

  showLoading();

  const res = await fetch(`${API_URL}/api/room/assign_bulk`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  hideLoading();
  const json = await res.json();
  if (!json.success) {
    showToast("Falha ao atribuir!", true);
    return;
  }
  showToast("AtualizaÃ§Ã£o concluÃ­da!");
}


function getStaffNameById(id) {
  if (!id) return "";
  // console.log(`globalWorkerList`,globalWorkerList)
  const found = globalWorkerList.find(u => u.id == id);
  return found ? found.name : "";
}

function onOperatorChange() {
  const sel = document.getElementById("bulkWorker");
  console.log(`sel`,sel)
  const operatorId = String(sel.value);
  console.log(`operatorId`,operatorId)

  selectedOperatorName = sel.options[sel.selectedIndex].text || "--";

  console.log(`selectedOperatorName`,selectedOperatorName)

  console.log(globalRoomDailyList)


  const assignedCount = globalRoomDailyList.filter((r)=> r.assigned_staff_id-0===operatorId-0)



    console.log(`assignedCount`,assignedCount)

  currentAssignedCount = assignedCount;

  updateRoomSelectCounter();
}



function updateRoomSelectCounter() {

console.log(currentAssignedCount)
console.log(selectedRooms.size)

const quartosAmenitys = currentAssignedCount.filter(r => r.sub_status==='stay_amenytyOnliy')
const quartosLimpar  = currentAssignedCount.length - quartosAmenitys.length

console.log(`quartosAmenitys`,quartosAmenitys)
console.log(`quartosLimpar`,quartosLimpar)

  const newCount = quartosLimpar + selectedRooms.size;

  const box = document.getElementById("roomSelectCounter");
  box.innerText = `${selectedOperatorName}â€“Quartos(${newCount})Amenity(${quartosAmenitys.length})`;
}


function openAssignStatusModal() {
  const old = document.getElementById("assignStatusModal");
  if (old) old.remove();

  console.log("dailyList for status:", globalRoomDailyList);

  const modal = document.createElement("div");
  modal.id = "assignStatusModal";
  modal.className = "assign-status-modal";

  // ============================================
  // ğŸ”¥ globalRoomDailyList ã‹ã‚‰ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åˆ¥ä»¶æ•°ã‚’ä½œã‚‹
  // ============================================
  const map = {}; // { staffId: count }

  globalRoomDailyList.forEach(room => {
    if (!room.assigned_staff_id) return;

    const staffId = String(room.assigned_staff_id);

    if (!map[staffId]) {
      map[staffId] = 0;
    }
    map[staffId] += 1;
  });

  // ============================================
  // ğŸ”¥ HTML ç”Ÿæˆ
  // ============================================
  let html = "";

  Object.keys(map).forEach(staffId => {
    const worker = globalWorkerList.find(w => w.id == staffId);
    const name = worker ? worker.name : "Desconhecido";
    const count = map[staffId];

    html += `
      <div class="status-row">
        <span class="status-name">${name}</span>
        <span class="status-count">${count} quartos</span>
      </div>
    `;
  });

  if (html === "") {
    html = `<div class="empty-status">Nenhum registro encontrado.</div>`;
  }

  // ============================================
  // ğŸ”¥ ãƒ¢ãƒ¼ãƒ€ãƒ«æ§‹ç¯‰
  // ============================================
  modal.innerHTML = `
    <div class="assign-status-box">
      <div class="assign-status-header">
        SituaÃ§Ã£o de Registro
        <span class="assign-status-close" onclick="closeAssignStatusModal()">âœ•</span>
      </div>
      <div class="assign-status-body">
        ${html}
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}


function closeAssignStatusModal() {
  const modal = document.getElementById("assignStatusModal");
  if (modal) modal.remove();
}


async function onServiceDateChange() {
  console.log("ğŸ“… æ—¥ä»˜å¤‰æ›´ â†’ å†å–å¾—é–‹å§‹");

  // å³ä¸Šã®é¸æŠã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ resetï¼ˆä»»æ„ï¼‰
  selectedRooms = new Set();
  selectedOperatorName = "--";
  currentAssignedCount = [];
  updateRoomSelectCounter();

  // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼é¸æŠã‚‚åˆæœŸåŒ–ï¼ˆä»»æ„ï¼‰
  document.getElementById("bulkWorker").value = "";

  // ãƒ‡ãƒ¼ã‚¿å†å–å¾—ï¼ˆé‡è¦ï¼‰
  await loadBulkRoomList();

  // ç”»é¢æ›´æ–°
  showToast("Lista atualizada!");
}

//åˆæœŸæ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
document.addEventListener("DOMContentLoaded", () => {
  const now = new Date();
  now.setHours(now.getHours() + 9);  // JSTã«è£œæ­£

  const todayJST = now.toISOString().split("T")[0];
  document.getElementById("dailyDate").value = todayJST;

  loadDashboard();
});


function openServiceList(){
  const dashEl = document.getElementById('dashboard');
  const tabelaEl = document.getElementById('tabela-div');
  const dataEl = document.getElementById('data-selector');
  const floorEl = document.getElementById('floorButtons');
  // const overlay = document.getElementById('tabela-overlay');

  dashEl.style.display = 'none';
  tabelaEl.style.display = 'flex';
  dataEl.style.display = 'none';
  floorEl.style.display = 'none';

  //ğŸ”¥ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
  // overlay.style.display = 'block';

  closeMenu();
  createServices();
}


function openDashboard(){
  const dashEl = document.getElementById('dashboard')
  const tabelaEl = document.getElementById('tabela-div')
  const dataEl = document.getElementById('data-selector')
  const floorEl = document.getElementById('floorButtons')
  dashEl.style.display='grid'
  tabelaEl.style.display='none'
  dataEl.style.display='flex'
  floorEl.style.display='flex'
closeMenu();
}



async function createServices() {
  // console.log(globalRoomDailyList);

  // ğŸ”¥å‰å›é¸ã‚“ã å€¤ã‚’ä¿æŒ
const prevFloor = document.getElementById("filterFloor")?.value || "";
const prevStatus = document.getElementById("filterStatus")?.value || "";


  const container = document.getElementById("tabela-div");
  container.innerHTML = "";

  // ğŸ”¥ ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã‚‰ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  if (!globalRoomDailyList || globalRoomDailyList.length === 0) {
    container.innerHTML = `
      <div class="no-data-box">
        <i class="fas fa-info-circle"></i>
        <p>Lista nÃ£o criada</p>
      </div>
    `;
    return;
  }
  // <button id="desfazerBtn">desfazer</button>
  // ============================
  // ğŸ”¥ ä¸Šéƒ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIï¼ˆãƒ•ãƒ­ã‚¢ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
  // ============================
  const floors = [...new Set(globalRoomDailyList.map(r => r.floor))].sort((a,b)=>a-b);

  container.innerHTML += `
    <div class="filter-container">

      <!-- Floor -->
      <select id="filterFloor" class="filter-select">
        <option value="" ${prevFloor === "" ? "selected" : ""}>Todos andares</option>
        ${floors.map(f =>
          `<option value="${f}" ${prevFloor == f ? "selected" : ""}>${f}F</option>`
        ).join("")}
      </select>



      <!-- Status -->
      <select id="filterStatus" class="filter-select" style="display:none">
        <option value="" ${prevStatus === "" ? "selected" : ""}>Todos status</option>
        <option value="abrir" ${prevStatus === "abrir" ? "selected" : ""}>Abrir</option>
        <option value="aberto" ${prevStatus === "aberto" ? "selected" : ""}>Aberto</option>
        <option value="limpo" ${prevStatus === "limpo" ? "selected" : ""}>Limpo</option>
        <option value="verificado" ${prevStatus === "verificado" ? "selected" : ""}>Verificado</option>
        <option value="nao_aberto" ${prevStatus === "nao_aberto" ? "selected" : ""}>NÃ£o aberto</option>
      </select>

    </div>
  `;


  // ============================
  // ğŸ”¥ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å€¤å–å¾—
  // ============================
  const floorValue = document.getElementById("filterFloor").value;
  const statusValue = document.getElementById("filterStatus").value;

  // ============================
  // ğŸ”¥ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
  // ============================
  let filteredRooms = globalRoomDailyList;

  console.log(floorValue)

  if (floorValue) {
    filteredRooms = filteredRooms.filter(r => r.floor-0 == floorValue-0);
  }
  if (statusValue) {
    filteredRooms = filteredRooms.filter(r => {

      let currentStatus = "nao_aberto";
      if (r.checked_flag === 1) currentStatus = "verificado";
      else if (r.cleaning_done_at !== null) currentStatus = "limpo";
      else if (r.open_flag === 1) currentStatus = "aberto";

      return currentStatus === statusValue;
    });
  }

  // ============================
  // ğŸ”¥ ä¸€è¦§ã‚«ãƒ¼ãƒ‰æç”»
  // ============================

  filteredRooms.sort((a, b) => (a.room_number - 0) - (b.room_number - 0));

  filteredRooms.forEach(r => {
    // console.log(r)

    const card = document.createElement("div");
    card.className = "task-card";

    // ========== ã“ã“ã‹ã‚‰å…ƒã®å‡¦ç†ãã®ã¾ã¾ ==========

    let bgColor = "#a0a7aa";
    let textColor = "#333";
    let iconHTML = "";
    let textHTML = ""
    // let observBadgeHTML = "";
    // let amenityRoom = r.sub_status === 'stay_amenytyOnliy' ? true : false

    // console.log(r.room_number)

    //
    // if (r.sub_status === 'stay_amenytyOnliy') {
    //   bgColor = "#ffdfc2";
    //   iconHTML = `<img src="./img/bag.png" class="icon-img">`;
    // } else if (r.checkout_status === 'before' || r.checkout_status ==='null') {
    //   bgColor = "#cfcfcf";
    //   textColor = "#888";
    // }
    //
    // if (r.stay_type === 'individual') {
    //   iconHTML += `<img src="./img/esponja.png" class="icon-img">`;
    // }
    //
    // let statusValue = "nao_aberto";
    // if (r.checked_flag === 1) statusValue = "ConcluÃ­dos";
    // else if (r.cleaning_done_at !== null) statusValue = "limpo";
    // else if (r.open_flag === 1) statusValue = "aberto";
    //
    // let statusAmenyty = 'before'
    // if(r.amenity_complete_flag === 1){
    //   statusAmenyty = 'done'
    // }
    //

    //
    // const checkOuFlag = (r.checkout_status === 'after');
    //
    //
    // if (!seisouFlag) {
    //   bgColor = '#a0a7aa';
    // }
    //
    //
    //
    // const amenitySiji = globalAmenitys.find(amr=>amr.room_number === r.room_number)


    // console.log(amenitySiji)
    //
    // if(r.notes){
    //   observBadgeHTML = `
    //     <span class="task-badge" data-room="${r.room_number}">
    //       ${r.notes}
    //     </span>
    //   `;
    // }
    //
    // if(amenitySiji!==undefined){
    //       const henkyakusaki = amenitySiji.action_type === 'å›å' ? `è¿”å´å…ˆ:${amenitySiji.return_to}` : ''
    //   observBadgeHTML = `
    //     <span class="task-badge" data-room="${r.room_number}">
    //       ${amenitySiji.amenity}ã‚’${amenitySiji.action_type} ${henkyakusaki}
    //     </span>
    //   `;
    // }

    const amenityRoom = r.sub_status === 'stay_amenytyOnliy' ? true : false //ã“ã“ã§ã‚¹ãƒ†ãƒ¼ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã®ã¿ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‹
    // const disabledAttr = checkOuFlag || r.amenity_only ===1 ? "" : "disabled";

    const seisouFlag =
      !['stay_amenytyOnliy', 'noclean', 'stay_noclean','outOf','unused'].includes(r.sub_status ?? '');

      if(!seisouFlag){
          card.classList.add(`no-plan-card`);
      }

    if (r.stay_type === 'individual') {
      iconHTML += `<img src="./img/esponja.png" class="icon-img">`;
    }

    let observBadgeHTML = "";
    if (r.notes) {
      observBadgeHTML = `
        <span class="task-badge" data-room="${r.room_number}">
          ${r.notes}
        </span>
      `;
    }

    const getAmentys = globalAmenitys.filter(rm=> rm.room_number===r.room_number)
        let selectHTML = "";

    if(getAmentys.length>0){
      getAmentys.forEach(a => {
        // console.log(a)
        const msg = a.action_type==='å›å'?`è¿”å´å…ˆ:${a.return_to}`:''
        const finalMsg = `${a.amenity}ã‚’${a.action_type} ${msg}`
        observBadgeHTML += `
          <span class="task-badge" data-room="${r.room_number}">
            ${finalMsg}
          </span>
        `;

      })
    }

    if (amenityRoom) {
      iconHTML = `<img src="./img/bag.png" class="icon-img">`;

    }

    // card.style.backgroundColor = bgColor;
    // card.style.color = textColor;

    console.log(r)

    let open = false
    let showStart = false
    let showDone=false
    let amenityDone = false
    let limpostart = false

    const nextCheck = r.checked_flag===0 && r.cleaned_by!==null? true:false
    const nextSeisou = r.open_flag===1 && r.cleaned_by===null? true:false
    const nextOpen = r.open_flag===0?true:false
    const nextAmenityCheck = r.sub_status==='stay_amenytyOnliy'?true:false

    const amenityClass =
  r.sub_status === 'stay_amenytyOnliy' ||
  r.sub_status === 'stay_clean';


    if(r.checked_flag===1||r.amenity_complete_flag===1){//å®Œäº†å½¢ã ã‹ã‚‰ã€ãƒ†ã‚­ã‚¹ãƒˆã®ã¿
        textHTML = `
        <div style="width:100%;text-align:right">
          <span style="
            background-color:#1fa93b;
            color:white;
            padding:6px 10px;
            border-radius:6px;
            font-weight:bold;
          ">
            concluÃ­do
          </span>
        </div>

        `;

        card.classList.add(`concluido-card`)
        if(r.checked_flag===1){
          card.classList.add(`concluido-card-isnoAmenity`)
        }
    }else{
      if(r.sub_status === 'stay_amenytyOnliy'){
      console.log('amnytyOnly ni haiteru')
        selectHTML = `
          <div class="task-select-area">
            <select class="task-status-select" data-roomNumber="${r.room_number}" data-room="${r.id}" >

              <option value="done" >Feito</option>
              <option value="before" selected>NÃ£o Feito</option>
            </select>
          </div>
        `
      }

      if (seisouFlag) {
          selectHTML = `
            <div class="task-select-area">
              <select class="task-status-select" data-roomNumber="${r.room_number}" data-room="${r.id}" >
                <option value="aberto" ${nextSeisou ? "selected" : ""}>Aberto</option>
                <option value="limpo" ${nextCheck ? "selected" : ""}>Limpo</option>
                <option value="verificado" >Verificado</option>
                <option value="nao_aberto" ${nextOpen ? "selected" : ""}>NÃ£o aberto</option>
              </select>
            </div>
          `;

          if (nextCheck && !nextAmenityCheck) {
            card.classList.add(`limpo-card`);
          }

          if (nextAmenityCheck) {
            card.classList.add(`limpo-card`)
          }

          if (nextOpen && !nextAmenityCheck) {
            card.classList.add(`open-card`)
          }
          if(nextSeisou&& !nextAmenityCheck){
            card.classList.add(`antesDeLimpar-card`)
          }
        }


    }


    card.innerHTML = `
      <div class="task-room-header">
        <span class="room-number">${r.room_number}</span>
        <div class="icon-area">${iconHTML}</div>
      </div>
      ${observBadgeHTML}
      ${selectHTML}
        ${textHTML}
    `;




if(amenityRoom||amenityClass){
  card.classList.add(`amenityOnlyRoom`);
}

    card.setAttribute("data-room", r.id);



    container.appendChild(card);
  });

  // ============================
  // ğŸ”¥ ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´ã§å†æç”»
  // ============================
  document.getElementById("filterFloor").onchange = createServices;
  document.getElementById("filterStatus").onchange = createServices;

  document.querySelectorAll(".task-status-select").forEach(sel => {
    sel.addEventListener("change", (e) => {
      const roomId = e.target.dataset.room;
      const newStatus = e.target.value;
      const roomNumber = e.target.dataset.roomnumber;

      console.log("ğŸ”¥ status changed:", roomId, newStatus, roomNumber);

      // ğŸ”¥ å¯¾å¿œã‚«ãƒ¼ãƒ‰ã‚’å–å¾—
      const card = document.querySelector(`.task-card[data-room="${roomId}"]`);

      if (card) {
        console.log(card)
        // ğŸ”¥ ä»Šã¾ã§ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å…¨éƒ¨æ¶ˆã™
        card.classList.remove("open-card", "concluido-card", "antesDeLimpar-card", "limpo-card", "done", "before",'limpo','aberto','nao_aberto');

        console.log(`newStatus`,newStatus)

        if (newStatus==='nao_aberto') {
          card.classList.add(`open-card`)
        }

        if (newStatus === 'verificado') {

          // â‘  ã‚»ãƒ¬ã‚¯ãƒˆå‰Šé™¤
          const selectArea = card.querySelector(".task-select-area");
          if (selectArea) {
            selectArea.remove();
          }

          // â‘¡ ã‚¯ãƒ©ã‚¹è¿½åŠ 
          card.classList.add("concluido-card");
          card.classList.add("concluido-card-isnoAmenity");

          // â‘¢ ç·‘ã®ãƒãƒƒã‚¸è¿½åŠ 
          const doneHTML = `
            <div style="width:100%;text-align:right">
              <span style="
                background-color:#1fa93b;
                color:white;
                padding:6px 10px;
                border-radius:6px;
                font-weight:bold;
              ">
                concluÃ­do
              </span>
            </div>
          `;

          // â‘£ æŒ¿å…¥ï¼ˆæœ«å°¾ã«è¿½åŠ ï¼‰
          card.insertAdjacentHTML("beforeend", doneHTML);
        }

       if(newStatus==='limpo'){
         card.classList.add(`limpo-card`)
       }

        if(newStatus==='aberto'){
          card.classList.add(`antesDeLimpar-card`)
        }

        // ğŸ”¥ æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ 
        card.classList.add(newStatus);
      }

      handleStatusChange(roomId, newStatus, roomNumber);
    });

  });


}


// async function createServices() {
//   console.log(globalRoomDailyList);
//
//   const container = document.getElementById("tabela-div");
// container.innerHTML = "";
//
// // ğŸ”¥ ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã‚‰ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
// if (!globalRoomDailyList || globalRoomDailyList.length === 0) {
//   container.innerHTML = `
//     <div class="no-data-box">
//       <i class="fas fa-info-circle"></i>
//         <p>Lista nÃ£o criada</p>
//     </div>
//   `;
//   return;
// }
//
//   globalRoomDailyList.sort((a, b) => (a.room_number-0) - (b.room_number-0));
//
//   globalRoomDailyList.forEach(r => {
//     const card = document.createElement("div");
//     card.className = "task-card";
//     console.log(r)
//
//     let bgColor = "#e0e0e0";
//     let textColor = "#333";
//     let iconHTML = "";
//     let observBadgeHTML = "";
//
//     // --- ã‚¢ã‚¤ã‚³ãƒ³ã¨èƒŒæ™¯è‰² ---
//     if (r.sub_status === 'stay_amenytyOnliy') {
//       bgColor = "#ffdfc2";
//       iconHTML = `<img src="./img/bag.png" class="icon-img">`;
//     } else if (r.checkout_time === null) {
//       bgColor = "#cfcfcf";
//       textColor = "#888";
//     }
//
//     if (r.stay_type === 'individual') {
//       iconHTML += `<img src="./img/esponja.png" class="icon-img">`;
//     }
//
//
//
//     // --- åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š ---
//     let statusValue = "nao_aberto"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
//
//     if (r.checked_flag === 1) {
//       statusValue = "verificado";
//     } else if (r.cleaning_done_at !== null) {
//       statusValue = "limpo";
//     } else if (r.open_flag === 1) {
//       statusValue = "aberto";
//     }
//
//     const seisouFlag =
//       r.status === 'æœªæ¸…æƒ' ||
//       !['stay_amenytyOnliy', 'noclean', 'stay_noclean','outOf'].includes(r.sub_status ?? '');
//
//       const checkOuFlag = (r.checked_flag === 1) || (r.checkout_time !== null);
//       const disabledAttr = checkOuFlag ? "" : "disabled";
//
//
//
//     if(!seisouFlag){
//       bgColor = '#a0a7aa'
//     }
//
//     card.style.backgroundColor = bgColor;
//     card.style.color = textColor;
//
//     let selectHTML = "";
//     if (seisouFlag) {
//       selectHTML = `
//         <div class="task-select-area">
//           <select class="task-status-select" data-room="${r.id}" ${disabledAttr}>
//             <option value="abrir" ${statusValue === "abrir" ? "selected" : ""}>Abrir</option>
//             <option value="aberto" ${statusValue === "aberto" ? "selected" : ""}>Aberto</option>
//             <option value="limpo" ${statusValue === "limpo" ? "selected" : ""}>Limpo</option>
//             <option value="verificado" ${statusValue === "verificado" ? "selected" : ""}>Verificado</option>
//             <option value="nao_aberto" ${statusValue === "nao_aberto" ? "selected" : ""}>NÃ£o aberto</option>
//           </select>
//         </div>
//       `;
//     }
//
//     // --- ã‚«ãƒ¼ãƒ‰ HTML ---
//     card.innerHTML = `
//       <div class="task-room-header">
//         <span class="room-number">${r.room_number}</span>
//         ${observBadgeHTML}
//         <div class="icon-area">${iconHTML}</div>
//       </div>
//
//       ${selectHTML}
//     `;
//
//     container.appendChild(card);
//   });
// }






async function handleStatusChange(roomId, newStatus,roomNumber) {
  console.log("ğŸ“Œ handleStatusChange", roomId, newStatus,roomNumber);

  // ãƒãƒƒãƒ•ã‚¡ãªã©ã‚ãªãŸã®æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯
  // checkoutBuffer[roomId] = newStatus;

  // é€ä¿¡ãƒ‡ãƒ¼ã‚¿æº–å‚™
  const payload = {
    id: roomId,
    status: newStatus,
    user_id: operatorId,   // â† cleaning/checked ç”¨ï¼ˆå¿…è¦ãªã‚‰ï¼‰
    roomNumber:roomNumber,
    hotelId:globalId
  };

  // APIé€ä¿¡
  const res = await fetch(`${API_URL}/api/room/update_status`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  const data = await res.json();
  console.log("ğŸ”¥ update response:", data);

  // UIå†æç”»ã—ãŸã„å ´åˆ
  // createServices();
}

// document.getElementById("desfazerBtn").addEventListener("click", () => {
//   openUndoModal();
// });
function openUndoModal() {
  const modal = document.getElementById("undoModal");
  const list = document.getElementById("undoRoomList");

  list.innerHTML = "";

  // console.log("ğŸ“Œ beforeCleanning:", beforeCleanning);

  beforeCleanning.forEach(room => {
    // console.log(room)
    if(room.checked_flag){
      return
    }
    const div = document.createElement("div");
    div.className = "undo-room-card";
    div.dataset.id = room.id;

    div.innerHTML = `
      <span>Quarto ${room.room_number}</span>
      <input type="checkbox" class="undo-check" />
    `;

    list.appendChild(div);
  });

  modal.classList.remove("hidden");
}


renderFloorButtons();




// loadDashboard().then(async () => {
//   // ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã« ALL ã§åˆæœŸé›†è¨ˆ
//
//
//   // hideLoading()
// });

</script>

</body>
</html>
